---
title: "Lecture 4: Joint model (Cox model + linear mixed model)"
toc: true
toc-depth: 3
---


```{r, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
```

## Learning Objectives

::: callout-note
By the end of this lecture, you should be able to:

- Understand **why joint models are needed** when time-dependent covariates are **internal**  
- Distinguish between **extended Cox models** and **joint models**  
- Describe the two components of a **joint model**:  
  - a **longitudinal submodel** (e.g. eGFR over time)
  - a **time-to-event submodel** (e.g. graft failure)
- Explain how the **longitudinal process is linked to the survival process**  
- Interpret key parameters from a **joint model**
- Recognise situations where joint models provide **less biased and more realistic inference**

:::


## Why Do We Need Joint Models?

In the **extended Cox model**, we allowed covariates to change over time.
However, this approach relies on a key assumption:

- The time-varying covariate is **external**
- Its evolution is **not influenced by the underlying event process**

This assumption is often unrealistic in medical and public health studies.

::: callout-note
### The Problem of Internal Time-Dependent Covariates

A **time-dependent covariate is internal** if:

- It is affected by the same disease process that leads to the event
- It both **predicts** the event and is **influenced by** the event process

A common example in transplantation studies is **eGFR**:

- Declining eGFR increases the risk of graft failure
- At the same time, eGFR declines **because the graft is failing**
:::


::: {.callout-warning}
When a time-dependent covariate is internal,  
the extended Cox model may produce **biased estimates**.
:::

---

## Why the Extended Cox Model Is Not Enough

In the extended Cox model:

- The longitudinal process (e.g. eGFR) is treated as **error-free**
- Measurement error in repeated biomarker values is ignored
- The feedback between the biomarker and the event is not modelled

As a result:

- The estimated effect of the biomarker may be biased
- Standard errors may be underestimated
- Interpretation can be misleading

ü´ò **Graft function declines**  
‚¨áÔ∏è  
üß™ **More clinical tests**  
‚¨áÔ∏è  
üß´ **Lower eGFR measurements**  
‚¨áÔ∏è  
‚ö†Ô∏è **Patient appears riskier**  
‚¨áÔ∏è  
üìà **Effect is exaggerated**



---

## Enter Joint Models

**Joint models** address these limitations by:

- Modelling the **longitudinal trajectory** (e.g. eGFR over time)
- Modelling the **time-to-event outcome** (e.g. graft failure)
- Explicitly **linking the two processes**

This allows us to:

- Account for **measurement error** in the biomarker
- Handle **internal time-dependent covariates**
- Obtain more realistic estimates of risk

##  Visual demonestraion of longitudinal process (eGFR) and survival process (time to graft lost)

**longitudinal process**

The following plot shows eGFR trajectories for a subset of patients.

```{r, warning=FALSE}

library(ggplot2)
library(dplyr)
library(gridExtra)


dat_long<-read.csv("egfr_joint_data.CSV")
# sample 25 patients for visual clarity
set.seed(20251113)
ids_sample <- sample(unique(dat_long$id), 25)

p_traj <- dat_long %>%
  filter(id %in% ids_sample) %>%
  ggplot(aes(x = time, y = egfr, group = id, colour = factor(id))) +
  geom_line(size = 1.2, alpha = 0.85) +
  geom_point(size = 2.2, alpha = 0.9) +
  scale_colour_discrete(guide = "none") +  
  labs(
    x = "Time since transplant (years)",
    y = "eGFR (mL/min/1.73m¬≤)",
    title = "Individual eGFR Trajectories After Kidney Transplantation (only for 25 ids)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 10),
    axis.title = element_text(face = "bold")
  )




p_traj_by_donor <- dat_long %>%
  group_by(donor_type, time) %>%
  summarise(mean_egfr = mean(egfr), .groups = "drop") %>%
  ggplot(aes(x = time, y = mean_egfr,
             colour = factor(donor_type),
             group = donor_type)) +
  geom_line(size = 1.8) +
  geom_point(size = 3) +
  scale_colour_manual(
    values = c("0" = "#0072B2",    # deceased = blue
               "1" = "#D55E00"),   # living = red
    labels = c("0" = "Deceased donor",
               "1" = "Living donor")
  ) +
  labs(
    x = "Time since transplant (years)",
    y = "Mean eGFR",
    colour = "Donor type",
    title = "Mean eGFR Trajectory by Donor Type"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 12),
    axis.title = element_text(face = "bold")
  )




# Arrange side by side
grid.arrange(
  p_traj,
  p_traj_by_donor,
  ncol = 2
)


```










::: {.callout-note}
Joint models provide a unified framework for analysing  
**longitudinal measurements** and **time-to-event outcomes** together.
:::
