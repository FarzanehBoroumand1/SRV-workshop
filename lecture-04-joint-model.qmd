---
title: "Lecture 4: Joint model (Cox model + linear mixed model)"
toc: true
toc-depth: 3
---


```{r, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
```

## Learning Objectives

::: callout-note
By the end of this lecture, you should be able to:

- Understand **why joint models are needed** when time-dependent covariates are **internal**  
- Distinguish between **extended Cox models** and **joint models**  
- Describe the two components of a **joint model**:  
  - a **longitudinal submodel** (e.g. eGFR over time)
  - a **time-to-event submodel** (e.g. graft failure)
- Explain how the **longitudinal process is linked to the survival process**  
- Interpret key parameters from a **joint model**
- Recognise situations where joint models provide **less biased and more realistic inference**

:::


## Why Do We Need Joint Models?

In the **extended Cox model**, we allowed covariates to change over time.
However, this approach relies on a key assumption:

- The time-varying covariate is **external**
- Its evolution is **not influenced by the underlying event process**

This assumption is often unrealistic in medical and public health studies.

::: callout-note
### The Problem of Internal Time-Dependent Covariates

A **time-dependent covariate is internal** if:

- It is affected by the same disease process that leads to the event
- It both **predicts** the event and is **influenced by** the event process

A common example in transplantation studies is **eGFR**:

- Declining eGFR increases the risk of graft failure
- At the same time, eGFR declines **because the graft is failing**
:::


::: {.callout-warning}
When a time-dependent covariate is internal,  
the extended Cox model may produce **biased estimates**.
:::

---

## Why the Extended Cox Model Is Not Enough

In the extended Cox model:

- The longitudinal process (e.g. eGFR) is treated as **error-free**
- Measurement error in repeated biomarker values is ignored
- The feedback between the biomarker and the event is not modelled

As a result:

- The estimated effect of the biomarker may be biased
- Standard errors may be underestimated
- Interpretation can be misleading

ü´ò **Graft function declines**  
‚¨áÔ∏è  
üß™ **More clinical tests**  
‚¨áÔ∏è  
üß´ **Lower eGFR measurements**  
‚¨áÔ∏è  
‚ö†Ô∏è **Patient appears riskier**  
‚¨áÔ∏è  
üìà **Effect is exaggerated**



---

## Joint Models

**Joint models** address these limitations by:

- Modelling the **longitudinal trajectory** (e.g. eGFR over time)
- Modelling the **time-to-event outcome** (e.g. graft failure)
- Explicitly **linking the two processes**

This allows us to:

- Account for **measurement error** in the biomarker
- Handle **internal time-dependent covariates**
- Obtain more realistic estimates of risk

##  Visual demonestraion of longitudinal process (eGFR) and survival process (time to graft lost)

**Figure 1: Individual and average eGFR trajectories after kidney transplantation**

The left panel shows **individual longitudinal eGFR trajectories** for a subset of transplant recipients, illustrating substantial **between-patient heterogeneity** in both baseline kidney function and the rate of decline over time. Some patients experience relatively stable eGFR, while others show rapid deterioration, highlighting that kidney function evolves differently across individuals.

The right panel displays the **average eGFR trajectory by donor type**. On average, recipients of **living-donor kidneys** start with higher eGFR and maintain better kidney function over follow-up compared with recipients of **deceased-donor kidneys**. However, both groups show a general **declining trend over time**.



```{r, warning=FALSE}

library(ggplot2)
library(dplyr)
library(gridExtra)


dat_long<-read.csv("egfr_joint_data.CSV")
# sample 25 patients for visual clarity
set.seed(20251113)
ids_sample <- sample(unique(dat_long$id), 25)

p_traj <- dat_long %>%
  filter(id %in% ids_sample) %>%
  ggplot(aes(x = time, y = egfr, group = id, colour = factor(id))) +
  geom_line(size = 1.2, alpha = 0.85) +
  geom_point(size = 2.2, alpha = 0.9) +
  scale_colour_discrete(guide = "none") +  
  labs(
    x = "Time since transplant (years)",
    y = "eGFR (mL/min/1.73m¬≤)",
    title = "Individual eGFR Trajectories After Kidney Transplantation (only for 25 ids)"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(face = "bold", size = 8),
    axis.title = element_text(face = "bold")
  )




p_traj_by_donor <- dat_long %>%
  group_by(donor_type, time) %>%
  summarise(mean_egfr = mean(egfr), .groups = "drop") %>%
  ggplot(aes(x = time, y = mean_egfr,
             colour = factor(donor_type),
             group = donor_type)) +
  geom_line(size = 1.8) +
  geom_point(size = 3) +
  scale_colour_manual(
    values = c("0" = "#0072B2",    # deceased = blue
               "1" = "#D55E00"),   # living = red
    labels = c("0" = "Deceased donor",
               "1" = "Living donor")
  ) +
  labs(
    x = "Time since transplant (years)",
    y = "Mean eGFR",
    colour = "Donor type",
    title = "Mean eGFR Trajectory by Donor Type"
  ) +
  theme_minimal(base_size = 8) +
  theme(
    plot.title = element_text(face = "bold", size = 8),
    axis.title = element_text(face = "bold")
  )




# Arrange side by side
grid.arrange(
  p_traj,
  p_traj_by_donor,
  ncol = 2
)


```


**Figure 2: KM curve of overal survival of graft and by donor type**


```{r, warning=FALSE}
library(survival)
library(broom)

dat_baseline<-read.csv("egfr_wide_data.CSV")


# overall KM
surv_obj <- Surv(time = dat_baseline$time, event = dat_baseline$status)

fit_km <- survfit(surv_obj ~ 1)

km_df <- data.frame(
  time  = fit_km$time,
  surv  = fit_km$surv,
  lower = fit_km$lower,
  upper = fit_km$upper
)

KM1<-ggplot(km_df, aes(x = time, y = surv)) +
  geom_step(linewidth = 1.2, colour = "#365abd") +
  geom_ribbon(aes(ymin = lower, ymax = upper),
              alpha = 0.2,
              fill = "#365abd") +
  labs(
    title = "Kaplan‚ÄìMeier Curve for Time to Graft Failure",
    x = "Time since transplant (years)",
    y = "Graft survival probability"
  ) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_grey(base_size = 8) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.minor = element_blank()
  )



#KM curve by donor type
fit_km_donor <- survfit(Surv(time, status) ~ donor_type, data = dat_baseline)

km_df <- tidy(fit_km_donor)

p_km <- km_df %>%
  mutate(
    donor_type = factor(strata,
                        labels = c("Deceased donor", "Living donor"))
  ) %>%
  ggplot(aes(x = time, y = estimate,
             colour = donor_type, fill = donor_type)) +
  geom_step(size = 1.6) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high),
              alpha = 0.20, colour = NA) +
  scale_colour_manual(
    values = c("Deceased donor" = "#0072B2",
               "Living donor"   = "#D55E00")
  ) +
  scale_fill_manual(
    values = c("Deceased donor" = "#0072B2",
               "Living donor"   = "#D55E00")
  ) +
  labs(
    x = "Time since transplant (years)",
    y = "Graft survival probability",
    colour = "Donor type",
    fill = "Donor type",
    title = "Kaplan‚ÄìMeier Curves by Donor Type"
  ) +
  theme_minimal(base_size = 8) +
  theme(
    plot.title = element_text(face = "bold", size = 8),
    axis.title = element_text(face = "bold")
  )





# Arrange side by side
grid.arrange(
  KM1,
  p_km,
  ncol = 2
)

```



Importantly, these plots illustrate that **eGFR is a time-varying, patient-specific process** that is closely linked to graft failure risk. Treating eGFR as a fixed baseline covariate or updating it naively in an extended Cox model may be inappropriate, as changes in eGFR can be driven by the underlying disease process itself. This motivates the use of **joint models**, which explicitly model the longitudinal eGFR process together with the time-to-event outcome.






::: {.callout-note}
Joint models provide a unified framework for analysing  
**longitudinal measurements** and **time-to-event outcomes** together.
:::
