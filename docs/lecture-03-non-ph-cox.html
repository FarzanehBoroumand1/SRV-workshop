<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lecture 3: Cox model when PH assumption is violated ‚Äì Advanced Survival Concepts and Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./lecture-01-intro-km-rmst.html">Lectures</a></li><li class="breadcrumb-item"><a href="./lecture-03-non-ph-cox.html">Lecture 3: Cox model when PH assumption is violated</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Advanced Survival Concepts and Analysis</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Lectures</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lecture-01-intro-km-rmst.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 1: Introduction, Kaplan‚ÄìMeier and RMST</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lecture-02-cox-ph.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 2: Cox proportional hazards model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lecture-03-non-ph-cox.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lecture 3: Cox model when PH assumption is violated</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives"><span class="header-section-number">1</span> Learning Objectives</a></li>
  <li><a href="#reminder-proportional-hazards-assumption" id="toc-reminder-proportional-hazards-assumption" class="nav-link" data-scroll-target="#reminder-proportional-hazards-assumption"><span class="header-section-number">2</span> Reminder: Proportional Hazards Assumption</a></li>
  <li><a href="#what-if-proportional-hazards-does-not-hold" id="toc-what-if-proportional-hazards-does-not-hold" class="nav-link" data-scroll-target="#what-if-proportional-hazards-does-not-hold"><span class="header-section-number">3</span> What If Proportional Hazards Does Not Hold?</a></li>
  <li><a href="#stratified-cox-model" id="toc-stratified-cox-model" class="nav-link" data-scroll-target="#stratified-cox-model"><span class="header-section-number">4</span> Stratified Cox model</a></li>
  <li><a href="#example-handling-non-proportional-hazards-using-stratified-cox-model" id="toc-example-handling-non-proportional-hazards-using-stratified-cox-model" class="nav-link" data-scroll-target="#example-handling-non-proportional-hazards-using-stratified-cox-model"><span class="header-section-number">5</span> Example: Handling Non-Proportional Hazards Using Stratified Cox Model</a></li>
  <li><a href="#including-time-varying-effects" id="toc-including-time-varying-effects" class="nav-link" data-scroll-target="#including-time-varying-effects"><span class="header-section-number">6</span> Including Time-Varying Effects</a>
  <ul class="collapse">
  <li><a href="#when-to-use-time-varying-effects" id="toc-when-to-use-time-varying-effects" class="nav-link" data-scroll-target="#when-to-use-time-varying-effects"><span class="header-section-number">6.1</span> When to Use Time-Varying Effects</a></li>
  <li><a href="#model-idea" id="toc-model-idea" class="nav-link" data-scroll-target="#model-idea"><span class="header-section-number">6.2</span> Model Idea</a></li>
  </ul></li>
  <li><a href="#including-time-varying-effects-1" id="toc-including-time-varying-effects-1" class="nav-link" data-scroll-target="#including-time-varying-effects-1"><span class="header-section-number">7</span> Including Time-Varying Effects</a></li>
  <li><a href="#worked-example-time-varying-effect-of-donor-type" id="toc-worked-example-time-varying-effect-of-donor-type" class="nav-link" data-scroll-target="#worked-example-time-varying-effect-of-donor-type"><span class="header-section-number">8</span> Worked Example: Time-Varying Effect of Donor Type</a>
  <ul class="collapse">
  <li><a href="#step-1-fit-a-cox-model-with-a-time-varying-coefficient" id="toc-step-1-fit-a-cox-model-with-a-time-varying-coefficient" class="nav-link" data-scroll-target="#step-1-fit-a-cox-model-with-a-time-varying-coefficient"><span class="header-section-number">8.1</span> Step 1: Fit a Cox Model With a Time-Varying Coefficient</a></li>
  <li><a href="#visualising-the-time-varying-hazard-ratio" id="toc-visualising-the-time-varying-hazard-ratio" class="nav-link" data-scroll-target="#visualising-the-time-varying-hazard-ratio"><span class="header-section-number">8.3</span> Visualising the Time-Varying Hazard Ratio</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./lecture-01-intro-km-rmst.html">Lectures</a></li><li class="breadcrumb-item"><a href="./lecture-03-non-ph-cox.html">Lecture 3: Cox model when PH assumption is violated</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Lecture 3: Cox model when PH assumption is violated</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">1</span> Learning Objectives</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>By the end of this lecture, you should be able to:</p>
<ul>
<li>Recognise when the <strong>proportional hazards (PH) assumption</strong> is violated</li>
<li>Understand different strategies to handle non-PH:
<ul>
<li>Stratified Cox model</li>
<li>Time-varying effects</li>
<li>Extended Cox with time-varying covariates</li>
</ul></li>
<li>Understand when a <strong>joint model</strong> is needed</li>
</ul>
</div>
</div>
</section>
<section id="reminder-proportional-hazards-assumption" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="reminder-proportional-hazards-assumption"><span class="header-section-number">2</span> Reminder: Proportional Hazards Assumption</h2>
<p>The Cox model assumes that <strong>hazard ratios are constant over time</strong>.</p>
<p>This means that if one group has higher risk than another at the beginning, it has the same <em>relative</em> risk later in follow-up.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If this assumption does not hold, the estimated hazard ratio from a standard Cox model may be misleading.</p>
</div>
</div>
</section>
<section id="what-if-proportional-hazards-does-not-hold" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="what-if-proportional-hazards-does-not-hold"><span class="header-section-number">3</span> What If Proportional Hazards Does Not Hold?</h2>
<p>There are several approaches when PH is violated:</p>
<ol type="1">
<li><strong>Stratified Cox model:</strong> allow baseline hazards to differ by group.</li>
<li><strong>Include time-varying effect:</strong> model changing effects over time, include interaction between covariate and time (e.g.&nbsp;<span class="math inline">\(ùë•√óùë°\)</span>).</li>
<li><strong>Use extended Cox model:</strong> allow a covariate‚Äôs value itself to change over time.</li>
</ol>
</section>
<section id="stratified-cox-model" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="stratified-cox-model"><span class="header-section-number">4</span> Stratified Cox model</h2>
<p>When the proportional hazards (PH) assumption is violated for a categorical variable, one option is a <strong>stratified Cox model</strong>.</p>
<p>A stratified Cox model can be written as:</p>
<p><span class="math display">\[
h_s(t \mid X) = h_{0s}(t)\,\exp(\beta_1 X_1 + \beta_2 X_2 + \cdots)
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(s\)</span> is the stratum (e.g.&nbsp;donor type)</li>
<li><span class="math inline">\(h_{0s}(t)\)</span> is the <strong>baseline hazard for stratum <span class="math inline">\(s\)</span></strong></li>
<li><span class="math inline">\(X_1, X_2, \ldots\)</span> are other covariates</li>
</ul>
<p><strong>What does stratification mean?</strong></p>
<p>If we stratify on a variable (e.g.&nbsp;<strong>donor type</strong>):</p>
<ul>
<li>We <strong>do not estimate a single hazard ratio</strong> for the stratifying variable anymore<br>
(we are not saying ‚Äúliving vs deceased = HR 0.7‚Äù)</li>
<li>The stratifying variable is used only to <strong>define strata</strong></li>
<li>Each stratum is allowed to have a <strong>different baseline risk trajectory</strong> over time</li>
</ul>
<p>In words:</p>
<blockquote class="blockquote">
<p>Patients with living donors and patients with deceased donors are allowed to have completely different baseline hazards over time.</p>
</blockquote>
<p><strong>What is still estimated?</strong></p>
<p>We still estimate the effects of other covariates (e.g.&nbsp;donor age, recipient sex, eGFR at transplant), assuming those effects are <strong>proportional within each stratum</strong>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Stratification is useful when a variable strongly affects baseline risk but does not satisfy the PH assumption.</p>
</div>
</div>
<p>Stratification can be thought of as:</p>
<blockquote class="blockquote">
<p><strong>‚ÄúParallel Cox models with different baseline hazards, but the same slopes for the other covariates.‚Äù</strong></p>
</blockquote>
<p>That is, each group has its own baseline risk over time, but covariate effects are assumed to be the same across groups.</p>
<hr>
<p>‚úÖ <strong>When to use stratification</strong> Use stratification when:</p>
<ul>
<li>The proportional hazards (PH) violation is mainly driven by <strong>one categorical variable</strong> (e.g.&nbsp;donor type)</li>
<li>You still want to <strong>adjust for this variable</strong></li>
<li>But you do <strong>not need its hazard ratio</strong> as a main result</li>
</ul>
<p>In this case, the variable is used to define strata rather than being estimated as a coefficient.</p>
<hr>
<p>‚ùå <strong>When not to use stratification</strong> Do <strong>not</strong> use stratification when:</p>
<ul>
<li>The stratifying variable is your <strong>primary exposure of interest</strong></li>
<li>You need to report a <strong>hazard ratio comparing groups</strong></li>
</ul>
<p>Because once you stratify on a variable (e.g.&nbsp;donor type), you <strong>no longer obtain a single hazard ratio</strong> comparing those groups.</p>
</section>
<section id="example-handling-non-proportional-hazards-using-stratified-cox-model" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="example-handling-non-proportional-hazards-using-stratified-cox-model"><span class="header-section-number">5</span> Example: Handling Non-Proportional Hazards Using Stratified Cox Model</h2>
<p>We are interested in whether time to graft failure after kidney transplantation differs by donor type (living vs deceased), after adjusting for important clinical factors.</p>
<p>We begin by fitting a standard Cox proportional hazards model, then check the PH assumption. If the PH assumption is violated for any categorical covariate in the model, we refit the model using stratification by that covariate.</p>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>stratified_kidney_data<span class="ot">&lt;-</span><span class="fu">read.csv</span>(<span class="st">"stratified_kidney_data.CSV"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>cox_standard <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> donor_type <span class="sc">+</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    donor_age <span class="sc">+</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    recipient_gender <span class="sc">+</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    egfr_baseline,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stratified_kidney_data</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(cox_standard)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">#check the PH assumption first </span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>ph_test <span class="ot">&lt;-</span> <span class="fu">cox.zph</span>(cox_standard)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>ph_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                  chisq df       p
donor_type       28.127  1 1.1e-07
donor_age         0.118  1    0.73
recipient_gender  1.156  1    0.28
egfr_baseline     1.498  1    0.22
GLOBAL           30.955  4 3.1e-06</code></pre>
</div>
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ph_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-2-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-2-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-2-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A small p-value indicates evidence against the proportional hazards assumption.</p>
</div>
</div>
<p><strong>Interpretation of PH diagnostics</strong></p>
<p>The proportional hazards assumption is violated for donor type.<br>
Other covariates do not show strong evidence of violation.<br>
The global test is significant, indicating overall non-proportionality.<br>
This suggests that the effect of donor type on graft failure risk changes over time, making the standard Cox model inappropriate.</p>
<p><strong>Stratified Cox model</strong></p>
<p>To address this violation, we fit a stratified Cox model, stratifying on donor type.</p>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>cox_strat <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Surv</span>(time, status) <span class="sc">~</span> donor_age <span class="sc">+</span> recipient_gender <span class="sc">+</span> egfr_baseline <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">strata</span>(donor_type),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">data =</span> stratified_kidney_data</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_strat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ donor_age + recipient_gender + 
    egfr_baseline + strata(donor_type), data = stratified_kidney_data)

  n= 400, number of events= 171 

                          coef exp(coef)  se(coef)      z Pr(&gt;|z|)   
donor_age             0.011126  1.011188  0.007488  1.486  0.13735   
recipient_gendermale  0.454309  1.575084  0.154436  2.942  0.00326 **
egfr_baseline        -0.014757  0.985351  0.006905 -2.137  0.03258 * 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                     exp(coef) exp(-coef) lower .95 upper .95
donor_age               1.0112     0.9889    0.9965    1.0261
recipient_gendermale    1.5751     0.6349    1.1637    2.1319
egfr_baseline           0.9854     1.0149    0.9721    0.9988

Concordance= 0.574  (se = 0.023 )
Likelihood ratio test= 14.83  on 3 df,   p=0.002
Wald test            = 14.66  on 3 df,   p=0.002
Score (logrank) test = 14.83  on 3 df,   p=0.002</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>We no longer estimate a hazard ratio for donor type.</p></li>
<li><p>Donor type is now used only to define separate baseline hazards.</p></li>
<li><p>Effects of other covariates are assumed proportional within each stratum.</p></li>
</ul>
</div>
</div>
<p>üß† <strong>Interpretation of stratified Cox model</strong></p>
<p>Within each donor type (living and deceased), we interpret covariate effects as follows:</p>
<p>‚úÖ Donor age</p>
<p>HR ‚âà 1.01 (95% CI: 0.997‚Äì1.03, P-value=0.14), Not statistically significant.<br>
Within each donor type, donor age shows no strong association with graft failure.</p>
<p>‚úÖ Recipient gender (male)</p>
<p>HR ‚âà 1.58 (95% CI: 1.16‚Äì2.13, P-value=0.003), Statistically significant. Male recipients have about 58% higher hazard of graft failure compared to females This comparison is within donor type, adjusting for donor age and eGFR.</p>
<p>‚úÖ eGFR at transplant</p>
<p>HR ‚âà 0.99 (95% CI: 0.97‚Äì1.00, P-value=0.033), Statistically significant. Each 1-unit increase in baseline eGFR is associated with about 1‚Äì2% lower hazard of graft failure, within each donor type. To improve interpretability, we can express the effect per <strong>10-unit increase</strong> in eGFR:</p>
<p><span class="math display">\[
HR_{10\text{-unit}} = 0.99^{10} \approx 0.90
\]</span></p>
<p><strong>Interpretation:</strong><br>
Within each donor type, a 10-unit higher eGFR at the time of transplant is associated with approximately a <strong>10% lower hazard of graft failure</strong>, after adjusting for donor age and recipient gender.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What about donor type?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Stratifying by donor type allows each group to have its own baseline hazard curve, effectively removing the need to assume a constant hazard ratio over time.</p>
<p>The curves demonstrate that living and deceased donor grafts follow different survival trajectories ‚Äî exactly what we expect when the PH assumption is violated.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cox_strat is the stratified cox model we fitted in previous chunk </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>sf_strat <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_strat)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert survfit to a tidy data frame for ggplot</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>sf_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">time  =</span> sf_strat<span class="sc">$</span>time,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv  =</span> sf_strat<span class="sc">$</span>surv,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> sf_strat<span class="sc">$</span>lower,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> sf_strat<span class="sc">$</span>upper,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">strata =</span> <span class="fu">rep</span>(<span class="fu">names</span>(sf_strat<span class="sc">$</span>strata), sf_strat<span class="sc">$</span>strata)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up the stratum labels from "donor_type=deceased" ‚Üí "deceased"</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>sf_df<span class="sc">$</span>strata <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"donor_type="</span>, <span class="st">""</span>, sf_df<span class="sc">$</span>strata)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>stratified_cox_plot<span class="ot">&lt;-</span><span class="fu">ggplot</span>(sf_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> surv, <span class="at">colour =</span> strata)) <span class="sc">+</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper, <span class="at">fill =</span> strata),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"deceased"</span> <span class="ot">=</span> <span class="st">"#365abd"</span>,  <span class="co"># deep blue</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"living"</span>   <span class="ot">=</span> <span class="st">"#c0397e"</span>))<span class="sc">+</span> <span class="co"># magenta/rose</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"deceased"</span> <span class="ot">=</span> <span class="st">"#365abd"</span>,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"living"</span>   <span class="ot">=</span> <span class="st">"#c0397e"</span>)) <span class="sc">+</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Stratified Cox Model</span><span class="sc">\n</span><span class="st">Different Baseline Hazards by Donor Type"</span>,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time since transplant (years)"</span>,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted survival probability"</span>,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"Donor type"</span>,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill   =</span> <span class="st">"Donor type"</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title       =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position  =</span> <span class="st">"bottom"</span>,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title     =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>stratified_cox_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Ignoring PH Violations Can Be Misleading
</div>
</div>
<div class="callout-body-container callout-body">
<p>If we ignore the violation of the proportional hazards (PH) assumption and proceed with a standard Cox model, we may obtain a single hazard ratio that does <strong>not accurately reflect how risk changes over time</strong>.</p>
<p>This can lead to misleading conclusions, as the estimated effect represents an average over follow-up rather than the true time-varying relationship.</p>
<p>This is illustrated in the plot below, where the separation between groups is clearly <strong>not constant over time</strong>.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#data preparation for plot </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>new_deceased <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_type =</span> <span class="fu">factor</span>(<span class="st">"deceased"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(stratified_kidney_data<span class="sc">$</span>donor_type))),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_age =</span> <span class="fu">mean</span>(stratified_kidney_data<span class="sc">$</span>donor_age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_gender =</span> <span class="fu">factor</span>(<span class="st">"female"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(stratified_kidney_data<span class="sc">$</span>recipient_gender))),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">egfr_baseline =</span> <span class="fu">mean</span>(stratified_kidney_data<span class="sc">$</span>egfr_baseline, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>new_living <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_type =</span> <span class="fu">factor</span>(<span class="st">"living"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(stratified_kidney_data<span class="sc">$</span>donor_type))),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_age =</span> <span class="fu">mean</span>(stratified_kidney_data<span class="sc">$</span>donor_age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_gender =</span> <span class="fu">factor</span>(<span class="st">"female"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(stratified_kidney_data<span class="sc">$</span>recipient_gender))),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">egfr_baseline =</span> <span class="fu">mean</span>(stratified_kidney_data<span class="sc">$</span>egfr_baseline, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>sf_deceased <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_standard, <span class="at">newdata =</span> new_deceased)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>sf_living   <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_standard, <span class="at">newdata =</span> new_living)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>df_dec <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">time       =</span> sf_deceased<span class="sc">$</span>time,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv       =</span> sf_deceased<span class="sc">$</span>surv,</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower      =</span> sf_deceased<span class="sc">$</span>lower,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper      =</span> sf_deceased<span class="sc">$</span>upper,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_type =</span> <span class="st">"Deceased donor"</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>df_liv <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">time       =</span> sf_living<span class="sc">$</span>time,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv       =</span> sf_living<span class="sc">$</span>surv,</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower      =</span> sf_living<span class="sc">$</span>lower,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper      =</span> sf_living<span class="sc">$</span>upper,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_type =</span> <span class="st">"Living donor"</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>df_ph <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df_dec, df_liv)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>standard_cox_plot<span class="ot">&lt;-</span><span class="fu">ggplot</span>(df_ph, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> surv, <span class="at">colour =</span> donor_type, <span class="at">fill =</span> donor_type)) <span class="sc">+</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CI ribbon</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>,</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>              <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>              <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step survival curve</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Manual colours for consistency across slides</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Deceased donor"</span> <span class="ot">=</span> <span class="st">"#365abd"</span>,   <span class="co"># blue</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Living donor"</span>   <span class="ot">=</span> <span class="st">"#c0397e"</span>)   <span class="co"># magenta/rose</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Deceased donor"</span> <span class="ot">=</span> <span class="st">"#365abd"</span>,</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Living donor"</span>   <span class="ot">=</span> <span class="st">"#c0397e"</span>)</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Axis labels and title</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Standard Cox PH Model</span><span class="sc">\n</span><span class="st">Assumes Constant Effect of Donor Type"</span>,</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time since transplant (years)"</span>,</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted survival probability"</span>,</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"Donor type"</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y-axis from 0.4 to 1.0</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">1.0</span>)) <span class="sc">+</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use grey theme with gridlines</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title       =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position  =</span> <span class="st">"bottom"</span>,</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title     =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Reduce title size for each plot</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>standard_cox_plot_small <span class="ot">&lt;-</span> standard_cox_plot <span class="sc">+</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>stratified_cox_plot_small <span class="ot">&lt;-</span> stratified_cox_plot <span class="sc">+</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrange side by side</span></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>  standard_cox_plot_small,</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>  stratified_cox_plot_small,</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="including-time-varying-effects" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="including-time-varying-effects"><span class="header-section-number">6</span> Including Time-Varying Effects</h2>
<p>When the proportional hazards (PH) assumption is violated, <strong>stratification is not the only solution</strong>.</p>
<p>In some settings, we still want to:</p>
<ul>
<li><strong>Keep the covariate in the model</strong></li>
<li><strong>Obtain an explicit effect estimate</strong></li>
<li><strong>Allow the effect to change over time</strong></li>
</ul>
<p>This leads to a <strong>time-varying coefficient Cox model</strong>.</p>
<section id="when-to-use-time-varying-effects" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="when-to-use-time-varying-effects"><span class="header-section-number">6.1</span> When to Use Time-Varying Effects</h3>
<p>Use a time-varying effect when:</p>
<ul>
<li>The PH assumption is violated for a variable (e.g.&nbsp;<strong>donor type</strong>)</li>
<li>The variable is scientifically important</li>
<li>You believe the <strong>effect itself changes over time</strong></li>
</ul>
<p>For example:</p>
<ul>
<li>Early after transplant, <strong>living donors may be protective</strong></li>
<li>Later, that advantage may <strong>diminish or reverse</strong></li>
</ul>
</section>
<section id="model-idea" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="model-idea"><span class="header-section-number">6.2</span> Model Idea</h3>
</section>
</section>
<section id="including-time-varying-effects-1" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="including-time-varying-effects-1"><span class="header-section-number">7</span> Including Time-Varying Effects</h2>
<p>In the <strong>standard Cox model</strong>:</p>
<p><span class="math display">\[
h(t \mid X) = h_0(t)\exp(\beta_1 X_1 + \beta_2 X_2 + \cdots)
\]</span></p>
<p>the coefficients (<span class="math inline">\(\beta\)</span>) are assumed to be <strong>constant over time</strong>, which leads to the <strong>proportional hazards (PH) assumption</strong>.</p>
<hr>
<p>If a covariate‚Äôs effect <strong>changes over time</strong>, we can allow its coefficient to depend on time:</p>
<p><span class="math display">\[
h(t \mid X) = h_0(t)\exp\left(\beta_1(t) X_1 + \beta_2 X_2 + \cdots\right)
\]</span></p>
<p>This allows the <strong>hazard ratio for <span class="math inline">\(X_1\)</span> to vary with time</strong>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Intuition
</div>
</div>
<div class="callout-body-container callout-body">
<p>Instead of assuming the two groups keep the same relative risk forever,<br>
we allow the <strong>risk difference between groups to change over time</strong>.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
When to Use It
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>You detect a <strong>proportional hazards (PH) violation</strong> for a variable (e.g.&nbsp;<strong>donor type</strong>) but you <strong>still want an explicit effect estimate</strong>, rather than stratifying it away.</li>
<li>For example:
<ul>
<li><strong>Early after transplant</strong>, living donors may be <strong>protective</strong></li>
<li><strong>Later</strong>, that advantage may <strong>diminish or reverse</strong></li>
</ul></li>
</ul>
</div>
</div>
</section>
<section id="worked-example-time-varying-effect-of-donor-type" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="worked-example-time-varying-effect-of-donor-type"><span class="header-section-number">8</span> Worked Example: Time-Varying Effect of Donor Type</h2>
<p>We return to the kidney transplant example:</p>
<ul>
<li><strong>Outcome:</strong> time to graft failure<br>
</li>
<li><strong>Exposure:</strong> donor type (living vs deceased)<br>
</li>
<li><strong>Covariates:</strong> donor age, recipient gender, baseline eGFR</li>
</ul>
<p>Previously, we showed that <strong>donor type violates the PH assumption</strong>.</p>
<p>We introduce an <strong>interaction between the covariate and time</strong>, most commonly:</p>
<ul>
<li><strong>donor type √ó log(time)</strong><br>
</li>
<li><strong>donor type √ó time</strong></li>
</ul>
<p>This allows the model to estimate <strong>how the effect changes with time</strong>.</p>
<p>The Cox model becomes:</p>
<p><span class="math display">\[
h(t) = h_0(t)\exp\left[\beta_1 \,\text{donor\_type} + \beta_2 \left(\text{donor\_type} \times \log(t)\right) + \cdots \right]
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(\beta_1\)</span> represents the <strong>baseline (early) effect</strong> of donor type<br>
</li>
<li><span class="math inline">\(\beta_2\)</span> represents <strong>how that effect changes over time</strong></li>
</ul>
<section id="step-1-fit-a-cox-model-with-a-time-varying-coefficient" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="step-1-fit-a-cox-model-with-a-time-varying-coefficient"><span class="header-section-number">8.1</span> Step 1: Fit a Cox Model With a Time-Varying Coefficient</h3>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>kidney_violate <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"stratified_kidney_data.csv"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>kidney_violate<span class="sc">$</span>donor_live <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(kidney_violate<span class="sc">$</span>donor_type <span class="sc">==</span> <span class="st">"living"</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>cox_timevary <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> donor_live <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    donor_age <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    recipient_gender <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    egfr_baseline <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tt</span>(donor_live),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> kidney_violate,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) {</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">*</span> <span class="fu">log</span>(t <span class="sc">+</span> <span class="fl">0.01</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_timevary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ donor_live + donor_age + 
    recipient_gender + egfr_baseline + tt(donor_live), data = kidney_violate, 
    tt = function(x, t, ...) {
        x * log(t + 0.01)
    })

  n= 400, number of events= 171 

                          coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
donor_live           -0.693440  0.499853  0.360232 -1.925  0.05423 .  
donor_age             0.011064  1.011126  0.007485  1.478  0.13935    
recipient_gendermale  0.455043  1.576241  0.154407  2.947  0.00321 ** 
egfr_baseline        -0.014874  0.985236  0.006917 -2.150  0.03152 *  
tt(donor_live)        1.261201  3.529659  0.252705  4.991 6.01e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                     exp(coef) exp(-coef) lower .95 upper .95
donor_live              0.4999     2.0006    0.2467    1.0127
donor_age               1.0111     0.9890    0.9964    1.0261
recipient_gendermale    1.5762     0.6344    1.1646    2.1333
egfr_baseline           0.9852     1.0150    0.9720    0.9987
tt(donor_live)          3.5297     0.2833    2.1509    5.7921

Concordance= 0.681  (se = 0.02 )
Likelihood ratio test= 77.42  on 5 df,   p=3e-15
Wald test            = 64.54  on 5 df,   p=1e-12
Score (logrank) test = 75.7  on 5 df,   p=7e-15</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>donor_live represents the baseline effect</p></li>
<li><p>tt(donor_live) allows the effect to change with time</p></li>
<li><p><span class="math inline">\(\log(t)\)</span> captures gradual, nonlinear change<br>
</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How to Interpret the Model
</div>
</div>
<section id="interpretation-of-the-time-varying-cox-model" class="level3 callout-body-container callout-body" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="interpretation-of-the-time-varying-cox-model"><span class="header-section-number">8.2</span> Interpretation of the Time-Varying Cox Model</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 17%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>HR (exp(coef))</th>
<th>95% CI</th>
<th>p-value</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>donor_live</strong></td>
<td>0.50</td>
<td>0.25 ‚Äì 1.01</td>
<td>0.054 (‚âà 0.05)</td>
<td>At the <strong>start of follow-up</strong> (when <span class="math inline">\(\log(t) \approx 0\)</span>), recipients of a <strong>living donor</strong> kidney have about <strong>50% lower hazard</strong> of graft failure compared to deceased-donor recipients.</td>
</tr>
<tr class="even">
<td><strong>tt(donor_live)</strong></td>
<td>3.53</td>
<td>2.15 ‚Äì 5.79</td>
<td>&lt; 0.001 ***</td>
<td>The <strong>effect of living donor changes significantly over time</strong>. The hazard ratio increases by roughly a factor of <strong>3.5</strong> for each unit increase in <span class="math inline">\(\log(t)\)</span>. In other words, the early advantage from living donors <strong>diminishes as time goes on</strong>.</td>
</tr>
<tr class="odd">
<td><strong>donor_age</strong></td>
<td>1.01</td>
<td>1.00 ‚Äì 1.03</td>
<td>0.14</td>
<td>Older donor age shows a <strong>small, non-significant trend</strong> toward higher hazard of graft failure.</td>
</tr>
<tr class="even">
<td><strong>recipient_gender (male)</strong></td>
<td>1.58</td>
<td>1.16 ‚Äì 2.13</td>
<td>0.003 **</td>
<td>Male recipients have about <strong>58% higher hazard</strong> of graft failure than females, after adjusting for other factors.</td>
</tr>
<tr class="odd">
<td><strong>egfr_baseline</strong></td>
<td>0.99</td>
<td>0.97 ‚Äì 1.00</td>
<td>0.032 *</td>
<td>Each 1-unit higher baseline eGFR reduces the hazard of graft failure by roughly <strong>1.5%</strong>, indicating better baseline kidney function is <strong>protective</strong>.</td>
</tr>
</tbody>
</table>
</section>
</div>
</section>
<section id="visualising-the-time-varying-hazard-ratio" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="visualising-the-time-varying-hazard-ratio"><span class="header-section-number">8.3</span> Visualising the Time-Varying Hazard Ratio</h3>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">coef</span>(cox_timevary)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">vcov</span>(cox_timevary)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>beta1 <span class="ot">&lt;-</span> b[<span class="st">"donor_live"</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>beta2 <span class="ot">&lt;-</span> b[<span class="st">"tt(donor_live)"</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>var_beta1 <span class="ot">&lt;-</span> v[<span class="st">"donor_live"</span>, <span class="st">"donor_live"</span>]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>var_beta2 <span class="ot">&lt;-</span> v[<span class="st">"tt(donor_live)"</span>, <span class="st">"tt(donor_live)"</span>]</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>cov_b1b2  <span class="ot">&lt;-</span> v[<span class="st">"donor_live"</span>, <span class="st">"tt(donor_live)"</span>]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>t_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.5</span>, <span class="dv">8</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>log_t <span class="ot">&lt;-</span> <span class="fu">log</span>(t_seq <span class="sc">+</span> <span class="fl">0.01</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>lp <span class="ot">&lt;-</span> beta1 <span class="sc">+</span> beta2 <span class="sc">*</span> log_t</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>var_lp <span class="ot">&lt;-</span> var_beta1 <span class="sc">+</span> (log_t<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> var_beta2 <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> log_t <span class="sc">*</span> cov_b1b2</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>se_lp <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(var_lp)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>hr_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">time  =</span> t_seq,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">HR    =</span> <span class="fu">exp</span>(lp),</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">exp</span>(lp <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_lp),</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">exp</span>(lp <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_lp)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hr_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> HR)) <span class="sc">+</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"#c75b87"</span>) <span class="sc">+</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">colour =</span> <span class="st">"#c75b87"</span>) <span class="sc">+</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Time-varying effect of donor type"</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Hazard ratio: living vs deceased donor"</span>,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time since transplant (years)"</span>,</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Hazard ratio"</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Early follow-up: HR &lt; 1 ‚Üí protective effect of living donors</p>
<p>Later follow-up: HR increases and may exceed 1</p>
<p>Uncertainty increases at longer follow-up due to fewer events</p>
<p>The HR steadily increases and crosses 1 after roughly 1‚Äì2 years, indicating the early survival advantage of living donors diminishes.</p>
<p>By 5‚Äì8 years, the HR &gt; 2‚Äì3, suggesting higher hazard among living-donor grafts in the later period.</p>
<p>The confidence band widens with time because there are fewer events and greater uncertainty at longer follow-up.</p>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb11" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Lecture 3: Cox model when PH assumption is violated"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 3</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE}</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="in">  message = FALSE,</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="in">  warning = FALSE</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>By the end of this lecture, you should be able to:</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Recognise when the **proportional hazards (PH) assumption** is violated</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understand different strategies to handle non-PH:</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Stratified Cox model</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Time-varying effects</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Extended Cox with time-varying covariates</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understand when a **joint model** is needed</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reminder: Proportional Hazards Assumption</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>The Cox model assumes that **hazard ratios are constant over time**.</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>This means that if one group has higher risk than another at the beginning,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>it has the same *relative* risk later in follow-up.</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>If this assumption does not hold, the estimated hazard ratio from a standard Cox model</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>may be misleading.</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="fu">## What If Proportional Hazards Does Not Hold?</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>There are several approaches when PH is violated:</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Stratified Cox model:** allow baseline hazards to differ by group.</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Include time-varying effect:** model changing effects over time, include interaction between covariate and time (e.g. $ùë•√óùë°$). </span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Use extended Cox model:** allow a covariate‚Äôs value itself to change over time.</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stratified Cox model</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>When the proportional hazards (PH) assumption is violated for a categorical variable, one option is a **stratified Cox model**.</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>A stratified Cox model can be written as:</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>h_s(t \mid X) = h_{0s}(t)\,\exp(\beta_1 X_1 + \beta_2 X_2 + \cdots)</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$s$ is the stratum (e.g. donor type)</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$h_{0s}(t)$ is the **baseline hazard for stratum $s$**</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$X_1, X_2, \ldots$ are other covariates</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a> **What does stratification mean?**  </span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>If we stratify on a variable (e.g. **donor type**):</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We **do not estimate a single hazard ratio** for the stratifying variable anymore  </span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>  (we are not saying ‚Äúliving vs deceased = HR 0.7‚Äù)</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The stratifying variable is used only to **define strata**</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each stratum is allowed to have a **different baseline risk trajectory** over time</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>In words:</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Patients with living donors and patients with deceased donors are allowed to have completely different baseline hazards over time.</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>**What is still estimated?**   </span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>We still estimate the effects of other covariates (e.g. donor age, recipient sex, eGFR at transplant), assuming those effects are **proportional within each stratum**.</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>Stratification is useful when a variable strongly affects baseline risk but does not satisfy the PH assumption.</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>Stratification can be thought of as:</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **‚ÄúParallel Cox models with different baseline hazards, but the same slopes for the other covariates.‚Äù**</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>That is, each group has its own baseline risk over time, but covariate effects are assumed to be the same across groups.</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a> ‚úÖ  **When to use stratification**</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>Use stratification when:</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The proportional hazards (PH) violation is mainly driven by **one categorical variable** (e.g. donor type)</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You still want to **adjust for this variable**</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>But you do **not need its hazard ratio** as a main result</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>In this case, the variable is used to define strata rather than being estimated as a coefficient.</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>‚ùå **When not to use stratification**</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>Do **not** use stratification when:</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The stratifying variable is your **primary exposure of interest**</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You need to report a **hazard ratio comparing groups**</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>Because once you stratify on a variable (e.g. donor type), you **no longer obtain a single hazard ratio** comparing those groups.</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example: Handling Non-Proportional Hazards Using Stratified Cox Model</span></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>We are interested in whether time to graft failure after kidney transplantation differs by donor type (living vs deceased), after adjusting for important clinical factors.</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>We begin by fitting a standard Cox proportional hazards model, then check the PH assumption.</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>If the PH assumption is violated for any categorical covariate in the model, we refit the model using stratification by that covariate.</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a><span class="in">library(survival)</span></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a><span class="in">stratified_kidney_data&lt;-read.csv("stratified_kidney_data.CSV")</span></span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a><span class="in">cox_standard &lt;- coxph(</span></span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a><span class="in">  Surv(time, status) ~ donor_type +</span></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a><span class="in">    donor_age +</span></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a><span class="in">    recipient_gender +</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a><span class="in">    egfr_baseline,</span></span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a><span class="in">  data = stratified_kidney_data</span></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a><span class="in">#summary(cox_standard)</span></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a><span class="in">#check the PH assumption first </span></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a><span class="in">ph_test &lt;- cox.zph(cox_standard)</span></span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a><span class="in">ph_test</span></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a><span class="in">plot(ph_test)</span></span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>A small p-value indicates evidence against the proportional hazards assumption.</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>**Interpretation of PH diagnostics**  </span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>The proportional hazards assumption is violated for donor type.  </span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>Other covariates do not show strong evidence of violation.  </span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>The global test is significant, indicating overall non-proportionality.  </span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>This suggests that the effect of donor type on graft failure risk changes over time, making the standard Cox model inappropriate.  </span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>**Stratified Cox model**  </span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>To address this violation, we fit a stratified Cox model, stratifying on donor type.</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a><span class="in">library(survival)</span></span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a><span class="in">cox_strat &lt;- coxph(</span></span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a><span class="in">Surv(time, status) ~ donor_age + recipient_gender + egfr_baseline +</span></span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a><span class="in">strata(donor_type),</span></span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a><span class="in">data = stratified_kidney_data</span></span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a><span class="in">summary(cox_strat)</span></span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We no longer estimate a hazard ratio for donor type.</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Donor type is now used only to define separate baseline hazards.</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Effects of other covariates are assumed proportional within each stratum.</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>üß†  **Interpretation of stratified Cox model**</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>Within each donor type (living and deceased), we interpret covariate effects as follows:</span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>‚úÖ Donor age  </span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>HR ‚âà 1.01 (95% CI: 0.997‚Äì1.03, P-value=0.14), Not statistically significant.  </span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>Within each donor type, donor age shows no strong association with graft failure.</span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>‚úÖ Recipient gender (male)</span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>HR ‚âà 1.58 (95% CI: 1.16‚Äì2.13, P-value=0.003), Statistically significant.</span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>Male recipients have about 58% higher hazard of graft failure compared to females</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>This comparison is within donor type, adjusting for donor age and eGFR.</span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>‚úÖ eGFR at transplant</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>HR ‚âà 0.99 (95% CI: 0.97‚Äì1.00, P-value=0.033), Statistically significant.</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>Each 1-unit increase in baseline eGFR is associated with about 1‚Äì2% lower hazard of graft failure, within each donor type.</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a>To improve interpretability, we can express the effect per **10-unit increase** in eGFR:</span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a>HR_{10\text{-unit}} = 0.99^{10} \approx 0.90</span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a>**Interpretation:**  </span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>Within each donor type, a 10-unit higher eGFR at the time of transplant is associated with approximately a **10% lower hazard of graft failure**, after adjusting for donor age and recipient gender.</span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a><span class="fu">### What about donor type?</span></span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>Stratifying by donor type allows each group to have its own baseline hazard curve, effectively removing the need to assume a constant hazard ratio over time.  </span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>The curves demonstrate that living and deceased donor grafts follow different survival trajectories ‚Äî exactly what we expect when the PH assumption is violated.</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a><span class="in"># cox_strat is the stratified cox model we fitted in previous chunk </span></span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a><span class="in">sf_strat &lt;- survfit(cox_strat)</span></span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert survfit to a tidy data frame for ggplot</span></span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a><span class="in">sf_df &lt;- data.frame(</span></span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a><span class="in">  time  = sf_strat$time,</span></span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a><span class="in">  surv  = sf_strat$surv,</span></span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a><span class="in">  lower = sf_strat$lower,</span></span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a><span class="in">  upper = sf_strat$upper,</span></span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a><span class="in">  strata = rep(names(sf_strat$strata), sf_strat$strata)</span></span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a><span class="in"># Clean up the stratum labels from "donor_type=deceased" ‚Üí "deceased"</span></span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a><span class="in">sf_df$strata &lt;- sub("donor_type=", "", sf_df$strata)</span></span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a><span class="in">stratified_cox_plot&lt;-ggplot(sf_df, aes(x = time, y = surv, colour = strata)) +</span></span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_step(linewidth = 1.2) +</span></span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower, ymax = upper, fill = strata),</span></span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a><span class="in">              alpha = 0.15, linewidth = 0) +</span></span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_colour_manual(values = c("deceased" = "#365abd",  # deep blue</span></span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a><span class="in">                                 "living"   = "#c0397e"))+ # magenta/rose</span></span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("deceased" = "#365abd",</span></span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a><span class="in">                               "living"   = "#c0397e")) +</span></span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Stratified Cox Model\nDifferent Baseline Hazards by Donor Type",</span></span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Time since transplant (years)",</span></span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a><span class="in">    y = "Predicted survival probability",</span></span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a><span class="in">    colour = "Donor type",</span></span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a><span class="in">    fill   = "Donor type"</span></span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0.4, 1)) +</span></span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_grey(base_size = 14) +</span></span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.title       = element_text(face = "bold", hjust = 0.5),</span></span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position  = "bottom",</span></span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title     = element_text(face = "bold")</span></span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a><span class="in">stratified_cox_plot</span></span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Ignoring PH Violations Can Be Misleading</span></span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a>If we ignore the violation of the proportional hazards (PH) assumption and proceed with a standard Cox model, we may obtain a single hazard ratio that does **not accurately reflect how risk changes over time**.</span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a>This can lead to misleading conclusions, as the estimated effect represents an average over follow-up rather than the true time-varying relationship.</span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a>This is illustrated in the plot below, where the separation between groups is clearly **not constant over time**.</span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a><span class="in">#data preparation for plot </span></span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-292"><a href="#cb11-292" aria-hidden="true" tabindex="-1"></a><span class="in">new_deceased &lt;- data.frame(</span></span>
<span id="cb11-293"><a href="#cb11-293" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_type = factor("deceased", levels = levels(as.factor(stratified_kidney_data$donor_type))),</span></span>
<span id="cb11-294"><a href="#cb11-294" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_age = mean(stratified_kidney_data$donor_age, na.rm = TRUE),</span></span>
<span id="cb11-295"><a href="#cb11-295" aria-hidden="true" tabindex="-1"></a><span class="in">  recipient_gender = factor("female", levels = levels(as.factor(stratified_kidney_data$recipient_gender))),</span></span>
<span id="cb11-296"><a href="#cb11-296" aria-hidden="true" tabindex="-1"></a><span class="in">  egfr_baseline = mean(stratified_kidney_data$egfr_baseline, na.rm = TRUE)</span></span>
<span id="cb11-297"><a href="#cb11-297" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-298"><a href="#cb11-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-299"><a href="#cb11-299" aria-hidden="true" tabindex="-1"></a><span class="in">new_living &lt;- data.frame(</span></span>
<span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_type = factor("living", levels = levels(as.factor(stratified_kidney_data$donor_type))),</span></span>
<span id="cb11-301"><a href="#cb11-301" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_age = mean(stratified_kidney_data$donor_age, na.rm = TRUE),</span></span>
<span id="cb11-302"><a href="#cb11-302" aria-hidden="true" tabindex="-1"></a><span class="in">  recipient_gender = factor("female", levels = levels(as.factor(stratified_kidney_data$recipient_gender))),</span></span>
<span id="cb11-303"><a href="#cb11-303" aria-hidden="true" tabindex="-1"></a><span class="in">  egfr_baseline = mean(stratified_kidney_data$egfr_baseline, na.rm = TRUE)</span></span>
<span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-305"><a href="#cb11-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-306"><a href="#cb11-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-307"><a href="#cb11-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-308"><a href="#cb11-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-309"><a href="#cb11-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-310"><a href="#cb11-310" aria-hidden="true" tabindex="-1"></a><span class="in">sf_deceased &lt;- survfit(cox_standard, newdata = new_deceased)</span></span>
<span id="cb11-311"><a href="#cb11-311" aria-hidden="true" tabindex="-1"></a><span class="in">sf_living   &lt;- survfit(cox_standard, newdata = new_living)</span></span>
<span id="cb11-312"><a href="#cb11-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-313"><a href="#cb11-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-314"><a href="#cb11-314" aria-hidden="true" tabindex="-1"></a><span class="in">df_dec &lt;- data.frame(</span></span>
<span id="cb11-315"><a href="#cb11-315" aria-hidden="true" tabindex="-1"></a><span class="in">  time       = sf_deceased$time,</span></span>
<span id="cb11-316"><a href="#cb11-316" aria-hidden="true" tabindex="-1"></a><span class="in">  surv       = sf_deceased$surv,</span></span>
<span id="cb11-317"><a href="#cb11-317" aria-hidden="true" tabindex="-1"></a><span class="in">  lower      = sf_deceased$lower,</span></span>
<span id="cb11-318"><a href="#cb11-318" aria-hidden="true" tabindex="-1"></a><span class="in">  upper      = sf_deceased$upper,</span></span>
<span id="cb11-319"><a href="#cb11-319" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_type = "Deceased donor"</span></span>
<span id="cb11-320"><a href="#cb11-320" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-321"><a href="#cb11-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-322"><a href="#cb11-322" aria-hidden="true" tabindex="-1"></a><span class="in">df_liv &lt;- data.frame(</span></span>
<span id="cb11-323"><a href="#cb11-323" aria-hidden="true" tabindex="-1"></a><span class="in">  time       = sf_living$time,</span></span>
<span id="cb11-324"><a href="#cb11-324" aria-hidden="true" tabindex="-1"></a><span class="in">  surv       = sf_living$surv,</span></span>
<span id="cb11-325"><a href="#cb11-325" aria-hidden="true" tabindex="-1"></a><span class="in">  lower      = sf_living$lower,</span></span>
<span id="cb11-326"><a href="#cb11-326" aria-hidden="true" tabindex="-1"></a><span class="in">  upper      = sf_living$upper,</span></span>
<span id="cb11-327"><a href="#cb11-327" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_type = "Living donor"</span></span>
<span id="cb11-328"><a href="#cb11-328" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-329"><a href="#cb11-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-330"><a href="#cb11-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-331"><a href="#cb11-331" aria-hidden="true" tabindex="-1"></a><span class="in">df_ph &lt;- rbind(df_dec, df_liv)</span></span>
<span id="cb11-332"><a href="#cb11-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-333"><a href="#cb11-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-334"><a href="#cb11-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-335"><a href="#cb11-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-336"><a href="#cb11-336" aria-hidden="true" tabindex="-1"></a><span class="in">standard_cox_plot&lt;-ggplot(df_ph, aes(x = time, y = surv, colour = donor_type, fill = donor_type)) +</span></span>
<span id="cb11-337"><a href="#cb11-337" aria-hidden="true" tabindex="-1"></a><span class="in">  # CI ribbon</span></span>
<span id="cb11-338"><a href="#cb11-338" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower, ymax = upper),</span></span>
<span id="cb11-339"><a href="#cb11-339" aria-hidden="true" tabindex="-1"></a><span class="in">              alpha = 0.2,</span></span>
<span id="cb11-340"><a href="#cb11-340" aria-hidden="true" tabindex="-1"></a><span class="in">              colour = NA,</span></span>
<span id="cb11-341"><a href="#cb11-341" aria-hidden="true" tabindex="-1"></a><span class="in">              show.legend = FALSE) +</span></span>
<span id="cb11-342"><a href="#cb11-342" aria-hidden="true" tabindex="-1"></a><span class="in">  # Step survival curve</span></span>
<span id="cb11-343"><a href="#cb11-343" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_step(linewidth = 1.2) +</span></span>
<span id="cb11-344"><a href="#cb11-344" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb11-345"><a href="#cb11-345" aria-hidden="true" tabindex="-1"></a><span class="in">  # Manual colours for consistency across slides</span></span>
<span id="cb11-346"><a href="#cb11-346" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_colour_manual(</span></span>
<span id="cb11-347"><a href="#cb11-347" aria-hidden="true" tabindex="-1"></a><span class="in">    values = c("Deceased donor" = "#365abd",   # blue</span></span>
<span id="cb11-348"><a href="#cb11-348" aria-hidden="true" tabindex="-1"></a><span class="in">               "Living donor"   = "#c0397e")   # magenta/rose</span></span>
<span id="cb11-349"><a href="#cb11-349" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb11-350"><a href="#cb11-350" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(</span></span>
<span id="cb11-351"><a href="#cb11-351" aria-hidden="true" tabindex="-1"></a><span class="in">    values = c("Deceased donor" = "#365abd",</span></span>
<span id="cb11-352"><a href="#cb11-352" aria-hidden="true" tabindex="-1"></a><span class="in">               "Living donor"   = "#c0397e")</span></span>
<span id="cb11-353"><a href="#cb11-353" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb11-354"><a href="#cb11-354" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb11-355"><a href="#cb11-355" aria-hidden="true" tabindex="-1"></a><span class="in">  # Axis labels and title</span></span>
<span id="cb11-356"><a href="#cb11-356" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb11-357"><a href="#cb11-357" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Standard Cox PH Model\nAssumes Constant Effect of Donor Type",</span></span>
<span id="cb11-358"><a href="#cb11-358" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Time since transplant (years)",</span></span>
<span id="cb11-359"><a href="#cb11-359" aria-hidden="true" tabindex="-1"></a><span class="in">    y = "Predicted survival probability",</span></span>
<span id="cb11-360"><a href="#cb11-360" aria-hidden="true" tabindex="-1"></a><span class="in">    colour = "Donor type"</span></span>
<span id="cb11-361"><a href="#cb11-361" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb11-362"><a href="#cb11-362" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb11-363"><a href="#cb11-363" aria-hidden="true" tabindex="-1"></a><span class="in">  # y-axis from 0.4 to 1.0</span></span>
<span id="cb11-364"><a href="#cb11-364" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0.4, 1.0)) +</span></span>
<span id="cb11-365"><a href="#cb11-365" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb11-366"><a href="#cb11-366" aria-hidden="true" tabindex="-1"></a><span class="in">  # Use grey theme with gridlines</span></span>
<span id="cb11-367"><a href="#cb11-367" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_grey(base_size = 14) +</span></span>
<span id="cb11-368"><a href="#cb11-368" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb11-369"><a href="#cb11-369" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.title       = element_text(face = "bold", hjust = 0.5),</span></span>
<span id="cb11-370"><a href="#cb11-370" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position  = "bottom",</span></span>
<span id="cb11-371"><a href="#cb11-371" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title     = element_text(face = "bold")</span></span>
<span id="cb11-372"><a href="#cb11-372" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb11-373"><a href="#cb11-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-374"><a href="#cb11-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-375"><a href="#cb11-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-376"><a href="#cb11-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-377"><a href="#cb11-377" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb11-378"><a href="#cb11-378" aria-hidden="true" tabindex="-1"></a><span class="in">library(gridExtra)</span></span>
<span id="cb11-379"><a href="#cb11-379" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb11-380"><a href="#cb11-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-381"><a href="#cb11-381" aria-hidden="true" tabindex="-1"></a><span class="in"># Reduce title size for each plot</span></span>
<span id="cb11-382"><a href="#cb11-382" aria-hidden="true" tabindex="-1"></a><span class="in">standard_cox_plot_small &lt;- standard_cox_plot +</span></span>
<span id="cb11-383"><a href="#cb11-383" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.title = element_text(size = 10))</span></span>
<span id="cb11-384"><a href="#cb11-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-385"><a href="#cb11-385" aria-hidden="true" tabindex="-1"></a><span class="in">stratified_cox_plot_small &lt;- stratified_cox_plot +</span></span>
<span id="cb11-386"><a href="#cb11-386" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.title = element_text(size = 10))</span></span>
<span id="cb11-387"><a href="#cb11-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-388"><a href="#cb11-388" aria-hidden="true" tabindex="-1"></a><span class="in"># Arrange side by side</span></span>
<span id="cb11-389"><a href="#cb11-389" aria-hidden="true" tabindex="-1"></a><span class="in">grid.arrange(</span></span>
<span id="cb11-390"><a href="#cb11-390" aria-hidden="true" tabindex="-1"></a><span class="in">  standard_cox_plot_small,</span></span>
<span id="cb11-391"><a href="#cb11-391" aria-hidden="true" tabindex="-1"></a><span class="in">  stratified_cox_plot_small,</span></span>
<span id="cb11-392"><a href="#cb11-392" aria-hidden="true" tabindex="-1"></a><span class="in">  ncol = 2</span></span>
<span id="cb11-393"><a href="#cb11-393" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-394"><a href="#cb11-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-395"><a href="#cb11-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-396"><a href="#cb11-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-397"><a href="#cb11-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-398"><a href="#cb11-398" aria-hidden="true" tabindex="-1"></a><span class="fu">## Including Time-Varying Effects</span></span>
<span id="cb11-399"><a href="#cb11-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-400"><a href="#cb11-400" aria-hidden="true" tabindex="-1"></a>When the proportional hazards (PH) assumption is violated, **stratification is not the only solution**.</span>
<span id="cb11-401"><a href="#cb11-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-402"><a href="#cb11-402" aria-hidden="true" tabindex="-1"></a>In some settings, we still want to:</span>
<span id="cb11-403"><a href="#cb11-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-404"><a href="#cb11-404" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Keep the covariate in the model**</span>
<span id="cb11-405"><a href="#cb11-405" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Obtain an explicit effect estimate**</span>
<span id="cb11-406"><a href="#cb11-406" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Allow the effect to change over time**</span>
<span id="cb11-407"><a href="#cb11-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-408"><a href="#cb11-408" aria-hidden="true" tabindex="-1"></a>This leads to a **time-varying coefficient Cox model**.</span>
<span id="cb11-409"><a href="#cb11-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-410"><a href="#cb11-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-411"><a href="#cb11-411" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Use Time-Varying Effects</span></span>
<span id="cb11-412"><a href="#cb11-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-413"><a href="#cb11-413" aria-hidden="true" tabindex="-1"></a>Use a time-varying effect when:</span>
<span id="cb11-414"><a href="#cb11-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-415"><a href="#cb11-415" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The PH assumption is violated for a variable (e.g. **donor type**)</span>
<span id="cb11-416"><a href="#cb11-416" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The variable is scientifically important</span>
<span id="cb11-417"><a href="#cb11-417" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You believe the **effect itself changes over time**</span>
<span id="cb11-418"><a href="#cb11-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-419"><a href="#cb11-419" aria-hidden="true" tabindex="-1"></a>For example:</span>
<span id="cb11-420"><a href="#cb11-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-421"><a href="#cb11-421" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Early after transplant, **living donors may be protective**</span>
<span id="cb11-422"><a href="#cb11-422" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Later, that advantage may **diminish or reverse**</span>
<span id="cb11-423"><a href="#cb11-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-424"><a href="#cb11-424" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model Idea</span></span>
<span id="cb11-425"><a href="#cb11-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-426"><a href="#cb11-426" aria-hidden="true" tabindex="-1"></a><span class="fu">## Including Time-Varying Effects</span></span>
<span id="cb11-427"><a href="#cb11-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-428"><a href="#cb11-428" aria-hidden="true" tabindex="-1"></a>In the **standard Cox model**:</span>
<span id="cb11-429"><a href="#cb11-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-430"><a href="#cb11-430" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-431"><a href="#cb11-431" aria-hidden="true" tabindex="-1"></a>h(t \mid X) = h_0(t)\exp(\beta_1 X_1 + \beta_2 X_2 + \cdots)</span>
<span id="cb11-432"><a href="#cb11-432" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-433"><a href="#cb11-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-434"><a href="#cb11-434" aria-hidden="true" tabindex="-1"></a>the coefficients ($\beta$) are assumed to be **constant over time**, which leads to the **proportional hazards (PH) assumption**.</span>
<span id="cb11-435"><a href="#cb11-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-436"><a href="#cb11-436" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-437"><a href="#cb11-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-438"><a href="#cb11-438" aria-hidden="true" tabindex="-1"></a>If a covariate‚Äôs effect **changes over time**, we can allow its coefficient to depend on time:</span>
<span id="cb11-439"><a href="#cb11-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-440"><a href="#cb11-440" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-441"><a href="#cb11-441" aria-hidden="true" tabindex="-1"></a>h(t \mid X) = h_0(t)\exp\left(\beta_1(t) X_1 + \beta_2 X_2 + \cdots\right)</span>
<span id="cb11-442"><a href="#cb11-442" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-443"><a href="#cb11-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-444"><a href="#cb11-444" aria-hidden="true" tabindex="-1"></a>This allows the **hazard ratio for $X_1$ to vary with time**.</span>
<span id="cb11-445"><a href="#cb11-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-446"><a href="#cb11-446" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb11-447"><a href="#cb11-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-448"><a href="#cb11-448" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intuition</span></span>
<span id="cb11-449"><a href="#cb11-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-450"><a href="#cb11-450" aria-hidden="true" tabindex="-1"></a>Instead of assuming the two groups keep the same relative risk forever,  </span>
<span id="cb11-451"><a href="#cb11-451" aria-hidden="true" tabindex="-1"></a>we allow the **risk difference between groups to change over time**.</span>
<span id="cb11-452"><a href="#cb11-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-453"><a href="#cb11-453" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-454"><a href="#cb11-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-455"><a href="#cb11-455" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb11-456"><a href="#cb11-456" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Use It</span></span>
<span id="cb11-457"><a href="#cb11-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-458"><a href="#cb11-458" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You detect a **proportional hazards (PH) violation** for a variable (e.g. **donor type**) but you **still want an explicit effect estimate**, rather than stratifying it away.</span>
<span id="cb11-459"><a href="#cb11-459" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For example:</span>
<span id="cb11-460"><a href="#cb11-460" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Early after transplant**, living donors may be **protective**</span>
<span id="cb11-461"><a href="#cb11-461" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Later**, that advantage may **diminish or reverse**</span>
<span id="cb11-462"><a href="#cb11-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-463"><a href="#cb11-463" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-464"><a href="#cb11-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-465"><a href="#cb11-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-466"><a href="#cb11-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-467"><a href="#cb11-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-468"><a href="#cb11-468" aria-hidden="true" tabindex="-1"></a><span class="fu">## Worked Example: Time-Varying Effect of Donor Type</span></span>
<span id="cb11-469"><a href="#cb11-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-470"><a href="#cb11-470" aria-hidden="true" tabindex="-1"></a>We return to the kidney transplant example:</span>
<span id="cb11-471"><a href="#cb11-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-472"><a href="#cb11-472" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Outcome:** time to graft failure  </span>
<span id="cb11-473"><a href="#cb11-473" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Exposure:** donor type (living vs deceased)  </span>
<span id="cb11-474"><a href="#cb11-474" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Covariates:** donor age, recipient gender, baseline eGFR  </span>
<span id="cb11-475"><a href="#cb11-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-476"><a href="#cb11-476" aria-hidden="true" tabindex="-1"></a>Previously, we showed that **donor type violates the PH assumption**.</span>
<span id="cb11-477"><a href="#cb11-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-478"><a href="#cb11-478" aria-hidden="true" tabindex="-1"></a>We introduce an **interaction between the covariate and time**, most commonly:</span>
<span id="cb11-479"><a href="#cb11-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-480"><a href="#cb11-480" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**donor type √ó log(time)**  </span>
<span id="cb11-481"><a href="#cb11-481" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**donor type √ó time**</span>
<span id="cb11-482"><a href="#cb11-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-483"><a href="#cb11-483" aria-hidden="true" tabindex="-1"></a>This allows the model to estimate **how the effect changes with time**.</span>
<span id="cb11-484"><a href="#cb11-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-485"><a href="#cb11-485" aria-hidden="true" tabindex="-1"></a>The Cox model becomes:</span>
<span id="cb11-486"><a href="#cb11-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-487"><a href="#cb11-487" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-488"><a href="#cb11-488" aria-hidden="true" tabindex="-1"></a>h(t) = h_0(t)\exp\left<span class="co">[</span><span class="ot">\beta_1 \,\text{donor\_type} + \beta_2 \left(\text{donor\_type} \times \log(t)\right) + \cdots \right</span><span class="co">]</span></span>
<span id="cb11-489"><a href="#cb11-489" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-490"><a href="#cb11-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-491"><a href="#cb11-491" aria-hidden="true" tabindex="-1"></a>Where:</span>
<span id="cb11-492"><a href="#cb11-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-493"><a href="#cb11-493" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\beta_1$ represents the **baseline (early) effect** of donor type  </span>
<span id="cb11-494"><a href="#cb11-494" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\beta_2$ represents **how that effect changes over time**</span>
<span id="cb11-495"><a href="#cb11-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-496"><a href="#cb11-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-497"><a href="#cb11-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-498"><a href="#cb11-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-499"><a href="#cb11-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-500"><a href="#cb11-500" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 1: Fit a Cox Model With a Time-Varying Coefficient</span></span>
<span id="cb11-501"><a href="#cb11-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-502"><a href="#cb11-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb11-503"><a href="#cb11-503" aria-hidden="true" tabindex="-1"></a><span class="in">library(survival)</span></span>
<span id="cb11-504"><a href="#cb11-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-505"><a href="#cb11-505" aria-hidden="true" tabindex="-1"></a><span class="in">kidney_violate &lt;- read.csv("stratified_kidney_data.csv")</span></span>
<span id="cb11-506"><a href="#cb11-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-507"><a href="#cb11-507" aria-hidden="true" tabindex="-1"></a><span class="in">kidney_violate$donor_live &lt;- ifelse(kidney_violate$donor_type == "living", 1, 0)</span></span>
<span id="cb11-508"><a href="#cb11-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-509"><a href="#cb11-509" aria-hidden="true" tabindex="-1"></a><span class="in">cox_timevary &lt;- coxph(</span></span>
<span id="cb11-510"><a href="#cb11-510" aria-hidden="true" tabindex="-1"></a><span class="in">  Surv(time, status) ~ donor_live +</span></span>
<span id="cb11-511"><a href="#cb11-511" aria-hidden="true" tabindex="-1"></a><span class="in">    donor_age +</span></span>
<span id="cb11-512"><a href="#cb11-512" aria-hidden="true" tabindex="-1"></a><span class="in">    recipient_gender +</span></span>
<span id="cb11-513"><a href="#cb11-513" aria-hidden="true" tabindex="-1"></a><span class="in">    egfr_baseline +</span></span>
<span id="cb11-514"><a href="#cb11-514" aria-hidden="true" tabindex="-1"></a><span class="in">    tt(donor_live),</span></span>
<span id="cb11-515"><a href="#cb11-515" aria-hidden="true" tabindex="-1"></a><span class="in">  data = kidney_violate,</span></span>
<span id="cb11-516"><a href="#cb11-516" aria-hidden="true" tabindex="-1"></a><span class="in">  tt = function(x, t, ...) {</span></span>
<span id="cb11-517"><a href="#cb11-517" aria-hidden="true" tabindex="-1"></a><span class="in">    x * log(t + 0.01)</span></span>
<span id="cb11-518"><a href="#cb11-518" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb11-519"><a href="#cb11-519" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-520"><a href="#cb11-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-521"><a href="#cb11-521" aria-hidden="true" tabindex="-1"></a><span class="in">summary(cox_timevary)</span></span>
<span id="cb11-522"><a href="#cb11-522" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-523"><a href="#cb11-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-524"><a href="#cb11-524" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb11-525"><a href="#cb11-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-526"><a href="#cb11-526" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>donor_live represents the baseline effect  </span>
<span id="cb11-527"><a href="#cb11-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-528"><a href="#cb11-528" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>tt(donor_live) allows the effect to change with time  </span>
<span id="cb11-529"><a href="#cb11-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-530"><a href="#cb11-530" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\log(t)$ captures gradual, nonlinear change  </span>
<span id="cb11-531"><a href="#cb11-531" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-532"><a href="#cb11-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-533"><a href="#cb11-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-534"><a href="#cb11-534" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb11-535"><a href="#cb11-535" aria-hidden="true" tabindex="-1"></a><span class="fu">### How to Interpret the Model</span></span>
<span id="cb11-536"><a href="#cb11-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-537"><a href="#cb11-537" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation of the Time-Varying Cox Model</span></span>
<span id="cb11-538"><a href="#cb11-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-539"><a href="#cb11-539" aria-hidden="true" tabindex="-1"></a>| Variable                  | HR (exp(coef)) | 95% CI        | p-value        | Interpretation |</span>
<span id="cb11-540"><a href="#cb11-540" aria-hidden="true" tabindex="-1"></a>|---------------------------|---------------|---------------|----------------|----------------|</span>
<span id="cb11-541"><a href="#cb11-541" aria-hidden="true" tabindex="-1"></a>| **donor_live**            | 0.50          | 0.25 ‚Äì 1.01   | 0.054 (‚âà 0.05) | At the **start of follow-up** (when $\log(t) \approx 0$), recipients of a **living donor** kidney have about **50% lower hazard** of graft failure compared to deceased-donor recipients. |</span>
<span id="cb11-542"><a href="#cb11-542" aria-hidden="true" tabindex="-1"></a>| **tt(donor_live)**        | 3.53          | 2.15 ‚Äì 5.79   | &lt; 0.001 ***    | The **effect of living donor changes significantly over time**. The hazard ratio increases by roughly a factor of **3.5** for each unit increase in $\log(t)$. In other words, the early advantage from living donors **diminishes as time goes on**. |</span>
<span id="cb11-543"><a href="#cb11-543" aria-hidden="true" tabindex="-1"></a>| **donor_age**             | 1.01          | 1.00 ‚Äì 1.03   | 0.14           | Older donor age shows a **small, non-significant trend** toward higher hazard of graft failure. |</span>
<span id="cb11-544"><a href="#cb11-544" aria-hidden="true" tabindex="-1"></a>| **recipient_gender (male)** | 1.58        | 1.16 ‚Äì 2.13   | 0.003 **       | Male recipients have about **58% higher hazard** of graft failure than females, after adjusting for other factors. |</span>
<span id="cb11-545"><a href="#cb11-545" aria-hidden="true" tabindex="-1"></a>| **egfr_baseline**         | 0.99          | 0.97 ‚Äì 1.00   | 0.032 *        | Each 1-unit higher baseline eGFR reduces the hazard of graft failure by roughly **1.5%**, indicating better baseline kidney function is **protective**. |</span>
<span id="cb11-546"><a href="#cb11-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-547"><a href="#cb11-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-548"><a href="#cb11-548" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-549"><a href="#cb11-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-550"><a href="#cb11-550" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualising the Time-Varying Hazard Ratio</span></span>
<span id="cb11-551"><a href="#cb11-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-552"><a href="#cb11-552" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb11-553"><a href="#cb11-553" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb11-554"><a href="#cb11-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-555"><a href="#cb11-555" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- coef(cox_timevary)</span></span>
<span id="cb11-556"><a href="#cb11-556" aria-hidden="true" tabindex="-1"></a><span class="in">v &lt;- vcov(cox_timevary)</span></span>
<span id="cb11-557"><a href="#cb11-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-558"><a href="#cb11-558" aria-hidden="true" tabindex="-1"></a><span class="in">beta1 &lt;- b["donor_live"]</span></span>
<span id="cb11-559"><a href="#cb11-559" aria-hidden="true" tabindex="-1"></a><span class="in">beta2 &lt;- b["tt(donor_live)"]</span></span>
<span id="cb11-560"><a href="#cb11-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-561"><a href="#cb11-561" aria-hidden="true" tabindex="-1"></a><span class="in">var_beta1 &lt;- v["donor_live", "donor_live"]</span></span>
<span id="cb11-562"><a href="#cb11-562" aria-hidden="true" tabindex="-1"></a><span class="in">var_beta2 &lt;- v["tt(donor_live)", "tt(donor_live)"]</span></span>
<span id="cb11-563"><a href="#cb11-563" aria-hidden="true" tabindex="-1"></a><span class="in">cov_b1b2  &lt;- v["donor_live", "tt(donor_live)"]</span></span>
<span id="cb11-564"><a href="#cb11-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-565"><a href="#cb11-565" aria-hidden="true" tabindex="-1"></a><span class="in">t_seq &lt;- seq(0.5, 8, by = 0.1)</span></span>
<span id="cb11-566"><a href="#cb11-566" aria-hidden="true" tabindex="-1"></a><span class="in">log_t &lt;- log(t_seq + 0.01)</span></span>
<span id="cb11-567"><a href="#cb11-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-568"><a href="#cb11-568" aria-hidden="true" tabindex="-1"></a><span class="in">lp &lt;- beta1 + beta2 * log_t</span></span>
<span id="cb11-569"><a href="#cb11-569" aria-hidden="true" tabindex="-1"></a><span class="in">var_lp &lt;- var_beta1 + (log_t^2) * var_beta2 + 2 * log_t * cov_b1b2</span></span>
<span id="cb11-570"><a href="#cb11-570" aria-hidden="true" tabindex="-1"></a><span class="in">se_lp &lt;- sqrt(var_lp)</span></span>
<span id="cb11-571"><a href="#cb11-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-572"><a href="#cb11-572" aria-hidden="true" tabindex="-1"></a><span class="in">hr_df &lt;- data.frame(</span></span>
<span id="cb11-573"><a href="#cb11-573" aria-hidden="true" tabindex="-1"></a><span class="in">  time  = t_seq,</span></span>
<span id="cb11-574"><a href="#cb11-574" aria-hidden="true" tabindex="-1"></a><span class="in">  HR    = exp(lp),</span></span>
<span id="cb11-575"><a href="#cb11-575" aria-hidden="true" tabindex="-1"></a><span class="in">  lower = exp(lp - 1.96 * se_lp),</span></span>
<span id="cb11-576"><a href="#cb11-576" aria-hidden="true" tabindex="-1"></a><span class="in">  upper = exp(lp + 1.96 * se_lp)</span></span>
<span id="cb11-577"><a href="#cb11-577" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-578"><a href="#cb11-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-579"><a href="#cb11-579" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(hr_df, aes(x = time, y = HR)) +</span></span>
<span id="cb11-580"><a href="#cb11-580" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower, ymax = upper),</span></span>
<span id="cb11-581"><a href="#cb11-581" aria-hidden="true" tabindex="-1"></a><span class="in">              alpha = 0.2, fill = "#c75b87") +</span></span>
<span id="cb11-582"><a href="#cb11-582" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.2, colour = "#c75b87") +</span></span>
<span id="cb11-583"><a href="#cb11-583" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 1,</span></span>
<span id="cb11-584"><a href="#cb11-584" aria-hidden="true" tabindex="-1"></a><span class="in">             linetype = "dashed",</span></span>
<span id="cb11-585"><a href="#cb11-585" aria-hidden="true" tabindex="-1"></a><span class="in">             colour = "grey50") +</span></span>
<span id="cb11-586"><a href="#cb11-586" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb11-587"><a href="#cb11-587" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Time-varying effect of donor type",</span></span>
<span id="cb11-588"><a href="#cb11-588" aria-hidden="true" tabindex="-1"></a><span class="in">    subtitle = "Hazard ratio: living vs deceased donor",</span></span>
<span id="cb11-589"><a href="#cb11-589" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Time since transplant (years)",</span></span>
<span id="cb11-590"><a href="#cb11-590" aria-hidden="true" tabindex="-1"></a><span class="in">    y = "Hazard ratio"</span></span>
<span id="cb11-591"><a href="#cb11-591" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb11-592"><a href="#cb11-592" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_grey(base_size = 14) +</span></span>
<span id="cb11-593"><a href="#cb11-593" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb11-594"><a href="#cb11-594" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.title = element_text(face = "bold", hjust = 0.5),</span></span>
<span id="cb11-595"><a href="#cb11-595" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.subtitle = element_text(hjust = 0.5),</span></span>
<span id="cb11-596"><a href="#cb11-596" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.grid.minor = element_blank()</span></span>
<span id="cb11-597"><a href="#cb11-597" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb11-598"><a href="#cb11-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-599"><a href="#cb11-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-600"><a href="#cb11-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-601"><a href="#cb11-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-602"><a href="#cb11-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-603"><a href="#cb11-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-604"><a href="#cb11-604" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb11-605"><a href="#cb11-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-606"><a href="#cb11-606" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation</span></span>
<span id="cb11-607"><a href="#cb11-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-608"><a href="#cb11-608" aria-hidden="true" tabindex="-1"></a>Early follow-up: HR &lt; 1 ‚Üí protective effect of living donors</span>
<span id="cb11-609"><a href="#cb11-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-610"><a href="#cb11-610" aria-hidden="true" tabindex="-1"></a>Later follow-up: HR increases and may exceed 1</span>
<span id="cb11-611"><a href="#cb11-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-612"><a href="#cb11-612" aria-hidden="true" tabindex="-1"></a>Uncertainty increases at longer follow-up due to fewer events</span>
<span id="cb11-613"><a href="#cb11-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-614"><a href="#cb11-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-615"><a href="#cb11-615" aria-hidden="true" tabindex="-1"></a>The HR steadily increases and crosses 1 after roughly 1‚Äì2 years, indicating the early survival advantage of living donors diminishes.  </span>
<span id="cb11-616"><a href="#cb11-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-617"><a href="#cb11-617" aria-hidden="true" tabindex="-1"></a>By 5‚Äì8 years, the HR &gt; 2‚Äì3, suggesting higher hazard among living-donor grafts in the later period.  </span>
<span id="cb11-618"><a href="#cb11-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-619"><a href="#cb11-619" aria-hidden="true" tabindex="-1"></a>The confidence band widens with time because there are fewer events and greater uncertainty at longer follow-up. </span>
<span id="cb11-620"><a href="#cb11-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-621"><a href="#cb11-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-622"><a href="#cb11-622" aria-hidden="true" tabindex="-1"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>