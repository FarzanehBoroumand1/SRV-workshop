<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lecture 3: Cox model when PH assumption is violated ‚Äì Advanced Survival Concepts and Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./lecture-01-intro-km-rmst.html">Lectures</a></li><li class="breadcrumb-item"><a href="./lecture-03-non-ph-cox.html">Lecture 3: Cox model when PH assumption is violated</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Advanced Survival Concepts and Analysis</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Lectures</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lecture-01-intro-km-rmst.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 1: Introduction, Kaplan‚ÄìMeier and RMST</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lecture-02-cox-ph.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 2: Cox proportional hazards model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lecture-03-non-ph-cox.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lecture 3: Cox model when PH assumption is violated</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lecture-04-joint-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 4: Joint model</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives"><span class="header-section-number">1</span> Learning Objectives</a></li>
  <li><a href="#reminder-proportional-hazards-assumption" id="toc-reminder-proportional-hazards-assumption" class="nav-link" data-scroll-target="#reminder-proportional-hazards-assumption"><span class="header-section-number">2</span> Reminder: Proportional Hazards Assumption</a></li>
  <li><a href="#what-if-proportional-hazards-does-not-hold" id="toc-what-if-proportional-hazards-does-not-hold" class="nav-link" data-scroll-target="#what-if-proportional-hazards-does-not-hold"><span class="header-section-number">3</span> What If Proportional Hazards Does Not Hold?</a></li>
  <li><a href="#stratified-cox-model" id="toc-stratified-cox-model" class="nav-link" data-scroll-target="#stratified-cox-model"><span class="header-section-number">4</span> Stratified Cox model</a></li>
  <li><a href="#example-handling-non-proportional-hazards-using-stratified-cox-model" id="toc-example-handling-non-proportional-hazards-using-stratified-cox-model" class="nav-link" data-scroll-target="#example-handling-non-proportional-hazards-using-stratified-cox-model"><span class="header-section-number">5</span> Example: Handling Non-Proportional Hazards Using Stratified Cox Model</a></li>
  <li><a href="#including-time-varying-effects" id="toc-including-time-varying-effects" class="nav-link" data-scroll-target="#including-time-varying-effects"><span class="header-section-number">6</span> Including Time-Varying Effects</a></li>
  <li><a href="#example-time-varying-effect-of-donor-type" id="toc-example-time-varying-effect-of-donor-type" class="nav-link" data-scroll-target="#example-time-varying-effect-of-donor-type"><span class="header-section-number">7</span> Example: Time-Varying Effect of Donor Type</a></li>
  <li><a href="#extended-cox-model" id="toc-extended-cox-model" class="nav-link" data-scroll-target="#extended-cox-model"><span class="header-section-number">8</span> Extended Cox Model</a></li>
  <li><a href="#example-extended-cox-model-time-varying-covariates" id="toc-example-extended-cox-model-time-varying-covariates" class="nav-link" data-scroll-target="#example-extended-cox-model-time-varying-covariates"><span class="header-section-number">9</span> Example: Extended Cox Model (Time-Varying Covariates)</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./lecture-01-intro-km-rmst.html">Lectures</a></li><li class="breadcrumb-item"><a href="./lecture-03-non-ph-cox.html">Lecture 3: Cox model when PH assumption is violated</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Lecture 3: Cox model when PH assumption is violated</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">1</span> Learning Objectives</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>By the end of this lecture, you should be able to:</p>
<ul>
<li>Recognise when the <strong>proportional hazards (PH) assumption</strong> is violated</li>
<li>Understand different strategies to handle non-PH:
<ul>
<li>Stratified Cox model</li>
<li>Time-varying effects</li>
<li>Extended Cox with time-varying covariates</li>
</ul></li>
<li>Understand when a <strong>joint model</strong> is needed</li>
</ul>
</div>
</div>
</section>
<section id="reminder-proportional-hazards-assumption" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="reminder-proportional-hazards-assumption"><span class="header-section-number">2</span> Reminder: Proportional Hazards Assumption</h2>
<p>The Cox model assumes that <strong>hazard ratios are constant over time</strong>.</p>
<p>This means that if one group has higher risk than another at the beginning, it has the same <em>relative</em> risk later in follow-up.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If this assumption does not hold, the estimated hazard ratio from a standard Cox model may be misleading.</p>
</div>
</div>
</section>
<section id="what-if-proportional-hazards-does-not-hold" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="what-if-proportional-hazards-does-not-hold"><span class="header-section-number">3</span> What If Proportional Hazards Does Not Hold?</h2>
<p>There are several approaches when PH is violated:</p>
<ol type="1">
<li><strong>Stratified Cox model:</strong> allow baseline hazards to differ by group.</li>
<li><strong>Include time-varying effect:</strong> model changing effects over time, include interaction between covariate and time (e.g.&nbsp;<span class="math inline">\(ùë•√óùë°\)</span>).</li>
<li><strong>Use extended Cox model:</strong> allow a covariate‚Äôs value itself to change over time.</li>
</ol>
</section>
<section id="stratified-cox-model" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="stratified-cox-model"><span class="header-section-number">4</span> Stratified Cox model</h2>
<p>When the proportional hazards (PH) assumption is violated for a categorical variable, one option is a <strong>stratified Cox model</strong>.</p>
<p>A stratified Cox model can be written as:</p>
<p><span class="math display">\[
h_s(t \mid X) = h_{0s}(t)\,\exp(\beta_1 X_1 + \beta_2 X_2 + \cdots)
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(s\)</span> is the stratum (e.g.&nbsp;donor type)</li>
<li><span class="math inline">\(h_{0s}(t)\)</span> is the <strong>baseline hazard for stratum <span class="math inline">\(s\)</span></strong></li>
<li><span class="math inline">\(X_1, X_2, \ldots\)</span> are other covariates</li>
</ul>
<p><strong>What does stratification mean?</strong></p>
<p>If we stratify on a variable (e.g.&nbsp;<strong>donor type</strong>):</p>
<ul>
<li>We <strong>do not estimate a single hazard ratio</strong> for the stratifying variable anymore<br>
(we are not saying ‚Äúliving vs deceased = HR 0.7‚Äù)</li>
<li>The stratifying variable is used only to <strong>define strata</strong></li>
<li>Each stratum is allowed to have a <strong>different baseline risk trajectory</strong> over time</li>
</ul>
<p>In words:</p>
<blockquote class="blockquote">
<p>Patients with living donors and patients with deceased donors are allowed to have completely different baseline hazards over time.</p>
</blockquote>
<p><strong>What is still estimated?</strong></p>
<p>We still estimate the effects of other covariates (e.g.&nbsp;donor age, recipient sex, eGFR at transplant), assuming those effects are <strong>proportional within each stratum</strong>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Stratification is useful when a variable strongly affects baseline risk but does not satisfy the PH assumption.</p>
</div>
</div>
<p>Stratification can be thought of as:</p>
<blockquote class="blockquote">
<p><strong>‚ÄúParallel Cox models with different baseline hazards, but the same slopes for the other covariates.‚Äù</strong></p>
</blockquote>
<p>That is, each group has its own baseline risk over time, but covariate effects are assumed to be the same across groups.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
When to Use It
</div>
</div>
<div class="callout-body-container callout-body">
<p>‚úÖ <strong>When to use stratification</strong> Use stratification when:</p>
<ul>
<li>The proportional hazards (PH) violation is mainly driven by <strong>one categorical variable</strong> (e.g.&nbsp;donor type)</li>
<li>You still want to <strong>adjust for this variable</strong></li>
<li>But you do <strong>not need its hazard ratio</strong> as a main result</li>
</ul>
<p>In this case, the variable is used to define strata rather than being estimated as a coefficient.</p>
<p>‚ùå <strong>When not to use stratification</strong> Do <strong>not</strong> use stratification when:</p>
<ul>
<li>The stratifying variable is your <strong>primary exposure of interest</strong></li>
<li>You need to report a <strong>hazard ratio comparing groups</strong></li>
</ul>
<p>Because once you stratify on a variable (e.g.&nbsp;donor type), you <strong>no longer obtain a single hazard ratio</strong> comparing those groups.</p>
</div>
</div>
</section>
<section id="example-handling-non-proportional-hazards-using-stratified-cox-model" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="example-handling-non-proportional-hazards-using-stratified-cox-model"><span class="header-section-number">5</span> Example: Handling Non-Proportional Hazards Using Stratified Cox Model</h2>
<p>We are interested in whether time to graft failure after kidney transplantation differs by donor type (living vs deceased), after adjusting for important clinical factors.</p>
<p>We begin by fitting a standard Cox proportional hazards model, then check the PH assumption. If the PH assumption is violated for any categorical covariate in the model, we refit the model using stratification by that covariate.</p>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>stratified_kidney_data<span class="ot">&lt;-</span><span class="fu">read.csv</span>(<span class="st">"stratified_kidney_data.CSV"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>cox_standard <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> donor_type <span class="sc">+</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    donor_age <span class="sc">+</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    recipient_gender <span class="sc">+</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    egfr_baseline,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stratified_kidney_data</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(cox_standard)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">#check the PH assumption first </span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>ph_test <span class="ot">&lt;-</span> <span class="fu">cox.zph</span>(cox_standard)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>ph_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                  chisq df       p
donor_type       28.127  1 1.1e-07
donor_age         0.118  1    0.73
recipient_gender  1.156  1    0.28
egfr_baseline     1.498  1    0.22
GLOBAL           30.955  4 3.1e-06</code></pre>
</div>
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ph_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-2-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-2-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-2-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A small p-value indicates evidence against the proportional hazards assumption.</p>
</div>
</div>
<p><strong>Interpretation of PH diagnostics</strong></p>
<p>The proportional hazards assumption is violated for donor type.<br>
Other covariates do not show strong evidence of violation.<br>
The global test is significant, indicating overall non-proportionality.<br>
This suggests that the effect of donor type on graft failure risk changes over time, making the standard Cox model inappropriate.</p>
<p><strong>Stratified Cox model</strong></p>
<p>To address this violation, we fit a stratified Cox model, stratifying on donor type.</p>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>cox_strat <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Surv</span>(time, status) <span class="sc">~</span> donor_age <span class="sc">+</span> recipient_gender <span class="sc">+</span> egfr_baseline <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">strata</span>(donor_type),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">data =</span> stratified_kidney_data</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_strat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ donor_age + recipient_gender + 
    egfr_baseline + strata(donor_type), data = stratified_kidney_data)

  n= 400, number of events= 171 

                          coef exp(coef)  se(coef)      z Pr(&gt;|z|)   
donor_age             0.011126  1.011188  0.007488  1.486  0.13735   
recipient_gendermale  0.454309  1.575084  0.154436  2.942  0.00326 **
egfr_baseline        -0.014757  0.985351  0.006905 -2.137  0.03258 * 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                     exp(coef) exp(-coef) lower .95 upper .95
donor_age               1.0112     0.9889    0.9965    1.0261
recipient_gendermale    1.5751     0.6349    1.1637    2.1319
egfr_baseline           0.9854     1.0149    0.9721    0.9988

Concordance= 0.574  (se = 0.023 )
Likelihood ratio test= 14.83  on 3 df,   p=0.002
Wald test            = 14.66  on 3 df,   p=0.002
Score (logrank) test = 14.83  on 3 df,   p=0.002</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>We no longer estimate a hazard ratio for donor type.</p></li>
<li><p>Donor type is now used only to define separate baseline hazards.</p></li>
<li><p>Effects of other covariates are assumed proportional within each stratum.</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Within each donor type (living and deceased), we interpret covariate effects as follows:</p>
<p>‚úÖ Donor age</p>
<p>HR ‚âà 1.01 (95% CI: 0.997‚Äì1.03, P-value=0.14), Not statistically significant.<br>
Within each donor type, donor age shows no strong association with graft failure.</p>
<p>‚úÖ Recipient gender (male)</p>
<p>HR ‚âà 1.58 (95% CI: 1.16‚Äì2.13, P-value=0.003), Statistically significant. Male recipients have about 58% higher hazard of graft failure compared to females This comparison is within donor type, adjusting for donor age and eGFR.</p>
<p>‚úÖ eGFR at transplant</p>
<p>HR ‚âà 0.99 (95% CI: 0.97‚Äì1.00, P-value=0.033), Statistically significant. Each 1-unit increase in baseline eGFR is associated with about 1‚Äì2% lower hazard of graft failure, within each donor type. To improve interpretability, we can express the effect per <strong>10-unit increase</strong> in eGFR:</p>
<p><span class="math display">\[
HR_{10\text{-unit}} = 0.99^{10} \approx 0.90
\]</span></p>
<p><strong>Interpretation:</strong><br>
Within each donor type, a 10-unit higher eGFR at the time of transplant is associated with approximately a <strong>10% lower hazard of graft failure</strong>, after adjusting for donor age and recipient gender.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What about donor type?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Stratifying by donor type allows each group to have its own baseline hazard curve, effectively removing the need to assume a constant hazard ratio over time.</p>
<p>The curves demonstrate that living and deceased donor grafts follow different survival trajectories ‚Äî exactly what we expect when the PH assumption is violated.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cox_strat is the stratified cox model we fitted in previous chunk </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>sf_strat <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_strat)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert survfit to a tidy data frame for ggplot</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>sf_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">time  =</span> sf_strat<span class="sc">$</span>time,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv  =</span> sf_strat<span class="sc">$</span>surv,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> sf_strat<span class="sc">$</span>lower,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> sf_strat<span class="sc">$</span>upper,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">strata =</span> <span class="fu">rep</span>(<span class="fu">names</span>(sf_strat<span class="sc">$</span>strata), sf_strat<span class="sc">$</span>strata)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up the stratum labels from "donor_type=deceased" ‚Üí "deceased"</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>sf_df<span class="sc">$</span>strata <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"donor_type="</span>, <span class="st">""</span>, sf_df<span class="sc">$</span>strata)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>stratified_cox_plot<span class="ot">&lt;-</span><span class="fu">ggplot</span>(sf_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> surv, <span class="at">colour =</span> strata)) <span class="sc">+</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper, <span class="at">fill =</span> strata),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"deceased"</span> <span class="ot">=</span> <span class="st">"#365abd"</span>,  <span class="co"># deep blue</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"living"</span>   <span class="ot">=</span> <span class="st">"#c0397e"</span>))<span class="sc">+</span> <span class="co"># magenta/rose</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"deceased"</span> <span class="ot">=</span> <span class="st">"#365abd"</span>,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"living"</span>   <span class="ot">=</span> <span class="st">"#c0397e"</span>)) <span class="sc">+</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Stratified Cox Model</span><span class="sc">\n</span><span class="st">Different Baseline Hazards by Donor Type"</span>,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time since transplant (years)"</span>,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted survival probability"</span>,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"Donor type"</span>,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill   =</span> <span class="st">"Donor type"</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title       =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position  =</span> <span class="st">"bottom"</span>,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title     =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>stratified_cox_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Ignoring PH Violations Can Be Misleading
</div>
</div>
<div class="callout-body-container callout-body">
<p>If we ignore the violation of the proportional hazards (PH) assumption and proceed with a standard Cox model, we may obtain a single hazard ratio that does <strong>not accurately reflect how risk changes over time</strong>.</p>
<p>This can lead to misleading conclusions, as the estimated effect represents an average over follow-up rather than the true time-varying relationship.</p>
<p>This is illustrated in the plot below, where the separation between groups is clearly <strong>not constant over time</strong>.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#data preparation for plot </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>new_deceased <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_type =</span> <span class="fu">factor</span>(<span class="st">"deceased"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(stratified_kidney_data<span class="sc">$</span>donor_type))),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_age =</span> <span class="fu">mean</span>(stratified_kidney_data<span class="sc">$</span>donor_age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_gender =</span> <span class="fu">factor</span>(<span class="st">"female"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(stratified_kidney_data<span class="sc">$</span>recipient_gender))),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">egfr_baseline =</span> <span class="fu">mean</span>(stratified_kidney_data<span class="sc">$</span>egfr_baseline, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>new_living <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_type =</span> <span class="fu">factor</span>(<span class="st">"living"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(stratified_kidney_data<span class="sc">$</span>donor_type))),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_age =</span> <span class="fu">mean</span>(stratified_kidney_data<span class="sc">$</span>donor_age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_gender =</span> <span class="fu">factor</span>(<span class="st">"female"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(stratified_kidney_data<span class="sc">$</span>recipient_gender))),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">egfr_baseline =</span> <span class="fu">mean</span>(stratified_kidney_data<span class="sc">$</span>egfr_baseline, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>sf_deceased <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_standard, <span class="at">newdata =</span> new_deceased)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>sf_living   <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_standard, <span class="at">newdata =</span> new_living)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>df_dec <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">time       =</span> sf_deceased<span class="sc">$</span>time,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv       =</span> sf_deceased<span class="sc">$</span>surv,</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower      =</span> sf_deceased<span class="sc">$</span>lower,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper      =</span> sf_deceased<span class="sc">$</span>upper,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_type =</span> <span class="st">"Deceased donor"</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>df_liv <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">time       =</span> sf_living<span class="sc">$</span>time,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv       =</span> sf_living<span class="sc">$</span>surv,</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower      =</span> sf_living<span class="sc">$</span>lower,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper      =</span> sf_living<span class="sc">$</span>upper,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_type =</span> <span class="st">"Living donor"</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>df_ph <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df_dec, df_liv)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>standard_cox_plot<span class="ot">&lt;-</span><span class="fu">ggplot</span>(df_ph, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> surv, <span class="at">colour =</span> donor_type, <span class="at">fill =</span> donor_type)) <span class="sc">+</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CI ribbon</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>,</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>              <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>              <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step survival curve</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Manual colours for consistency across slides</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Deceased donor"</span> <span class="ot">=</span> <span class="st">"#365abd"</span>,   <span class="co"># blue</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Living donor"</span>   <span class="ot">=</span> <span class="st">"#c0397e"</span>)   <span class="co"># magenta/rose</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Deceased donor"</span> <span class="ot">=</span> <span class="st">"#365abd"</span>,</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Living donor"</span>   <span class="ot">=</span> <span class="st">"#c0397e"</span>)</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Axis labels and title</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Standard Cox PH Model</span><span class="sc">\n</span><span class="st">Assumes Constant Effect of Donor Type"</span>,</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time since transplant (years)"</span>,</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted survival probability"</span>,</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"Donor type"</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y-axis from 0.4 to 1.0</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">1.0</span>)) <span class="sc">+</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use grey theme with gridlines</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title       =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position  =</span> <span class="st">"bottom"</span>,</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title     =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Reduce title size for each plot</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>standard_cox_plot_small <span class="ot">&lt;-</span> standard_cox_plot <span class="sc">+</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>stratified_cox_plot_small <span class="ot">&lt;-</span> stratified_cox_plot <span class="sc">+</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrange side by side</span></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>  standard_cox_plot_small,</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>  stratified_cox_plot_small,</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="including-time-varying-effects" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="including-time-varying-effects"><span class="header-section-number">6</span> Including Time-Varying Effects</h2>
<p>When the proportional hazards (PH) assumption is violated, <strong>stratification is not the only solution</strong>.</p>
<p>In some settings, we still want to:</p>
<ul>
<li><strong>Keep the covariate in the model</strong></li>
<li><strong>Obtain an explicit effect estimate</strong></li>
<li><strong>Allow the effect to change over time</strong></li>
</ul>
<p>This leads to a <strong>time-varying coefficient Cox model</strong>.</p>
<p><strong>When to Use Time-Varying Effects</strong></p>
<p>Use a time-varying effect when:</p>
<ul>
<li>The PH assumption is violated for a variable (e.g.&nbsp;<strong>donor type</strong>)</li>
<li>The variable is scientifically important</li>
<li>You believe the <strong>effect itself changes over time</strong></li>
</ul>
<p>For example:</p>
<ul>
<li>Early after transplant, <strong>living donors may be protective</strong></li>
<li>Later, that advantage may <strong>diminish or reverse</strong></li>
</ul>
<p><strong>Model Idea</strong></p>
<p>In the <strong>standard Cox model</strong>:</p>
<p><span class="math display">\[
h(t \mid X) = h_0(t)\exp(\beta_1 X_1 + \beta_2 X_2 + \cdots)
\]</span></p>
<p>the coefficients (<span class="math inline">\(\beta\)</span>) are assumed to be <strong>constant over time</strong>, which leads to the <strong>proportional hazards (PH) assumption</strong>.</p>
<p>If a covariate‚Äôs effect <strong>changes over time</strong>, we can allow its coefficient to depend on time:</p>
<p><span class="math display">\[
h(t \mid X) = h_0(t)\exp\left(\beta_1(t) X_1 + \beta_2 X_2 + \cdots\right)
\]</span></p>
<p>This allows the <strong>hazard ratio for <span class="math inline">\(X_1\)</span> to vary with time</strong>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Intuition
</div>
</div>
<div class="callout-body-container callout-body">
<p>Instead of assuming the two groups keep the same relative risk forever,<br>
we allow the <strong>risk difference between groups to change over time</strong>.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
When to Use It
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>You detect a <strong>proportional hazards (PH) violation</strong> for a variable (e.g.&nbsp;<strong>donor type</strong>) but you <strong>still want an explicit effect estimate</strong>, rather than stratifying it away.</li>
<li>For example:
<ul>
<li><strong>Early after transplant</strong>, living donors may be <strong>protective</strong></li>
<li><strong>Later</strong>, that advantage may <strong>diminish or reverse</strong></li>
</ul></li>
</ul>
</div>
</div>
</section>
<section id="example-time-varying-effect-of-donor-type" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="example-time-varying-effect-of-donor-type"><span class="header-section-number">7</span> Example: Time-Varying Effect of Donor Type</h2>
<p>We return to the kidney transplant example:</p>
<ul>
<li><strong>Outcome:</strong> time to graft failure<br>
</li>
<li><strong>Exposure:</strong> donor type (living vs deceased)<br>
</li>
<li><strong>Covariates:</strong> donor age, recipient gender, baseline eGFR</li>
</ul>
<p>Previously, we showed that <strong>donor type violates the PH assumption</strong>.</p>
<p>We introduce an <strong>interaction between the covariate and time</strong>, most commonly:</p>
<ul>
<li><strong>donor type √ó log(time)</strong><br>
</li>
<li><strong>donor type √ó time</strong></li>
</ul>
<p>This allows the model to estimate <strong>how the effect changes with time</strong>.</p>
<p>The Cox model becomes:</p>
<p><span class="math display">\[
h(t) = h_0(t)\exp\left[\beta_1 \,\text{donor\_type} + \beta_2 \left(\text{donor\_type} \times \log(t)\right) + \cdots \right]
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(\beta_1\)</span> represents the <strong>baseline (early) effect</strong> of donor type<br>
</li>
<li><span class="math inline">\(\beta_2\)</span> represents <strong>how that effect changes over time</strong></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>kidney_violate <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"stratified_kidney_data.csv"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>kidney_violate<span class="sc">$</span>donor_live <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(kidney_violate<span class="sc">$</span>donor_type <span class="sc">==</span> <span class="st">"living"</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>cox_timevary <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> donor_live <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    donor_age <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    recipient_gender <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    egfr_baseline <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tt</span>(donor_live),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> kidney_violate,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) {</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">*</span> <span class="fu">log</span>(t <span class="sc">+</span> <span class="fl">0.01</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_timevary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ donor_live + donor_age + 
    recipient_gender + egfr_baseline + tt(donor_live), data = kidney_violate, 
    tt = function(x, t, ...) {
        x * log(t + 0.01)
    })

  n= 400, number of events= 171 

                          coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
donor_live           -0.693440  0.499853  0.360232 -1.925  0.05423 .  
donor_age             0.011064  1.011126  0.007485  1.478  0.13935    
recipient_gendermale  0.455043  1.576241  0.154407  2.947  0.00321 ** 
egfr_baseline        -0.014874  0.985236  0.006917 -2.150  0.03152 *  
tt(donor_live)        1.261201  3.529659  0.252705  4.991 6.01e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                     exp(coef) exp(-coef) lower .95 upper .95
donor_live              0.4999     2.0006    0.2467    1.0127
donor_age               1.0111     0.9890    0.9964    1.0261
recipient_gendermale    1.5762     0.6344    1.1646    2.1333
egfr_baseline           0.9852     1.0150    0.9720    0.9987
tt(donor_live)          3.5297     0.2833    2.1509    5.7921

Concordance= 0.681  (se = 0.02 )
Likelihood ratio test= 77.42  on 5 df,   p=3e-15
Wald test            = 64.54  on 5 df,   p=1e-12
Score (logrank) test = 75.7  on 5 df,   p=7e-15</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>donor_live represents the baseline effect</p></li>
<li><p>tt(donor_live) allows the effect to change with time</p></li>
<li><p><span class="math inline">\(\log(t)\)</span> captures gradual, nonlinear change<br>
</p></li>
</ul>
</div>
</div>
<p><strong>Visualising the Time-Varying Hazard Ratio</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">coef</span>(cox_timevary)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">vcov</span>(cox_timevary)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>beta1 <span class="ot">&lt;-</span> b[<span class="st">"donor_live"</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>beta2 <span class="ot">&lt;-</span> b[<span class="st">"tt(donor_live)"</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>var_beta1 <span class="ot">&lt;-</span> v[<span class="st">"donor_live"</span>, <span class="st">"donor_live"</span>]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>var_beta2 <span class="ot">&lt;-</span> v[<span class="st">"tt(donor_live)"</span>, <span class="st">"tt(donor_live)"</span>]</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>cov_b1b2  <span class="ot">&lt;-</span> v[<span class="st">"donor_live"</span>, <span class="st">"tt(donor_live)"</span>]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>t_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.5</span>, <span class="dv">8</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>log_t <span class="ot">&lt;-</span> <span class="fu">log</span>(t_seq <span class="sc">+</span> <span class="fl">0.01</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>lp <span class="ot">&lt;-</span> beta1 <span class="sc">+</span> beta2 <span class="sc">*</span> log_t</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>var_lp <span class="ot">&lt;-</span> var_beta1 <span class="sc">+</span> (log_t<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> var_beta2 <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> log_t <span class="sc">*</span> cov_b1b2</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>se_lp <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(var_lp)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>hr_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">time  =</span> t_seq,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">HR    =</span> <span class="fu">exp</span>(lp),</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">exp</span>(lp <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_lp),</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">exp</span>(lp <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_lp)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hr_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> HR)) <span class="sc">+</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"#c75b87"</span>) <span class="sc">+</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">colour =</span> <span class="st">"#c75b87"</span>) <span class="sc">+</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Time-varying effect of donor type"</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Hazard ratio: living vs deceased donor"</span>,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time since transplant (years)"</span>,</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Hazard ratio"</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
</div>
<div class="callout-body-container callout-body">
<p>We interpret the results of the <strong>time-varying coefficient Cox model</strong> as follows:</p>
<p>‚úÖ <strong>Donor type (living vs deceased) ‚Äî baseline effect</strong></p>
<p>HR ‚âà 0.50 (95% CI: 0.25‚Äì1.01, P-value ‚âà 0.05).<br>
At the <strong>start of follow-up</strong> (when <span class="math inline">\(\log(t) \approx 0\)</span>), recipients of a <strong>living donor</strong> kidney have about a <strong>50% lower hazard</strong> of graft failure compared to recipients of deceased-donor kidneys.</p>
<p>This represents the <strong>early effect</strong> of donor type.</p>
<hr>
<p>‚úÖ <strong>Time-varying effect of donor type</strong> (<code>tt(donor_live)</code>)</p>
<p>HR ‚âà 3.53 (95% CI: 2.15‚Äì5.79, P-value &lt; 0.001), <strong>Statistically significant</strong>.<br>
The effect of <strong>living donor changes significantly over time</strong>.<br>
For each one-unit increase in <span class="math inline">\(\log(t)\)</span>, the hazard ratio increases by a factor of about <strong>3.5</strong>.</p>
<p><strong>Interpretation:</strong><br>
The early protective effect of living donation <strong>diminishes as time goes on</strong>, explaining why a single constant hazard ratio would be misleading.</p>
<hr>
<p>‚úÖ <strong>Donor age</strong></p>
<p>HR ‚âà 1.01 (95% CI: 1.00‚Äì1.03, P-value = 0.14), <strong>Not statistically significant</strong>.<br>
Donor age shows a small, non-significant trend toward higher hazard of graft failure.</p>
<hr>
<p>‚úÖ <strong>Recipient gender (male vs female)</strong></p>
<p>HR ‚âà 1.58 (95% CI: 1.16‚Äì2.13, P-value = 0.003), <strong>Statistically significant</strong>.<br>
Male recipients have about a <strong>58% higher hazard</strong> of graft failure compared to females, adjusting for donor age, donor type, and baseline eGFR.</p>
<hr>
<p>‚úÖ <strong>Baseline eGFR</strong></p>
<p>HR ‚âà 0.99 (95% CI: 0.97‚Äì1.00, P-value = 0.032), <strong>Statistically significant</strong>.<br>
Each 1-unit increase in baseline eGFR is associated with about a <strong>1‚Äì2% lower hazard</strong> of graft failure.</p>
<p>To improve interpretability, we can express the effect per <strong>10-unit increase</strong> in eGFR:</p>
<p><span class="math display">\[
HR_{10\text{-unit}} = 0.99^{10} \approx 0.90
\]</span></p>
<p><strong>Interpretation:</strong><br>
Within donor type, a 10-unit higher baseline eGFR at transplant is associated with approximately a <strong>10% lower hazard of graft failure</strong>, after adjusting for other covariates.</p>
<hr>
<p><strong>Overall interpretation:</strong><br>
The time-varying Cox model shows that the <strong>effect of donor type is strongest early after transplant and weakens over time</strong>, while recipient gender and baseline kidney function remain important predictors of graft failure.</p>
<p>Early follow-up: HR &lt; 1 ‚Üí protective effect of living donors</p>
<p>Later follow-up: HR increases and may exceed 1</p>
<p>Uncertainty increases at longer follow-up due to fewer events</p>
<p>The HR steadily increases and crosses 1 after roughly 1‚Äì2 years, indicating the early survival advantage of living donors diminishes.</p>
<p>By 5‚Äì8 years, the HR &gt; 2‚Äì3, suggesting higher hazard among living-donor grafts in the later period.</p>
<p>The confidence band widens with time because there are fewer events and greater uncertainty at longer follow-up.</p>
</div>
</div>
</section>
<section id="extended-cox-model" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="extended-cox-model"><span class="header-section-number">8</span> Extended Cox Model</h2>
<p>Before introducing the <strong>extended Cox model</strong>, it is important to distinguish between <strong>time-fixed covariates</strong> and <strong>time-varying covariates</strong>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Time-Fixed vs Time-Varying Covariates
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Time-Fixed Covariates:</strong></p>
<p>A <strong>time-fixed covariate</strong> is measured once (usually at baseline) and assumed to remain constant throughout follow-up.</p>
<p>Examples:</p>
<ul>
<li><strong>Donor type</strong></li>
<li><strong>Sex</strong></li>
<li><strong>Age at transplant</strong></li>
<li><strong>Baseline eGFR</strong></li>
</ul>
<p><strong>Time-Varying Covariates:</strong></p>
<p>A <strong>time-varying covariate</strong> is a variable whose <strong>value itself changes over time</strong>.</p>
<p>Examples:</p>
<ul>
<li><strong>eGFR measured repeatedly after transplant</strong></li>
<li><strong>Blood pressure</strong></li>
<li><strong>Medication use</strong></li>
<li><strong>Biomarkers measured at follow-up visits</strong></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Time-varying covariates are different from <strong>time-varying effects</strong>.</p>
<ul>
<li><strong>Time-varying effect:</strong> the <em>coefficient</em> changes with time<br>
</li>
<li><strong>Time-varying covariate:</strong> the <em>value of the covariate</em> changes with time</li>
</ul>
</div>
</div>
<p><strong>Why Time-Varying Covariates Can Cause PH Violation</strong></p>
<p>If we treat a changing covariate as fixed at baseline:</p>
<ul>
<li>We ignore important changes in a patient‚Äôs risk profile</li>
<li>The model may show <strong>non-proportional hazards</strong></li>
<li>Early and late risks are incorrectly averaged</li>
</ul>
<p>For example:</p>
<ul>
<li>eGFR at transplant may be similar between patients</li>
<li>Over time, eGFR may decline at different rates</li>
<li>Current kidney function is more relevant than baseline eGFR</li>
</ul>
<p><strong>Extended Cox Model (Time-Varying Covariates)</strong></p>
<p>The <strong>extended Cox model</strong> explicitly allows covariate values to change over time.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Intuition
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Split each subject‚Äôs follow-up into <strong>time intervals</strong></li>
<li>Update the covariate value within each interval</li>
<li>Model the hazard using the <strong>current covariate value</strong></li>
</ul>
<p><strong>Why this addresses PH violation:</strong></p>
<ul>
<li>PH was violated partly because ‚Äúrisk profile changes over time.‚Äù<br>
</li>
<li>The extended Cox model explicitly updates the covariates over time instead of pretending they‚Äôre frozen at baseline.<br>
</li>
<li>This is different from stratification and different from adding x √ó time: here the value itself is time-dependent.<br>
</li>
</ul>
</div>
</div>
<p>The model is written as:</p>
<p><span class="math display">\[
h(t \mid X(t)) = h_0(t)\exp\left(\beta_1 X_1(t) + \beta_2 X_2 + \cdots\right)
\]</span></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
When to Use It
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>A predictor <strong>changes over time</strong></li>
<li>The <strong>current value</strong> of the predictor matters for risk <em>right now</em></li>
<li>Treating the variable as baseline-only is unrealistic</li>
</ul>
<p>Examples:</p>
<ul>
<li>‚ÄúeGFR at year 2 predicts risk between year 2 and 3‚Äù</li>
<li>‚ÄúIf eGFR worsens, the risk of graft failure increases after that‚Äù</li>
</ul>
</div>
</div>
</section>
<section id="example-extended-cox-model-time-varying-covariates" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="example-extended-cox-model-time-varying-covariates"><span class="header-section-number">9</span> Example: Extended Cox Model (Time-Varying Covariates)</h2>
<p>This example demonstrates how to fit an <strong>extended Cox model</strong> when a covariate (e.g.&nbsp;<strong>eGFR</strong>) <strong>changes over time</strong>.</p>
<p>We create a dataset in <strong>start‚Äìstop format</strong>, where each individual contributes multiple time intervals.</p>
<p>For each interval we record:</p>
<ul>
<li><strong>start:</strong> beginning of the time interval<br>
</li>
<li><strong>stop:</strong> end of the time interval<br>
</li>
<li><strong>status:</strong> did graft failure occur at <code>stop</code><br>
</li>
<li><strong>egfr_current:</strong> eGFR measured at the <strong>start of that interval</strong></li>
</ul>
<p>The extended Cox model uses the <strong>current value</strong> of the covariate:</p>
<p><span class="math display">\[
h(t) = h_0(t)\exp\left(\beta_1 \,\text{egfr\_current}(t)
+ \beta_2 \,\text{donor\_type}
+ \cdots \right)
\]</span></p>
<p>Here:</p>
<ul>
<li><strong>egfr_current(t)</strong> is updated over time<br>
</li>
<li>The hazard reflects the patient‚Äôs <strong>current kidney function</strong>, not baseline values</li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Data Structure: Wide vs Long Format
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Wide (Baseline-Only) Format</strong></p>
<p>Each subject has <strong>one row</strong>, with multiple eGFR measurements stored in columns.</p>
<ul>
<li><code>egfr0</code>, <code>egfr2</code>, <code>egfr4</code>, <code>egfr6</code> represent measurements at fixed times<br>
</li>
<li>This format is <strong>not suitable</strong> for extended Cox models</li>
</ul>
<p><strong>Long (Start‚ÄìStop) Format</strong></p>
<p>Each subject contributes <strong>multiple rows</strong>, one per interval.</p>
<p>Key columns:</p>
<ul>
<li><strong>id</strong></li>
<li><strong>start</strong></li>
<li><strong>stop</strong></li>
<li><strong>status</strong></li>
<li><strong>egfr_current</strong></li>
<li><strong>baseline covariates</strong> (donor type, age, sex)</li>
</ul>
<p>This format allows the model to use the <strong>current eGFR</strong> at each time interval.</p>
</div>
</div>
<p><strong>Change of eGFR over time by donor type</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----plot egfr change over time </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>long_data<span class="ot">&lt;-</span><span class="fu">read.csv</span>(<span class="st">"egfr_long_data.CSV"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute mean ¬± SE by donor type and start time</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>egfr_summary <span class="ot">&lt;-</span> long_data <span class="sc">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(donor_type, start) <span class="sc">%&gt;%</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_egfr =</span> <span class="fu">mean</span>(egfr_current, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">se_egfr   =</span> <span class="fu">sd</span>(egfr_current, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">n</span>())</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(egfr_summary, <span class="fu">aes</span>(<span class="at">x =</span> start, <span class="at">y =</span> mean_egfr,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">colour =</span> donor_type, <span class="at">group =</span> donor_type)) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span>     <span class="co"># changed from size ‚Üí linewidth</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean_egfr <span class="sc">-</span> se_egfr,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> mean_egfr <span class="sc">+</span> se_egfr,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> donor_type),</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"deceased"</span> <span class="ot">=</span> <span class="st">"#377eb8"</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"living"</span>   <span class="ot">=</span> <span class="st">"#e41a1c"</span>)) <span class="sc">+</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"deceased"</span> <span class="ot">=</span> <span class="st">"#377eb8"</span>,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"living"</span>   <span class="ot">=</span> <span class="st">"#e41a1c"</span>)) <span class="sc">+</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title  =</span> <span class="st">"Average eGFR trajectory over time by donor type"</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x      =</span> <span class="st">"Years since transplant"</span>,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y      =</span> <span class="st">"Mean eGFR (mL/min/1.73m¬≤)"</span>,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"Donor type"</span>,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill   =</span> <span class="st">"Donor type"</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"grey90"</span>),</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title       =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Fitting the Extended Cox Model</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>long_data<span class="ot">&lt;-</span><span class="fu">read.csv</span>(<span class="st">"egfr_long_data.CSV"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>cox_extended <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(start, stop, status) <span class="sc">~</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    egfr_current <span class="sc">+</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    donor_type <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    donor_age <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    recipient_gender,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> long_data</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_extended)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(start, stop, status) ~ egfr_current + donor_type + 
    donor_age + recipient_gender, data = long_data)

  n= 984, number of events= 13 

                         coef exp(coef) se(coef)      z Pr(&gt;|z|)   
egfr_current         -0.08300   0.92035  0.03222 -2.576    0.010 **
donor_typeliving      0.24888   1.28259  0.85365  0.292    0.771   
donor_age             0.02599   1.02633  0.03043  0.854    0.393   
recipient_gendermale  0.31097   1.36475  0.56113  0.554    0.579   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                     exp(coef) exp(-coef) lower .95 upper .95
egfr_current            0.9204     1.0865    0.8640    0.9803
donor_typeliving        1.2826     0.7797    0.2407    6.8346
donor_age               1.0263     0.9743    0.9669    1.0894
recipient_gendermale    1.3648     0.7327    0.4544    4.0991

Concordance= 0.756  (se = 0.074 )
Likelihood ratio test= 12.1  on 4 df,   p=0.02
Wald test            = 9.91  on 4 df,   p=0.04
Score (logrank) test = 10.88  on 4 df,   p=0.03</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
</div>
<div class="callout-body-container callout-body">
<p>We interpret the results of the <strong>extended Cox model (time-varying covariates)</strong> as follows:</p>
<p>‚úÖ <strong>Current eGFR</strong></p>
<p>HR ‚âà 0.92 (95% CI: 0.86‚Äì0.98, P-value = 0.01), <strong>Statistically significant</strong>.<br>
Each 1 mL/min/1.73 m¬≤ higher <strong>current eGFR</strong> is associated with about an <strong>8% lower instantaneous hazard</strong> of graft failure, holding donor type, donor age, and recipient gender constant.</p>
<p>This means that <strong>the patient‚Äôs current kidney function</strong>, rather than baseline eGFR, is strongly predictive of graft failure risk.</p>
<hr>
<p>‚úÖ <strong>Donor type (living vs deceased)</strong></p>
<p>HR ‚âà 1.28 (95% CI: 0.24‚Äì6.83, P-value = 0.77), <strong>Not statistically significant</strong>.<br>
Once <strong>time-updated eGFR</strong> is included in the model, there is <strong>no evidence of a direct effect</strong> of donor type on graft failure.</p>
<p><strong>Interpretation:</strong><br>
The apparent advantage of living donors observed earlier appears to operate <strong>through better kidney function over time</strong>, rather than through an independent direct effect.</p>
<hr>
<p>‚úÖ <strong>Donor age</strong></p>
<p>HR ‚âà 1.03 (95% CI: 0.97‚Äì1.09, P-value = 0.39), <strong>Not statistically significant</strong>.<br>
There is no strong evidence that donor age is associated with graft failure once current eGFR and other covariates are accounted for.</p>
<hr>
<p>‚úÖ <strong>Recipient gender (male vs female)</strong></p>
<p>HR ‚âà 1.36 (95% CI: 0.45‚Äì4.10, P-value = 0.58), <strong>Not statistically significant</strong>.<br>
After adjusting for time-updated eGFR and other covariates, there is no clear evidence of a gender difference in graft failure risk.</p>
<hr>
<p><strong>Overall interpretation:</strong><br>
The extended Cox model highlights that <strong>time-updated eGFR is the dominant predictor of graft failure</strong>.<br>
Accounting for changes in kidney function over time substantially alters the interpretation of other covariate effects and provides a more realistic representation of evolving risk.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show R code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose fixed values (you can edit if you prefer):</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>ref_donor_type      <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="st">"deceased"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(long_data<span class="sc">$</span>donor_type)))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>ref_donor_age       <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>ref_recipient_sex   <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="st">"female"</span>, <span class="at">levels =</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(long_data<span class="sc">$</span>recipient_gender)))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>new_e30 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">start =</span> <span class="dv">0</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">stop =</span> <span class="dv">1</span>,  <span class="co"># dummy, survfit won't use start/stop here</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">status =</span> <span class="dv">0</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">egfr_current =</span> <span class="dv">30</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_type =</span> ref_donor_type,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">donor_age =</span> ref_donor_age,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_gender =</span> ref_recipient_sex</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>new_e60 <span class="ot">&lt;-</span> new_e30; new_e60<span class="sc">$</span>egfr_current <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>new_e90 <span class="ot">&lt;-</span> new_e30; new_e90<span class="sc">$</span>egfr_current <span class="ot">&lt;-</span> <span class="dv">90</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>sf_e30 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_extended, <span class="at">newdata =</span> new_e30)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>sf_e60 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_extended, <span class="at">newdata =</span> new_e60)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>sf_e90 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_extended, <span class="at">newdata =</span> new_e90)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>df_e30 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">time  =</span> sf_e30<span class="sc">$</span>time,</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv  =</span> sf_e30<span class="sc">$</span>surv,</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> sf_e30<span class="sc">$</span>lower,</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> sf_e30<span class="sc">$</span>upper,</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">egfr_label =</span> <span class="st">"eGFR = 30"</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>df_e60 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">time  =</span> sf_e60<span class="sc">$</span>time,</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv  =</span> sf_e60<span class="sc">$</span>surv,</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> sf_e60<span class="sc">$</span>lower,</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> sf_e60<span class="sc">$</span>upper,</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">egfr_label =</span> <span class="st">"eGFR = 60"</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>df_e90 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">time  =</span> sf_e90<span class="sc">$</span>time,</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv  =</span> sf_e90<span class="sc">$</span>surv,</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> sf_e90<span class="sc">$</span>lower,</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> sf_e90<span class="sc">$</span>upper,</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">egfr_label =</span> <span class="st">"eGFR = 90"</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>surv_plot_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(df_e30, df_e60, df_e90)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(surv_plot_df,</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> time,</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> surv,</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>           <span class="at">colour =</span> egfr_label,</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill   =</span> egfr_label)) <span class="sc">+</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># confidence band</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.18</span>,</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">0</span>,</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>              <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># survival curve (step)</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>      <span class="st">"eGFR = 30"</span> <span class="ot">=</span> <span class="st">"#d7301f"</span>,  <span class="co"># dark-ish red / high risk</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>      <span class="st">"eGFR = 60"</span> <span class="ot">=</span> <span class="st">"#fc8d59"</span>,  <span class="co"># orange</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>      <span class="st">"eGFR = 90"</span> <span class="ot">=</span> <span class="st">"#1a9850"</span>   <span class="co"># green / low risk</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>      <span class="st">"eGFR = 30"</span> <span class="ot">=</span> <span class="st">"#d7301f"</span>,</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>      <span class="st">"eGFR = 60"</span> <span class="ot">=</span> <span class="st">"#fc8d59"</span>,</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>      <span class="st">"eGFR = 90"</span> <span class="ot">=</span> <span class="st">"#1a9850"</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted graft survival under different kidney function levels"</span>,</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Extended Cox model with time-updated eGFR"</span>,</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time since transplant (years)"</span>,</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"Assumed current eGFR"</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.72</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title    =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span> <span class="fu">theme</span>(</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">face =</span> <span class="st">"bold"</span>,</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">12</span>,</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">6</span>)   <span class="co"># space below title</span></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">11</span>,</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>      <span class="at">hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">8</span>)</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lecture-03-non-ph-cox_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation of Predicted Survival by Current eGFR Level
</div>
</div>
<div class="callout-body-container callout-body">
<p>The extended Cox model allows us to interpret graft survival <strong>conditional on the current level of kidney function</strong>, updated over time.</p>
<hr>
<p>‚úÖ <strong>eGFR = 90 (green)</strong></p>
<p>Predicted graft survival is <strong>very stable over time</strong>.<br>
The survival curve remains close to <strong>1.0</strong>, indicating that patients maintaining this level of kidney function have a <strong>very low risk of graft failure</strong> throughout follow-up.</p>
<hr>
<p>‚úÖ <strong>eGFR = 60 (orange)</strong></p>
<p>Graft survival remains <strong>high</strong>, although slightly lower than at eGFR = 90.<br>
The probability of graft survival stays above <strong>95% over 8 years</strong>, suggesting a <strong>modest increase in risk</strong>, but overall good long-term outcomes.</p>
<hr>
<p>‚úÖ <strong>eGFR = 30 (red)</strong></p>
<p>Graft survival is <strong>markedly reduced</strong>.<br>
The survival curve declines more steeply, showing a <strong>pronounced increase in the risk of graft loss over time</strong>.<br>
This highlights low current eGFR as a <strong>strong indicator of poor prognosis</strong>.</p>
<hr>
<p><strong>Overall interpretation:</strong><br>
In the extended Cox model, <strong>current eGFR is a powerful, time-updated predictor of graft survival</strong>.<br>
Lower eGFR values are associated with <strong>substantially worse survival trajectories</strong>, reinforcing the importance of modelling kidney function as a <strong>time-varying covariate</strong> rather than a baseline-only measure.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The extended Cox model treats time-varying covariates as <strong>external</strong>.</p>
<p>If the covariate is influenced by the underlying disease process (e.g.&nbsp;declining eGFR because the graft is failing), this assumption may be violated.</p>
</div>
</div>
<div class="callout-question">
<p><strong>üß† Think about the following before moving on:</strong></p>
<p>What if the decline in eGFR over time reflects underlying changes in other clinical factors, rather than acting as an isolated predictor?</p>
<p>And those same variables may also affect the risk of graft failure.</p>
<p>If a time-dependent covariate both <strong>predicts</strong> the event and is <strong>affected by</strong> the underlying disease process, is an extended Cox model still appropriate?</p>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb15" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Lecture 3: Cox model when PH assumption is violated"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 3</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE}</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="in">  message = FALSE,</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="in">  warning = FALSE</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>By the end of this lecture, you should be able to:</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Recognise when the **proportional hazards (PH) assumption** is violated</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understand different strategies to handle non-PH:</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Stratified Cox model</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Time-varying effects</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Extended Cox with time-varying covariates</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understand when a **joint model** is needed</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reminder: Proportional Hazards Assumption</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>The Cox model assumes that **hazard ratios are constant over time**.</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>This means that if one group has higher risk than another at the beginning,</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>it has the same *relative* risk later in follow-up.</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>If this assumption does not hold, the estimated hazard ratio from a standard Cox model</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>may be misleading.</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="fu">## What If Proportional Hazards Does Not Hold?</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>There are several approaches when PH is violated:</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Stratified Cox model:** allow baseline hazards to differ by group.</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Include time-varying effect:** model changing effects over time, include interaction between covariate and time (e.g. $ùë•√óùë°$). </span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Use extended Cox model:** allow a covariate‚Äôs value itself to change over time.</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stratified Cox model</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>When the proportional hazards (PH) assumption is violated for a categorical variable, one option is a **stratified Cox model**.</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>A stratified Cox model can be written as:</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>h_s(t \mid X) = h_{0s}(t)\,\exp(\beta_1 X_1 + \beta_2 X_2 + \cdots)</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$s$ is the stratum (e.g. donor type)</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$h_{0s}(t)$ is the **baseline hazard for stratum $s$**</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$X_1, X_2, \ldots$ are other covariates</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a> **What does stratification mean?**  </span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>If we stratify on a variable (e.g. **donor type**):</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We **do not estimate a single hazard ratio** for the stratifying variable anymore  </span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>  (we are not saying ‚Äúliving vs deceased = HR 0.7‚Äù)</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The stratifying variable is used only to **define strata**</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each stratum is allowed to have a **different baseline risk trajectory** over time</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>In words:</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Patients with living donors and patients with deceased donors are allowed to have completely different baseline hazards over time.</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>**What is still estimated?**   </span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>We still estimate the effects of other covariates (e.g. donor age, recipient sex, eGFR at transplant), assuming those effects are **proportional within each stratum**.</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>Stratification is useful when a variable strongly affects baseline risk but does not satisfy the PH assumption.</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>Stratification can be thought of as:</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **‚ÄúParallel Cox models with different baseline hazards, but the same slopes for the other covariates.‚Äù**</span></span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>That is, each group has its own baseline risk over time, but covariate effects are assumed to be the same across groups.</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Use It</span></span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>‚úÖ  **When to use stratification**</span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>Use stratification when:</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The proportional hazards (PH) violation is mainly driven by **one categorical variable** (e.g. donor type)</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You still want to **adjust for this variable**</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>But you do **not need its hazard ratio** as a main result</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>In this case, the variable is used to define strata rather than being estimated as a coefficient.</span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>‚ùå **When not to use stratification**</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>Do **not** use stratification when:</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The stratifying variable is your **primary exposure of interest**</span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You need to report a **hazard ratio comparing groups**</span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>Because once you stratify on a variable (e.g. donor type), you **no longer obtain a single hazard ratio** comparing those groups.</span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example: Handling Non-Proportional Hazards Using Stratified Cox Model</span></span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>We are interested in whether time to graft failure after kidney transplantation differs by donor type (living vs deceased), after adjusting for important clinical factors.</span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a>We begin by fitting a standard Cox proportional hazards model, then check the PH assumption.</span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a>If the PH assumption is violated for any categorical covariate in the model, we refit the model using stratification by that covariate.</span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a><span class="in">library(survival)</span></span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a><span class="in">stratified_kidney_data&lt;-read.csv("stratified_kidney_data.CSV")</span></span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a><span class="in">cox_standard &lt;- coxph(</span></span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a><span class="in">  Surv(time, status) ~ donor_type +</span></span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a><span class="in">    donor_age +</span></span>
<span id="cb15-140"><a href="#cb15-140" aria-hidden="true" tabindex="-1"></a><span class="in">    recipient_gender +</span></span>
<span id="cb15-141"><a href="#cb15-141" aria-hidden="true" tabindex="-1"></a><span class="in">    egfr_baseline,</span></span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a><span class="in">  data = stratified_kidney_data</span></span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a><span class="in">#summary(cox_standard)</span></span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a><span class="in">#check the PH assumption first </span></span>
<span id="cb15-148"><a href="#cb15-148" aria-hidden="true" tabindex="-1"></a><span class="in">ph_test &lt;- cox.zph(cox_standard)</span></span>
<span id="cb15-149"><a href="#cb15-149" aria-hidden="true" tabindex="-1"></a><span class="in">ph_test</span></span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a><span class="in">plot(ph_test)</span></span>
<span id="cb15-151"><a href="#cb15-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-152"><a href="#cb15-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a>A small p-value indicates evidence against the proportional hazards assumption.</span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a>**Interpretation of PH diagnostics**  </span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a>The proportional hazards assumption is violated for donor type.  </span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a>Other covariates do not show strong evidence of violation.  </span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a>The global test is significant, indicating overall non-proportionality.  </span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a>This suggests that the effect of donor type on graft failure risk changes over time, making the standard Cox model inappropriate.  </span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-164"><a href="#cb15-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-165"><a href="#cb15-165" aria-hidden="true" tabindex="-1"></a>**Stratified Cox model**  </span>
<span id="cb15-166"><a href="#cb15-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-167"><a href="#cb15-167" aria-hidden="true" tabindex="-1"></a>To address this violation, we fit a stratified Cox model, stratifying on donor type.</span>
<span id="cb15-168"><a href="#cb15-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-169"><a href="#cb15-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb15-170"><a href="#cb15-170" aria-hidden="true" tabindex="-1"></a><span class="in">library(survival)</span></span>
<span id="cb15-171"><a href="#cb15-171" aria-hidden="true" tabindex="-1"></a><span class="in">cox_strat &lt;- coxph(</span></span>
<span id="cb15-172"><a href="#cb15-172" aria-hidden="true" tabindex="-1"></a><span class="in">Surv(time, status) ~ donor_age + recipient_gender + egfr_baseline +</span></span>
<span id="cb15-173"><a href="#cb15-173" aria-hidden="true" tabindex="-1"></a><span class="in">strata(donor_type),</span></span>
<span id="cb15-174"><a href="#cb15-174" aria-hidden="true" tabindex="-1"></a><span class="in">data = stratified_kidney_data</span></span>
<span id="cb15-175"><a href="#cb15-175" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-176"><a href="#cb15-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-177"><a href="#cb15-177" aria-hidden="true" tabindex="-1"></a><span class="in">summary(cox_strat)</span></span>
<span id="cb15-178"><a href="#cb15-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-179"><a href="#cb15-179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-180"><a href="#cb15-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-181"><a href="#cb15-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-182"><a href="#cb15-182" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb15-183"><a href="#cb15-183" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We no longer estimate a hazard ratio for donor type.</span>
<span id="cb15-184"><a href="#cb15-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-185"><a href="#cb15-185" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Donor type is now used only to define separate baseline hazards.</span>
<span id="cb15-186"><a href="#cb15-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-187"><a href="#cb15-187" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Effects of other covariates are assumed proportional within each stratum.</span>
<span id="cb15-188"><a href="#cb15-188" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-189"><a href="#cb15-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-190"><a href="#cb15-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-191"><a href="#cb15-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-192"><a href="#cb15-192" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb15-193"><a href="#cb15-193" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation </span></span>
<span id="cb15-194"><a href="#cb15-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-195"><a href="#cb15-195" aria-hidden="true" tabindex="-1"></a>Within each donor type (living and deceased), we interpret covariate effects as follows:</span>
<span id="cb15-196"><a href="#cb15-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-197"><a href="#cb15-197" aria-hidden="true" tabindex="-1"></a>‚úÖ Donor age  </span>
<span id="cb15-198"><a href="#cb15-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-199"><a href="#cb15-199" aria-hidden="true" tabindex="-1"></a>HR ‚âà 1.01 (95% CI: 0.997‚Äì1.03, P-value=0.14), Not statistically significant.  </span>
<span id="cb15-200"><a href="#cb15-200" aria-hidden="true" tabindex="-1"></a>Within each donor type, donor age shows no strong association with graft failure.</span>
<span id="cb15-201"><a href="#cb15-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-202"><a href="#cb15-202" aria-hidden="true" tabindex="-1"></a>‚úÖ Recipient gender (male)</span>
<span id="cb15-203"><a href="#cb15-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-204"><a href="#cb15-204" aria-hidden="true" tabindex="-1"></a>HR ‚âà 1.58 (95% CI: 1.16‚Äì2.13, P-value=0.003), Statistically significant.</span>
<span id="cb15-205"><a href="#cb15-205" aria-hidden="true" tabindex="-1"></a>Male recipients have about 58% higher hazard of graft failure compared to females</span>
<span id="cb15-206"><a href="#cb15-206" aria-hidden="true" tabindex="-1"></a>This comparison is within donor type, adjusting for donor age and eGFR.</span>
<span id="cb15-207"><a href="#cb15-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-208"><a href="#cb15-208" aria-hidden="true" tabindex="-1"></a>‚úÖ eGFR at transplant</span>
<span id="cb15-209"><a href="#cb15-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-210"><a href="#cb15-210" aria-hidden="true" tabindex="-1"></a>HR ‚âà 0.99 (95% CI: 0.97‚Äì1.00, P-value=0.033), Statistically significant.</span>
<span id="cb15-211"><a href="#cb15-211" aria-hidden="true" tabindex="-1"></a>Each 1-unit increase in baseline eGFR is associated with about 1‚Äì2% lower hazard of graft failure, within each donor type.</span>
<span id="cb15-212"><a href="#cb15-212" aria-hidden="true" tabindex="-1"></a>To improve interpretability, we can express the effect per **10-unit increase** in eGFR:</span>
<span id="cb15-213"><a href="#cb15-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-214"><a href="#cb15-214" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-215"><a href="#cb15-215" aria-hidden="true" tabindex="-1"></a>HR_{10\text{-unit}} = 0.99^{10} \approx 0.90</span>
<span id="cb15-216"><a href="#cb15-216" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-217"><a href="#cb15-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-218"><a href="#cb15-218" aria-hidden="true" tabindex="-1"></a>**Interpretation:**  </span>
<span id="cb15-219"><a href="#cb15-219" aria-hidden="true" tabindex="-1"></a>Within each donor type, a 10-unit higher eGFR at the time of transplant is associated with approximately a **10% lower hazard of graft failure**, after adjusting for donor age and recipient gender.</span>
<span id="cb15-220"><a href="#cb15-220" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-221"><a href="#cb15-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-222"><a href="#cb15-222" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb15-223"><a href="#cb15-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-224"><a href="#cb15-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-225"><a href="#cb15-225" aria-hidden="true" tabindex="-1"></a><span class="fu">### What about donor type?</span></span>
<span id="cb15-226"><a href="#cb15-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-227"><a href="#cb15-227" aria-hidden="true" tabindex="-1"></a>Stratifying by donor type allows each group to have its own baseline hazard curve, effectively removing the need to assume a constant hazard ratio over time.  </span>
<span id="cb15-228"><a href="#cb15-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-229"><a href="#cb15-229" aria-hidden="true" tabindex="-1"></a>The curves demonstrate that living and deceased donor grafts follow different survival trajectories ‚Äî exactly what we expect when the PH assumption is violated.</span>
<span id="cb15-230"><a href="#cb15-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-231"><a href="#cb15-231" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-232"><a href="#cb15-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-233"><a href="#cb15-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb15-234"><a href="#cb15-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-235"><a href="#cb15-235" aria-hidden="true" tabindex="-1"></a><span class="in"># cox_strat is the stratified cox model we fitted in previous chunk </span></span>
<span id="cb15-236"><a href="#cb15-236" aria-hidden="true" tabindex="-1"></a><span class="in">sf_strat &lt;- survfit(cox_strat)</span></span>
<span id="cb15-237"><a href="#cb15-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-238"><a href="#cb15-238" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert survfit to a tidy data frame for ggplot</span></span>
<span id="cb15-239"><a href="#cb15-239" aria-hidden="true" tabindex="-1"></a><span class="in">sf_df &lt;- data.frame(</span></span>
<span id="cb15-240"><a href="#cb15-240" aria-hidden="true" tabindex="-1"></a><span class="in">  time  = sf_strat$time,</span></span>
<span id="cb15-241"><a href="#cb15-241" aria-hidden="true" tabindex="-1"></a><span class="in">  surv  = sf_strat$surv,</span></span>
<span id="cb15-242"><a href="#cb15-242" aria-hidden="true" tabindex="-1"></a><span class="in">  lower = sf_strat$lower,</span></span>
<span id="cb15-243"><a href="#cb15-243" aria-hidden="true" tabindex="-1"></a><span class="in">  upper = sf_strat$upper,</span></span>
<span id="cb15-244"><a href="#cb15-244" aria-hidden="true" tabindex="-1"></a><span class="in">  strata = rep(names(sf_strat$strata), sf_strat$strata)</span></span>
<span id="cb15-245"><a href="#cb15-245" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-246"><a href="#cb15-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-247"><a href="#cb15-247" aria-hidden="true" tabindex="-1"></a><span class="in"># Clean up the stratum labels from "donor_type=deceased" ‚Üí "deceased"</span></span>
<span id="cb15-248"><a href="#cb15-248" aria-hidden="true" tabindex="-1"></a><span class="in">sf_df$strata &lt;- sub("donor_type=", "", sf_df$strata)</span></span>
<span id="cb15-249"><a href="#cb15-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-250"><a href="#cb15-250" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb15-251"><a href="#cb15-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-252"><a href="#cb15-252" aria-hidden="true" tabindex="-1"></a><span class="in">stratified_cox_plot&lt;-ggplot(sf_df, aes(x = time, y = surv, colour = strata)) +</span></span>
<span id="cb15-253"><a href="#cb15-253" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_step(linewidth = 1.2) +</span></span>
<span id="cb15-254"><a href="#cb15-254" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower, ymax = upper, fill = strata),</span></span>
<span id="cb15-255"><a href="#cb15-255" aria-hidden="true" tabindex="-1"></a><span class="in">              alpha = 0.15, linewidth = 0) +</span></span>
<span id="cb15-256"><a href="#cb15-256" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_colour_manual(values = c("deceased" = "#365abd",  # deep blue</span></span>
<span id="cb15-257"><a href="#cb15-257" aria-hidden="true" tabindex="-1"></a><span class="in">                                 "living"   = "#c0397e"))+ # magenta/rose</span></span>
<span id="cb15-258"><a href="#cb15-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-259"><a href="#cb15-259" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("deceased" = "#365abd",</span></span>
<span id="cb15-260"><a href="#cb15-260" aria-hidden="true" tabindex="-1"></a><span class="in">                               "living"   = "#c0397e")) +</span></span>
<span id="cb15-261"><a href="#cb15-261" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb15-262"><a href="#cb15-262" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Stratified Cox Model\nDifferent Baseline Hazards by Donor Type",</span></span>
<span id="cb15-263"><a href="#cb15-263" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Time since transplant (years)",</span></span>
<span id="cb15-264"><a href="#cb15-264" aria-hidden="true" tabindex="-1"></a><span class="in">    y = "Predicted survival probability",</span></span>
<span id="cb15-265"><a href="#cb15-265" aria-hidden="true" tabindex="-1"></a><span class="in">    colour = "Donor type",</span></span>
<span id="cb15-266"><a href="#cb15-266" aria-hidden="true" tabindex="-1"></a><span class="in">    fill   = "Donor type"</span></span>
<span id="cb15-267"><a href="#cb15-267" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb15-268"><a href="#cb15-268" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0.4, 1)) +</span></span>
<span id="cb15-269"><a href="#cb15-269" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_grey(base_size = 14) +</span></span>
<span id="cb15-270"><a href="#cb15-270" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb15-271"><a href="#cb15-271" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.title       = element_text(face = "bold", hjust = 0.5),</span></span>
<span id="cb15-272"><a href="#cb15-272" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position  = "bottom",</span></span>
<span id="cb15-273"><a href="#cb15-273" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title     = element_text(face = "bold")</span></span>
<span id="cb15-274"><a href="#cb15-274" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb15-275"><a href="#cb15-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-276"><a href="#cb15-276" aria-hidden="true" tabindex="-1"></a><span class="in">stratified_cox_plot</span></span>
<span id="cb15-277"><a href="#cb15-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-278"><a href="#cb15-278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-279"><a href="#cb15-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-280"><a href="#cb15-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-281"><a href="#cb15-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-282"><a href="#cb15-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-283"><a href="#cb15-283" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb15-284"><a href="#cb15-284" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Ignoring PH Violations Can Be Misleading</span></span>
<span id="cb15-285"><a href="#cb15-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-286"><a href="#cb15-286" aria-hidden="true" tabindex="-1"></a>If we ignore the violation of the proportional hazards (PH) assumption and proceed with a standard Cox model, we may obtain a single hazard ratio that does **not accurately reflect how risk changes over time**.</span>
<span id="cb15-287"><a href="#cb15-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-288"><a href="#cb15-288" aria-hidden="true" tabindex="-1"></a>This can lead to misleading conclusions, as the estimated effect represents an average over follow-up rather than the true time-varying relationship.</span>
<span id="cb15-289"><a href="#cb15-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-290"><a href="#cb15-290" aria-hidden="true" tabindex="-1"></a>This is illustrated in the plot below, where the separation between groups is clearly **not constant over time**.</span>
<span id="cb15-291"><a href="#cb15-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-292"><a href="#cb15-292" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-293"><a href="#cb15-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-294"><a href="#cb15-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-295"><a href="#cb15-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb15-296"><a href="#cb15-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-297"><a href="#cb15-297" aria-hidden="true" tabindex="-1"></a><span class="in">#data preparation for plot </span></span>
<span id="cb15-298"><a href="#cb15-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-299"><a href="#cb15-299" aria-hidden="true" tabindex="-1"></a><span class="in">new_deceased &lt;- data.frame(</span></span>
<span id="cb15-300"><a href="#cb15-300" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_type = factor("deceased", levels = levels(as.factor(stratified_kidney_data$donor_type))),</span></span>
<span id="cb15-301"><a href="#cb15-301" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_age = mean(stratified_kidney_data$donor_age, na.rm = TRUE),</span></span>
<span id="cb15-302"><a href="#cb15-302" aria-hidden="true" tabindex="-1"></a><span class="in">  recipient_gender = factor("female", levels = levels(as.factor(stratified_kidney_data$recipient_gender))),</span></span>
<span id="cb15-303"><a href="#cb15-303" aria-hidden="true" tabindex="-1"></a><span class="in">  egfr_baseline = mean(stratified_kidney_data$egfr_baseline, na.rm = TRUE)</span></span>
<span id="cb15-304"><a href="#cb15-304" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-305"><a href="#cb15-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-306"><a href="#cb15-306" aria-hidden="true" tabindex="-1"></a><span class="in">new_living &lt;- data.frame(</span></span>
<span id="cb15-307"><a href="#cb15-307" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_type = factor("living", levels = levels(as.factor(stratified_kidney_data$donor_type))),</span></span>
<span id="cb15-308"><a href="#cb15-308" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_age = mean(stratified_kidney_data$donor_age, na.rm = TRUE),</span></span>
<span id="cb15-309"><a href="#cb15-309" aria-hidden="true" tabindex="-1"></a><span class="in">  recipient_gender = factor("female", levels = levels(as.factor(stratified_kidney_data$recipient_gender))),</span></span>
<span id="cb15-310"><a href="#cb15-310" aria-hidden="true" tabindex="-1"></a><span class="in">  egfr_baseline = mean(stratified_kidney_data$egfr_baseline, na.rm = TRUE)</span></span>
<span id="cb15-311"><a href="#cb15-311" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-312"><a href="#cb15-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-313"><a href="#cb15-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-314"><a href="#cb15-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-315"><a href="#cb15-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-316"><a href="#cb15-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-317"><a href="#cb15-317" aria-hidden="true" tabindex="-1"></a><span class="in">sf_deceased &lt;- survfit(cox_standard, newdata = new_deceased)</span></span>
<span id="cb15-318"><a href="#cb15-318" aria-hidden="true" tabindex="-1"></a><span class="in">sf_living   &lt;- survfit(cox_standard, newdata = new_living)</span></span>
<span id="cb15-319"><a href="#cb15-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-320"><a href="#cb15-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-321"><a href="#cb15-321" aria-hidden="true" tabindex="-1"></a><span class="in">df_dec &lt;- data.frame(</span></span>
<span id="cb15-322"><a href="#cb15-322" aria-hidden="true" tabindex="-1"></a><span class="in">  time       = sf_deceased$time,</span></span>
<span id="cb15-323"><a href="#cb15-323" aria-hidden="true" tabindex="-1"></a><span class="in">  surv       = sf_deceased$surv,</span></span>
<span id="cb15-324"><a href="#cb15-324" aria-hidden="true" tabindex="-1"></a><span class="in">  lower      = sf_deceased$lower,</span></span>
<span id="cb15-325"><a href="#cb15-325" aria-hidden="true" tabindex="-1"></a><span class="in">  upper      = sf_deceased$upper,</span></span>
<span id="cb15-326"><a href="#cb15-326" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_type = "Deceased donor"</span></span>
<span id="cb15-327"><a href="#cb15-327" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-328"><a href="#cb15-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-329"><a href="#cb15-329" aria-hidden="true" tabindex="-1"></a><span class="in">df_liv &lt;- data.frame(</span></span>
<span id="cb15-330"><a href="#cb15-330" aria-hidden="true" tabindex="-1"></a><span class="in">  time       = sf_living$time,</span></span>
<span id="cb15-331"><a href="#cb15-331" aria-hidden="true" tabindex="-1"></a><span class="in">  surv       = sf_living$surv,</span></span>
<span id="cb15-332"><a href="#cb15-332" aria-hidden="true" tabindex="-1"></a><span class="in">  lower      = sf_living$lower,</span></span>
<span id="cb15-333"><a href="#cb15-333" aria-hidden="true" tabindex="-1"></a><span class="in">  upper      = sf_living$upper,</span></span>
<span id="cb15-334"><a href="#cb15-334" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_type = "Living donor"</span></span>
<span id="cb15-335"><a href="#cb15-335" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-336"><a href="#cb15-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-337"><a href="#cb15-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-338"><a href="#cb15-338" aria-hidden="true" tabindex="-1"></a><span class="in">df_ph &lt;- rbind(df_dec, df_liv)</span></span>
<span id="cb15-339"><a href="#cb15-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-340"><a href="#cb15-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-341"><a href="#cb15-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-342"><a href="#cb15-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-343"><a href="#cb15-343" aria-hidden="true" tabindex="-1"></a><span class="in">standard_cox_plot&lt;-ggplot(df_ph, aes(x = time, y = surv, colour = donor_type, fill = donor_type)) +</span></span>
<span id="cb15-344"><a href="#cb15-344" aria-hidden="true" tabindex="-1"></a><span class="in">  # CI ribbon</span></span>
<span id="cb15-345"><a href="#cb15-345" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower, ymax = upper),</span></span>
<span id="cb15-346"><a href="#cb15-346" aria-hidden="true" tabindex="-1"></a><span class="in">              alpha = 0.2,</span></span>
<span id="cb15-347"><a href="#cb15-347" aria-hidden="true" tabindex="-1"></a><span class="in">              colour = NA,</span></span>
<span id="cb15-348"><a href="#cb15-348" aria-hidden="true" tabindex="-1"></a><span class="in">              show.legend = FALSE) +</span></span>
<span id="cb15-349"><a href="#cb15-349" aria-hidden="true" tabindex="-1"></a><span class="in">  # Step survival curve</span></span>
<span id="cb15-350"><a href="#cb15-350" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_step(linewidth = 1.2) +</span></span>
<span id="cb15-351"><a href="#cb15-351" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-352"><a href="#cb15-352" aria-hidden="true" tabindex="-1"></a><span class="in">  # Manual colours for consistency across slides</span></span>
<span id="cb15-353"><a href="#cb15-353" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_colour_manual(</span></span>
<span id="cb15-354"><a href="#cb15-354" aria-hidden="true" tabindex="-1"></a><span class="in">    values = c("Deceased donor" = "#365abd",   # blue</span></span>
<span id="cb15-355"><a href="#cb15-355" aria-hidden="true" tabindex="-1"></a><span class="in">               "Living donor"   = "#c0397e")   # magenta/rose</span></span>
<span id="cb15-356"><a href="#cb15-356" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb15-357"><a href="#cb15-357" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(</span></span>
<span id="cb15-358"><a href="#cb15-358" aria-hidden="true" tabindex="-1"></a><span class="in">    values = c("Deceased donor" = "#365abd",</span></span>
<span id="cb15-359"><a href="#cb15-359" aria-hidden="true" tabindex="-1"></a><span class="in">               "Living donor"   = "#c0397e")</span></span>
<span id="cb15-360"><a href="#cb15-360" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb15-361"><a href="#cb15-361" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-362"><a href="#cb15-362" aria-hidden="true" tabindex="-1"></a><span class="in">  # Axis labels and title</span></span>
<span id="cb15-363"><a href="#cb15-363" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb15-364"><a href="#cb15-364" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Standard Cox PH Model\nAssumes Constant Effect of Donor Type",</span></span>
<span id="cb15-365"><a href="#cb15-365" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Time since transplant (years)",</span></span>
<span id="cb15-366"><a href="#cb15-366" aria-hidden="true" tabindex="-1"></a><span class="in">    y = "Predicted survival probability",</span></span>
<span id="cb15-367"><a href="#cb15-367" aria-hidden="true" tabindex="-1"></a><span class="in">    colour = "Donor type"</span></span>
<span id="cb15-368"><a href="#cb15-368" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb15-369"><a href="#cb15-369" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-370"><a href="#cb15-370" aria-hidden="true" tabindex="-1"></a><span class="in">  # y-axis from 0.4 to 1.0</span></span>
<span id="cb15-371"><a href="#cb15-371" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0.4, 1.0)) +</span></span>
<span id="cb15-372"><a href="#cb15-372" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-373"><a href="#cb15-373" aria-hidden="true" tabindex="-1"></a><span class="in">  # Use grey theme with gridlines</span></span>
<span id="cb15-374"><a href="#cb15-374" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_grey(base_size = 14) +</span></span>
<span id="cb15-375"><a href="#cb15-375" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb15-376"><a href="#cb15-376" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.title       = element_text(face = "bold", hjust = 0.5),</span></span>
<span id="cb15-377"><a href="#cb15-377" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position  = "bottom",</span></span>
<span id="cb15-378"><a href="#cb15-378" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title     = element_text(face = "bold")</span></span>
<span id="cb15-379"><a href="#cb15-379" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb15-380"><a href="#cb15-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-381"><a href="#cb15-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-382"><a href="#cb15-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-383"><a href="#cb15-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-384"><a href="#cb15-384" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb15-385"><a href="#cb15-385" aria-hidden="true" tabindex="-1"></a><span class="in">library(gridExtra)</span></span>
<span id="cb15-386"><a href="#cb15-386" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb15-387"><a href="#cb15-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-388"><a href="#cb15-388" aria-hidden="true" tabindex="-1"></a><span class="in"># Reduce title size for each plot</span></span>
<span id="cb15-389"><a href="#cb15-389" aria-hidden="true" tabindex="-1"></a><span class="in">standard_cox_plot_small &lt;- standard_cox_plot +</span></span>
<span id="cb15-390"><a href="#cb15-390" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.title = element_text(size = 10))</span></span>
<span id="cb15-391"><a href="#cb15-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-392"><a href="#cb15-392" aria-hidden="true" tabindex="-1"></a><span class="in">stratified_cox_plot_small &lt;- stratified_cox_plot +</span></span>
<span id="cb15-393"><a href="#cb15-393" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.title = element_text(size = 10))</span></span>
<span id="cb15-394"><a href="#cb15-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-395"><a href="#cb15-395" aria-hidden="true" tabindex="-1"></a><span class="in"># Arrange side by side</span></span>
<span id="cb15-396"><a href="#cb15-396" aria-hidden="true" tabindex="-1"></a><span class="in">grid.arrange(</span></span>
<span id="cb15-397"><a href="#cb15-397" aria-hidden="true" tabindex="-1"></a><span class="in">  standard_cox_plot_small,</span></span>
<span id="cb15-398"><a href="#cb15-398" aria-hidden="true" tabindex="-1"></a><span class="in">  stratified_cox_plot_small,</span></span>
<span id="cb15-399"><a href="#cb15-399" aria-hidden="true" tabindex="-1"></a><span class="in">  ncol = 2</span></span>
<span id="cb15-400"><a href="#cb15-400" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-401"><a href="#cb15-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-402"><a href="#cb15-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-403"><a href="#cb15-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-404"><a href="#cb15-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-405"><a href="#cb15-405" aria-hidden="true" tabindex="-1"></a><span class="fu">## Including Time-Varying Effects</span></span>
<span id="cb15-406"><a href="#cb15-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-407"><a href="#cb15-407" aria-hidden="true" tabindex="-1"></a>When the proportional hazards (PH) assumption is violated, **stratification is not the only solution**.</span>
<span id="cb15-408"><a href="#cb15-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-409"><a href="#cb15-409" aria-hidden="true" tabindex="-1"></a>In some settings, we still want to:</span>
<span id="cb15-410"><a href="#cb15-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-411"><a href="#cb15-411" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Keep the covariate in the model**</span>
<span id="cb15-412"><a href="#cb15-412" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Obtain an explicit effect estimate**</span>
<span id="cb15-413"><a href="#cb15-413" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Allow the effect to change over time**</span>
<span id="cb15-414"><a href="#cb15-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-415"><a href="#cb15-415" aria-hidden="true" tabindex="-1"></a>This leads to a **time-varying coefficient Cox model**.</span>
<span id="cb15-416"><a href="#cb15-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-417"><a href="#cb15-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-418"><a href="#cb15-418" aria-hidden="true" tabindex="-1"></a> **When to Use Time-Varying Effects**  </span>
<span id="cb15-419"><a href="#cb15-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-420"><a href="#cb15-420" aria-hidden="true" tabindex="-1"></a>Use a time-varying effect when:</span>
<span id="cb15-421"><a href="#cb15-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-422"><a href="#cb15-422" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The PH assumption is violated for a variable (e.g. **donor type**)</span>
<span id="cb15-423"><a href="#cb15-423" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The variable is scientifically important</span>
<span id="cb15-424"><a href="#cb15-424" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You believe the **effect itself changes over time**</span>
<span id="cb15-425"><a href="#cb15-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-426"><a href="#cb15-426" aria-hidden="true" tabindex="-1"></a>For example:</span>
<span id="cb15-427"><a href="#cb15-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-428"><a href="#cb15-428" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Early after transplant, **living donors may be protective**</span>
<span id="cb15-429"><a href="#cb15-429" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Later, that advantage may **diminish or reverse**</span>
<span id="cb15-430"><a href="#cb15-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-431"><a href="#cb15-431" aria-hidden="true" tabindex="-1"></a>**Model Idea**  </span>
<span id="cb15-432"><a href="#cb15-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-433"><a href="#cb15-433" aria-hidden="true" tabindex="-1"></a>In the **standard Cox model**:</span>
<span id="cb15-434"><a href="#cb15-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-435"><a href="#cb15-435" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-436"><a href="#cb15-436" aria-hidden="true" tabindex="-1"></a>h(t \mid X) = h_0(t)\exp(\beta_1 X_1 + \beta_2 X_2 + \cdots)</span>
<span id="cb15-437"><a href="#cb15-437" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-438"><a href="#cb15-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-439"><a href="#cb15-439" aria-hidden="true" tabindex="-1"></a>the coefficients ($\beta$) are assumed to be **constant over time**, which leads to the **proportional hazards (PH) assumption**.</span>
<span id="cb15-440"><a href="#cb15-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-441"><a href="#cb15-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-442"><a href="#cb15-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-443"><a href="#cb15-443" aria-hidden="true" tabindex="-1"></a>If a covariate‚Äôs effect **changes over time**, we can allow its coefficient to depend on time:</span>
<span id="cb15-444"><a href="#cb15-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-445"><a href="#cb15-445" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-446"><a href="#cb15-446" aria-hidden="true" tabindex="-1"></a>h(t \mid X) = h_0(t)\exp\left(\beta_1(t) X_1 + \beta_2 X_2 + \cdots\right)</span>
<span id="cb15-447"><a href="#cb15-447" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-448"><a href="#cb15-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-449"><a href="#cb15-449" aria-hidden="true" tabindex="-1"></a>This allows the **hazard ratio for $X_1$ to vary with time**.</span>
<span id="cb15-450"><a href="#cb15-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-451"><a href="#cb15-451" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb15-452"><a href="#cb15-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-453"><a href="#cb15-453" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intuition</span></span>
<span id="cb15-454"><a href="#cb15-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-455"><a href="#cb15-455" aria-hidden="true" tabindex="-1"></a>Instead of assuming the two groups keep the same relative risk forever,  </span>
<span id="cb15-456"><a href="#cb15-456" aria-hidden="true" tabindex="-1"></a>we allow the **risk difference between groups to change over time**.</span>
<span id="cb15-457"><a href="#cb15-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-458"><a href="#cb15-458" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-459"><a href="#cb15-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-460"><a href="#cb15-460" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb15-461"><a href="#cb15-461" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Use It</span></span>
<span id="cb15-462"><a href="#cb15-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-463"><a href="#cb15-463" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You detect a **proportional hazards (PH) violation** for a variable (e.g. **donor type**) but you **still want an explicit effect estimate**, rather than stratifying it away.</span>
<span id="cb15-464"><a href="#cb15-464" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For example:</span>
<span id="cb15-465"><a href="#cb15-465" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Early after transplant**, living donors may be **protective**</span>
<span id="cb15-466"><a href="#cb15-466" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Later**, that advantage may **diminish or reverse**</span>
<span id="cb15-467"><a href="#cb15-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-468"><a href="#cb15-468" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-469"><a href="#cb15-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-470"><a href="#cb15-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-471"><a href="#cb15-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-472"><a href="#cb15-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-473"><a href="#cb15-473" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example: Time-Varying Effect of Donor Type</span></span>
<span id="cb15-474"><a href="#cb15-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-475"><a href="#cb15-475" aria-hidden="true" tabindex="-1"></a>We return to the kidney transplant example:</span>
<span id="cb15-476"><a href="#cb15-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-477"><a href="#cb15-477" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Outcome:** time to graft failure  </span>
<span id="cb15-478"><a href="#cb15-478" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Exposure:** donor type (living vs deceased)  </span>
<span id="cb15-479"><a href="#cb15-479" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Covariates:** donor age, recipient gender, baseline eGFR  </span>
<span id="cb15-480"><a href="#cb15-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-481"><a href="#cb15-481" aria-hidden="true" tabindex="-1"></a>Previously, we showed that **donor type violates the PH assumption**.</span>
<span id="cb15-482"><a href="#cb15-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-483"><a href="#cb15-483" aria-hidden="true" tabindex="-1"></a>We introduce an **interaction between the covariate and time**, most commonly:</span>
<span id="cb15-484"><a href="#cb15-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-485"><a href="#cb15-485" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**donor type √ó log(time)**  </span>
<span id="cb15-486"><a href="#cb15-486" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**donor type √ó time**</span>
<span id="cb15-487"><a href="#cb15-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-488"><a href="#cb15-488" aria-hidden="true" tabindex="-1"></a>This allows the model to estimate **how the effect changes with time**.</span>
<span id="cb15-489"><a href="#cb15-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-490"><a href="#cb15-490" aria-hidden="true" tabindex="-1"></a>The Cox model becomes:</span>
<span id="cb15-491"><a href="#cb15-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-492"><a href="#cb15-492" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-493"><a href="#cb15-493" aria-hidden="true" tabindex="-1"></a>h(t) = h_0(t)\exp\left<span class="co">[</span><span class="ot">\beta_1 \,\text{donor\_type} + \beta_2 \left(\text{donor\_type} \times \log(t)\right) + \cdots \right</span><span class="co">]</span></span>
<span id="cb15-494"><a href="#cb15-494" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-495"><a href="#cb15-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-496"><a href="#cb15-496" aria-hidden="true" tabindex="-1"></a>Where:</span>
<span id="cb15-497"><a href="#cb15-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-498"><a href="#cb15-498" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\beta_1$ represents the **baseline (early) effect** of donor type  </span>
<span id="cb15-499"><a href="#cb15-499" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\beta_2$ represents **how that effect changes over time**</span>
<span id="cb15-500"><a href="#cb15-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-501"><a href="#cb15-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-502"><a href="#cb15-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-503"><a href="#cb15-503" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb15-504"><a href="#cb15-504" aria-hidden="true" tabindex="-1"></a><span class="in">library(survival)</span></span>
<span id="cb15-505"><a href="#cb15-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-506"><a href="#cb15-506" aria-hidden="true" tabindex="-1"></a><span class="in">kidney_violate &lt;- read.csv("stratified_kidney_data.csv")</span></span>
<span id="cb15-507"><a href="#cb15-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-508"><a href="#cb15-508" aria-hidden="true" tabindex="-1"></a><span class="in">kidney_violate$donor_live &lt;- ifelse(kidney_violate$donor_type == "living", 1, 0)</span></span>
<span id="cb15-509"><a href="#cb15-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-510"><a href="#cb15-510" aria-hidden="true" tabindex="-1"></a><span class="in">cox_timevary &lt;- coxph(</span></span>
<span id="cb15-511"><a href="#cb15-511" aria-hidden="true" tabindex="-1"></a><span class="in">  Surv(time, status) ~ donor_live +</span></span>
<span id="cb15-512"><a href="#cb15-512" aria-hidden="true" tabindex="-1"></a><span class="in">    donor_age +</span></span>
<span id="cb15-513"><a href="#cb15-513" aria-hidden="true" tabindex="-1"></a><span class="in">    recipient_gender +</span></span>
<span id="cb15-514"><a href="#cb15-514" aria-hidden="true" tabindex="-1"></a><span class="in">    egfr_baseline +</span></span>
<span id="cb15-515"><a href="#cb15-515" aria-hidden="true" tabindex="-1"></a><span class="in">    tt(donor_live),</span></span>
<span id="cb15-516"><a href="#cb15-516" aria-hidden="true" tabindex="-1"></a><span class="in">  data = kidney_violate,</span></span>
<span id="cb15-517"><a href="#cb15-517" aria-hidden="true" tabindex="-1"></a><span class="in">  tt = function(x, t, ...) {</span></span>
<span id="cb15-518"><a href="#cb15-518" aria-hidden="true" tabindex="-1"></a><span class="in">    x * log(t + 0.01)</span></span>
<span id="cb15-519"><a href="#cb15-519" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb15-520"><a href="#cb15-520" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-521"><a href="#cb15-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-522"><a href="#cb15-522" aria-hidden="true" tabindex="-1"></a><span class="in">summary(cox_timevary)</span></span>
<span id="cb15-523"><a href="#cb15-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-524"><a href="#cb15-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-525"><a href="#cb15-525" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb15-526"><a href="#cb15-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-527"><a href="#cb15-527" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>donor_live represents the baseline effect  </span>
<span id="cb15-528"><a href="#cb15-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-529"><a href="#cb15-529" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>tt(donor_live) allows the effect to change with time  </span>
<span id="cb15-530"><a href="#cb15-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-531"><a href="#cb15-531" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\log(t)$ captures gradual, nonlinear change  </span>
<span id="cb15-532"><a href="#cb15-532" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-533"><a href="#cb15-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-534"><a href="#cb15-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-535"><a href="#cb15-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-536"><a href="#cb15-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-537"><a href="#cb15-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-538"><a href="#cb15-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-539"><a href="#cb15-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-540"><a href="#cb15-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-541"><a href="#cb15-541" aria-hidden="true" tabindex="-1"></a>**Visualising the Time-Varying Hazard Ratio**</span>
<span id="cb15-542"><a href="#cb15-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-543"><a href="#cb15-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb15-544"><a href="#cb15-544" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb15-545"><a href="#cb15-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-546"><a href="#cb15-546" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- coef(cox_timevary)</span></span>
<span id="cb15-547"><a href="#cb15-547" aria-hidden="true" tabindex="-1"></a><span class="in">v &lt;- vcov(cox_timevary)</span></span>
<span id="cb15-548"><a href="#cb15-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-549"><a href="#cb15-549" aria-hidden="true" tabindex="-1"></a><span class="in">beta1 &lt;- b["donor_live"]</span></span>
<span id="cb15-550"><a href="#cb15-550" aria-hidden="true" tabindex="-1"></a><span class="in">beta2 &lt;- b["tt(donor_live)"]</span></span>
<span id="cb15-551"><a href="#cb15-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-552"><a href="#cb15-552" aria-hidden="true" tabindex="-1"></a><span class="in">var_beta1 &lt;- v["donor_live", "donor_live"]</span></span>
<span id="cb15-553"><a href="#cb15-553" aria-hidden="true" tabindex="-1"></a><span class="in">var_beta2 &lt;- v["tt(donor_live)", "tt(donor_live)"]</span></span>
<span id="cb15-554"><a href="#cb15-554" aria-hidden="true" tabindex="-1"></a><span class="in">cov_b1b2  &lt;- v["donor_live", "tt(donor_live)"]</span></span>
<span id="cb15-555"><a href="#cb15-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-556"><a href="#cb15-556" aria-hidden="true" tabindex="-1"></a><span class="in">t_seq &lt;- seq(0.5, 8, by = 0.1)</span></span>
<span id="cb15-557"><a href="#cb15-557" aria-hidden="true" tabindex="-1"></a><span class="in">log_t &lt;- log(t_seq + 0.01)</span></span>
<span id="cb15-558"><a href="#cb15-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-559"><a href="#cb15-559" aria-hidden="true" tabindex="-1"></a><span class="in">lp &lt;- beta1 + beta2 * log_t</span></span>
<span id="cb15-560"><a href="#cb15-560" aria-hidden="true" tabindex="-1"></a><span class="in">var_lp &lt;- var_beta1 + (log_t^2) * var_beta2 + 2 * log_t * cov_b1b2</span></span>
<span id="cb15-561"><a href="#cb15-561" aria-hidden="true" tabindex="-1"></a><span class="in">se_lp &lt;- sqrt(var_lp)</span></span>
<span id="cb15-562"><a href="#cb15-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-563"><a href="#cb15-563" aria-hidden="true" tabindex="-1"></a><span class="in">hr_df &lt;- data.frame(</span></span>
<span id="cb15-564"><a href="#cb15-564" aria-hidden="true" tabindex="-1"></a><span class="in">  time  = t_seq,</span></span>
<span id="cb15-565"><a href="#cb15-565" aria-hidden="true" tabindex="-1"></a><span class="in">  HR    = exp(lp),</span></span>
<span id="cb15-566"><a href="#cb15-566" aria-hidden="true" tabindex="-1"></a><span class="in">  lower = exp(lp - 1.96 * se_lp),</span></span>
<span id="cb15-567"><a href="#cb15-567" aria-hidden="true" tabindex="-1"></a><span class="in">  upper = exp(lp + 1.96 * se_lp)</span></span>
<span id="cb15-568"><a href="#cb15-568" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-569"><a href="#cb15-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-570"><a href="#cb15-570" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(hr_df, aes(x = time, y = HR)) +</span></span>
<span id="cb15-571"><a href="#cb15-571" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower, ymax = upper),</span></span>
<span id="cb15-572"><a href="#cb15-572" aria-hidden="true" tabindex="-1"></a><span class="in">              alpha = 0.2, fill = "#c75b87") +</span></span>
<span id="cb15-573"><a href="#cb15-573" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.2, colour = "#c75b87") +</span></span>
<span id="cb15-574"><a href="#cb15-574" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 1,</span></span>
<span id="cb15-575"><a href="#cb15-575" aria-hidden="true" tabindex="-1"></a><span class="in">             linetype = "dashed",</span></span>
<span id="cb15-576"><a href="#cb15-576" aria-hidden="true" tabindex="-1"></a><span class="in">             colour = "grey50") +</span></span>
<span id="cb15-577"><a href="#cb15-577" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb15-578"><a href="#cb15-578" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Time-varying effect of donor type",</span></span>
<span id="cb15-579"><a href="#cb15-579" aria-hidden="true" tabindex="-1"></a><span class="in">    subtitle = "Hazard ratio: living vs deceased donor",</span></span>
<span id="cb15-580"><a href="#cb15-580" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Time since transplant (years)",</span></span>
<span id="cb15-581"><a href="#cb15-581" aria-hidden="true" tabindex="-1"></a><span class="in">    y = "Hazard ratio"</span></span>
<span id="cb15-582"><a href="#cb15-582" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb15-583"><a href="#cb15-583" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_grey(base_size = 14) +</span></span>
<span id="cb15-584"><a href="#cb15-584" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb15-585"><a href="#cb15-585" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.title = element_text(face = "bold", hjust = 0.5),</span></span>
<span id="cb15-586"><a href="#cb15-586" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.subtitle = element_text(hjust = 0.5),</span></span>
<span id="cb15-587"><a href="#cb15-587" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.grid.minor = element_blank()</span></span>
<span id="cb15-588"><a href="#cb15-588" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb15-589"><a href="#cb15-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-590"><a href="#cb15-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-591"><a href="#cb15-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-592"><a href="#cb15-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-593"><a href="#cb15-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-594"><a href="#cb15-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-595"><a href="#cb15-595" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb15-596"><a href="#cb15-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-597"><a href="#cb15-597" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation</span></span>
<span id="cb15-598"><a href="#cb15-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-599"><a href="#cb15-599" aria-hidden="true" tabindex="-1"></a>We interpret the results of the **time-varying coefficient Cox model** as follows:</span>
<span id="cb15-600"><a href="#cb15-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-601"><a href="#cb15-601" aria-hidden="true" tabindex="-1"></a>‚úÖ **Donor type (living vs deceased) ‚Äî baseline effect**</span>
<span id="cb15-602"><a href="#cb15-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-603"><a href="#cb15-603" aria-hidden="true" tabindex="-1"></a>HR ‚âà 0.50 (95% CI: 0.25‚Äì1.01, P-value ‚âà 0.05).  </span>
<span id="cb15-604"><a href="#cb15-604" aria-hidden="true" tabindex="-1"></a>At the **start of follow-up** (when $\log(t) \approx 0$), recipients of a **living donor** kidney have about a **50% lower hazard** of graft failure compared to recipients of deceased-donor kidneys.</span>
<span id="cb15-605"><a href="#cb15-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-606"><a href="#cb15-606" aria-hidden="true" tabindex="-1"></a>This represents the **early effect** of donor type.</span>
<span id="cb15-607"><a href="#cb15-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-608"><a href="#cb15-608" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-609"><a href="#cb15-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-610"><a href="#cb15-610" aria-hidden="true" tabindex="-1"></a>‚úÖ **Time-varying effect of donor type** (<span class="in">`tt(donor_live)`</span>)</span>
<span id="cb15-611"><a href="#cb15-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-612"><a href="#cb15-612" aria-hidden="true" tabindex="-1"></a>HR ‚âà 3.53 (95% CI: 2.15‚Äì5.79, P-value &lt; 0.001), **Statistically significant**.  </span>
<span id="cb15-613"><a href="#cb15-613" aria-hidden="true" tabindex="-1"></a>The effect of **living donor changes significantly over time**.  </span>
<span id="cb15-614"><a href="#cb15-614" aria-hidden="true" tabindex="-1"></a>For each one-unit increase in $\log(t)$, the hazard ratio increases by a factor of about **3.5**.</span>
<span id="cb15-615"><a href="#cb15-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-616"><a href="#cb15-616" aria-hidden="true" tabindex="-1"></a>**Interpretation:**  </span>
<span id="cb15-617"><a href="#cb15-617" aria-hidden="true" tabindex="-1"></a>The early protective effect of living donation **diminishes as time goes on**, explaining why a single constant hazard ratio would be misleading.</span>
<span id="cb15-618"><a href="#cb15-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-619"><a href="#cb15-619" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-620"><a href="#cb15-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-621"><a href="#cb15-621" aria-hidden="true" tabindex="-1"></a>‚úÖ **Donor age**</span>
<span id="cb15-622"><a href="#cb15-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-623"><a href="#cb15-623" aria-hidden="true" tabindex="-1"></a>HR ‚âà 1.01 (95% CI: 1.00‚Äì1.03, P-value = 0.14), **Not statistically significant**.  </span>
<span id="cb15-624"><a href="#cb15-624" aria-hidden="true" tabindex="-1"></a>Donor age shows a small, non-significant trend toward higher hazard of graft failure.</span>
<span id="cb15-625"><a href="#cb15-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-626"><a href="#cb15-626" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-627"><a href="#cb15-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-628"><a href="#cb15-628" aria-hidden="true" tabindex="-1"></a>‚úÖ **Recipient gender (male vs female)**</span>
<span id="cb15-629"><a href="#cb15-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-630"><a href="#cb15-630" aria-hidden="true" tabindex="-1"></a>HR ‚âà 1.58 (95% CI: 1.16‚Äì2.13, P-value = 0.003), **Statistically significant**.  </span>
<span id="cb15-631"><a href="#cb15-631" aria-hidden="true" tabindex="-1"></a>Male recipients have about a **58% higher hazard** of graft failure compared to females, adjusting for donor age, donor type, and baseline eGFR.</span>
<span id="cb15-632"><a href="#cb15-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-633"><a href="#cb15-633" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-634"><a href="#cb15-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-635"><a href="#cb15-635" aria-hidden="true" tabindex="-1"></a>‚úÖ **Baseline eGFR**</span>
<span id="cb15-636"><a href="#cb15-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-637"><a href="#cb15-637" aria-hidden="true" tabindex="-1"></a>HR ‚âà 0.99 (95% CI: 0.97‚Äì1.00, P-value = 0.032), **Statistically significant**.  </span>
<span id="cb15-638"><a href="#cb15-638" aria-hidden="true" tabindex="-1"></a>Each 1-unit increase in baseline eGFR is associated with about a **1‚Äì2% lower hazard** of graft failure.</span>
<span id="cb15-639"><a href="#cb15-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-640"><a href="#cb15-640" aria-hidden="true" tabindex="-1"></a>To improve interpretability, we can express the effect per **10-unit increase** in eGFR:</span>
<span id="cb15-641"><a href="#cb15-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-642"><a href="#cb15-642" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-643"><a href="#cb15-643" aria-hidden="true" tabindex="-1"></a>HR_{10\text{-unit}} = 0.99^{10} \approx 0.90</span>
<span id="cb15-644"><a href="#cb15-644" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-645"><a href="#cb15-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-646"><a href="#cb15-646" aria-hidden="true" tabindex="-1"></a>**Interpretation:**  </span>
<span id="cb15-647"><a href="#cb15-647" aria-hidden="true" tabindex="-1"></a>Within donor type, a 10-unit higher baseline eGFR at transplant is associated with approximately a **10% lower hazard of graft failure**, after adjusting for other covariates.</span>
<span id="cb15-648"><a href="#cb15-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-649"><a href="#cb15-649" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-650"><a href="#cb15-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-651"><a href="#cb15-651" aria-hidden="true" tabindex="-1"></a>**Overall interpretation:**  </span>
<span id="cb15-652"><a href="#cb15-652" aria-hidden="true" tabindex="-1"></a>The time-varying Cox model shows that the **effect of donor type is strongest early after transplant and weakens over time**, while recipient gender and baseline kidney function remain important predictors of graft failure.</span>
<span id="cb15-653"><a href="#cb15-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-654"><a href="#cb15-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-655"><a href="#cb15-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-656"><a href="#cb15-656" aria-hidden="true" tabindex="-1"></a>Early follow-up: HR &lt; 1 ‚Üí protective effect of living donors</span>
<span id="cb15-657"><a href="#cb15-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-658"><a href="#cb15-658" aria-hidden="true" tabindex="-1"></a>Later follow-up: HR increases and may exceed 1</span>
<span id="cb15-659"><a href="#cb15-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-660"><a href="#cb15-660" aria-hidden="true" tabindex="-1"></a>Uncertainty increases at longer follow-up due to fewer events</span>
<span id="cb15-661"><a href="#cb15-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-662"><a href="#cb15-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-663"><a href="#cb15-663" aria-hidden="true" tabindex="-1"></a>The HR steadily increases and crosses 1 after roughly 1‚Äì2 years, indicating the early survival advantage of living donors diminishes.  </span>
<span id="cb15-664"><a href="#cb15-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-665"><a href="#cb15-665" aria-hidden="true" tabindex="-1"></a>By 5‚Äì8 years, the HR &gt; 2‚Äì3, suggesting higher hazard among living-donor grafts in the later period.  </span>
<span id="cb15-666"><a href="#cb15-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-667"><a href="#cb15-667" aria-hidden="true" tabindex="-1"></a>The confidence band widens with time because there are fewer events and greater uncertainty at longer follow-up. </span>
<span id="cb15-668"><a href="#cb15-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-669"><a href="#cb15-669" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-670"><a href="#cb15-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-671"><a href="#cb15-671" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extended Cox Model</span></span>
<span id="cb15-672"><a href="#cb15-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-673"><a href="#cb15-673" aria-hidden="true" tabindex="-1"></a>Before introducing the **extended Cox model**, it is important to distinguish between</span>
<span id="cb15-674"><a href="#cb15-674" aria-hidden="true" tabindex="-1"></a>**time-fixed covariates** and **time-varying covariates**.</span>
<span id="cb15-675"><a href="#cb15-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-676"><a href="#cb15-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-677"><a href="#cb15-677" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb15-678"><a href="#cb15-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-679"><a href="#cb15-679" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time-Fixed vs Time-Varying Covariates</span></span>
<span id="cb15-680"><a href="#cb15-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-681"><a href="#cb15-681" aria-hidden="true" tabindex="-1"></a>**Time-Fixed Covariates:** </span>
<span id="cb15-682"><a href="#cb15-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-683"><a href="#cb15-683" aria-hidden="true" tabindex="-1"></a>A **time-fixed covariate** is measured once (usually at baseline) and assumed to remain</span>
<span id="cb15-684"><a href="#cb15-684" aria-hidden="true" tabindex="-1"></a>constant throughout follow-up.</span>
<span id="cb15-685"><a href="#cb15-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-686"><a href="#cb15-686" aria-hidden="true" tabindex="-1"></a>Examples:</span>
<span id="cb15-687"><a href="#cb15-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-688"><a href="#cb15-688" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Donor type**</span>
<span id="cb15-689"><a href="#cb15-689" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Sex**</span>
<span id="cb15-690"><a href="#cb15-690" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Age at transplant**</span>
<span id="cb15-691"><a href="#cb15-691" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Baseline eGFR**</span>
<span id="cb15-692"><a href="#cb15-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-693"><a href="#cb15-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-694"><a href="#cb15-694" aria-hidden="true" tabindex="-1"></a>**Time-Varying Covariates:**</span>
<span id="cb15-695"><a href="#cb15-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-696"><a href="#cb15-696" aria-hidden="true" tabindex="-1"></a>A **time-varying covariate** is a variable whose **value itself changes over time**.</span>
<span id="cb15-697"><a href="#cb15-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-698"><a href="#cb15-698" aria-hidden="true" tabindex="-1"></a>Examples:</span>
<span id="cb15-699"><a href="#cb15-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-700"><a href="#cb15-700" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**eGFR measured repeatedly after transplant**</span>
<span id="cb15-701"><a href="#cb15-701" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Blood pressure**</span>
<span id="cb15-702"><a href="#cb15-702" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Medication use**</span>
<span id="cb15-703"><a href="#cb15-703" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Biomarkers measured at follow-up visits**</span>
<span id="cb15-704"><a href="#cb15-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-705"><a href="#cb15-705" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-706"><a href="#cb15-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-707"><a href="#cb15-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-708"><a href="#cb15-708" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb15-709"><a href="#cb15-709" aria-hidden="true" tabindex="-1"></a>Time-varying covariates are different from **time-varying effects**.</span>
<span id="cb15-710"><a href="#cb15-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-711"><a href="#cb15-711" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Time-varying effect:** the *coefficient* changes with time  </span>
<span id="cb15-712"><a href="#cb15-712" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Time-varying covariate:** the *value of the covariate* changes with time</span>
<span id="cb15-713"><a href="#cb15-713" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-714"><a href="#cb15-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-715"><a href="#cb15-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-716"><a href="#cb15-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-717"><a href="#cb15-717" aria-hidden="true" tabindex="-1"></a>**Why Time-Varying Covariates Can Cause PH Violation**  </span>
<span id="cb15-718"><a href="#cb15-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-719"><a href="#cb15-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-720"><a href="#cb15-720" aria-hidden="true" tabindex="-1"></a>If we treat a changing covariate as fixed at baseline:</span>
<span id="cb15-721"><a href="#cb15-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-722"><a href="#cb15-722" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We ignore important changes in a patient‚Äôs risk profile</span>
<span id="cb15-723"><a href="#cb15-723" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The model may show **non-proportional hazards**</span>
<span id="cb15-724"><a href="#cb15-724" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Early and late risks are incorrectly averaged</span>
<span id="cb15-725"><a href="#cb15-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-726"><a href="#cb15-726" aria-hidden="true" tabindex="-1"></a>For example:</span>
<span id="cb15-727"><a href="#cb15-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-728"><a href="#cb15-728" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>eGFR at transplant may be similar between patients</span>
<span id="cb15-729"><a href="#cb15-729" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Over time, eGFR may decline at different rates</span>
<span id="cb15-730"><a href="#cb15-730" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Current kidney function is more relevant than baseline eGFR</span>
<span id="cb15-731"><a href="#cb15-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-732"><a href="#cb15-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-733"><a href="#cb15-733" aria-hidden="true" tabindex="-1"></a>**Extended Cox Model (Time-Varying Covariates)**  </span>
<span id="cb15-734"><a href="#cb15-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-735"><a href="#cb15-735" aria-hidden="true" tabindex="-1"></a>The **extended Cox model** explicitly allows covariate values to change over time.</span>
<span id="cb15-736"><a href="#cb15-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-737"><a href="#cb15-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-738"><a href="#cb15-738" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb15-739"><a href="#cb15-739" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intuition</span></span>
<span id="cb15-740"><a href="#cb15-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-741"><a href="#cb15-741" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Split each subject‚Äôs follow-up into **time intervals**</span>
<span id="cb15-742"><a href="#cb15-742" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Update the covariate value within each interval</span>
<span id="cb15-743"><a href="#cb15-743" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Model the hazard using the **current covariate value**</span>
<span id="cb15-744"><a href="#cb15-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-745"><a href="#cb15-745" aria-hidden="true" tabindex="-1"></a>**Why this addresses PH violation:**  </span>
<span id="cb15-746"><a href="#cb15-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-747"><a href="#cb15-747" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>PH was violated partly because ‚Äúrisk profile changes over time.‚Äù  </span>
<span id="cb15-748"><a href="#cb15-748" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The extended Cox model explicitly updates the covariates over time instead of pretending they‚Äôre frozen at baseline.  </span>
<span id="cb15-749"><a href="#cb15-749" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This is different from stratification and different from adding x √ó time: here the value itself is time-dependent.  </span>
<span id="cb15-750"><a href="#cb15-750" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-751"><a href="#cb15-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-752"><a href="#cb15-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-753"><a href="#cb15-753" aria-hidden="true" tabindex="-1"></a>The model is written as:</span>
<span id="cb15-754"><a href="#cb15-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-755"><a href="#cb15-755" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-756"><a href="#cb15-756" aria-hidden="true" tabindex="-1"></a>h(t \mid X(t)) = h_0(t)\exp\left(\beta_1 X_1(t) + \beta_2 X_2 + \cdots\right)</span>
<span id="cb15-757"><a href="#cb15-757" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-758"><a href="#cb15-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-759"><a href="#cb15-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-760"><a href="#cb15-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-761"><a href="#cb15-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-762"><a href="#cb15-762" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb15-763"><a href="#cb15-763" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Use It</span></span>
<span id="cb15-764"><a href="#cb15-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-765"><a href="#cb15-765" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A predictor **changes over time**</span>
<span id="cb15-766"><a href="#cb15-766" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The **current value** of the predictor matters for risk *right now*</span>
<span id="cb15-767"><a href="#cb15-767" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Treating the variable as baseline-only is unrealistic</span>
<span id="cb15-768"><a href="#cb15-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-769"><a href="#cb15-769" aria-hidden="true" tabindex="-1"></a>Examples:</span>
<span id="cb15-770"><a href="#cb15-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-771"><a href="#cb15-771" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>‚ÄúeGFR at year 2 predicts risk between year 2 and 3‚Äù</span>
<span id="cb15-772"><a href="#cb15-772" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>‚ÄúIf eGFR worsens, the risk of graft failure increases after that‚Äù</span>
<span id="cb15-773"><a href="#cb15-773" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-774"><a href="#cb15-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-775"><a href="#cb15-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-776"><a href="#cb15-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-777"><a href="#cb15-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-778"><a href="#cb15-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-779"><a href="#cb15-779" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example: Extended Cox Model (Time-Varying Covariates)</span></span>
<span id="cb15-780"><a href="#cb15-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-781"><a href="#cb15-781" aria-hidden="true" tabindex="-1"></a>This example demonstrates how to fit an **extended Cox model** when a covariate</span>
<span id="cb15-782"><a href="#cb15-782" aria-hidden="true" tabindex="-1"></a>(e.g. **eGFR**) **changes over time**.</span>
<span id="cb15-783"><a href="#cb15-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-784"><a href="#cb15-784" aria-hidden="true" tabindex="-1"></a>We create a dataset in **start‚Äìstop format**, where each individual contributes</span>
<span id="cb15-785"><a href="#cb15-785" aria-hidden="true" tabindex="-1"></a>multiple time intervals.</span>
<span id="cb15-786"><a href="#cb15-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-787"><a href="#cb15-787" aria-hidden="true" tabindex="-1"></a>For each interval we record:</span>
<span id="cb15-788"><a href="#cb15-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-789"><a href="#cb15-789" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**start:** beginning of the time interval  </span>
<span id="cb15-790"><a href="#cb15-790" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**stop:** end of the time interval  </span>
<span id="cb15-791"><a href="#cb15-791" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**status:** did graft failure occur at <span class="in">`stop`</span>  </span>
<span id="cb15-792"><a href="#cb15-792" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**egfr_current:** eGFR measured at the **start of that interval**</span>
<span id="cb15-793"><a href="#cb15-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-794"><a href="#cb15-794" aria-hidden="true" tabindex="-1"></a>The extended Cox model uses the **current value** of the covariate:</span>
<span id="cb15-795"><a href="#cb15-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-796"><a href="#cb15-796" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-797"><a href="#cb15-797" aria-hidden="true" tabindex="-1"></a>h(t) = h_0(t)\exp\left(\beta_1 \,\text{egfr<span class="sc">\_</span>current}(t)</span>
<span id="cb15-798"><a href="#cb15-798" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>\beta_2 \,\text{donor<span class="sc">\_</span>type}</span>
<span id="cb15-799"><a href="#cb15-799" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>\cdots \right)</span>
<span id="cb15-800"><a href="#cb15-800" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-801"><a href="#cb15-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-802"><a href="#cb15-802" aria-hidden="true" tabindex="-1"></a>Here:</span>
<span id="cb15-803"><a href="#cb15-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-804"><a href="#cb15-804" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**egfr\_current(t)** is updated over time  </span>
<span id="cb15-805"><a href="#cb15-805" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The hazard reflects the patient‚Äôs **current kidney function**, not baseline values</span>
<span id="cb15-806"><a href="#cb15-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-807"><a href="#cb15-807" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb15-808"><a href="#cb15-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-809"><a href="#cb15-809" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Structure: Wide vs Long Format</span></span>
<span id="cb15-810"><a href="#cb15-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-811"><a href="#cb15-811" aria-hidden="true" tabindex="-1"></a>**Wide (Baseline-Only) Format**</span>
<span id="cb15-812"><a href="#cb15-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-813"><a href="#cb15-813" aria-hidden="true" tabindex="-1"></a>Each subject has **one row**, with multiple eGFR measurements stored in columns.</span>
<span id="cb15-814"><a href="#cb15-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-815"><a href="#cb15-815" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`egfr0`</span>, <span class="in">`egfr2`</span>, <span class="in">`egfr4`</span>, <span class="in">`egfr6`</span> represent measurements at fixed times  </span>
<span id="cb15-816"><a href="#cb15-816" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This format is **not suitable** for extended Cox models</span>
<span id="cb15-817"><a href="#cb15-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-818"><a href="#cb15-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-819"><a href="#cb15-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-820"><a href="#cb15-820" aria-hidden="true" tabindex="-1"></a>**Long (Start‚ÄìStop) Format**</span>
<span id="cb15-821"><a href="#cb15-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-822"><a href="#cb15-822" aria-hidden="true" tabindex="-1"></a>Each subject contributes **multiple rows**, one per interval.</span>
<span id="cb15-823"><a href="#cb15-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-824"><a href="#cb15-824" aria-hidden="true" tabindex="-1"></a>Key columns:</span>
<span id="cb15-825"><a href="#cb15-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-826"><a href="#cb15-826" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**id**</span>
<span id="cb15-827"><a href="#cb15-827" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**start**</span>
<span id="cb15-828"><a href="#cb15-828" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**stop**</span>
<span id="cb15-829"><a href="#cb15-829" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**status**</span>
<span id="cb15-830"><a href="#cb15-830" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**egfr_current**</span>
<span id="cb15-831"><a href="#cb15-831" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**baseline covariates** (donor type, age, sex)</span>
<span id="cb15-832"><a href="#cb15-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-833"><a href="#cb15-833" aria-hidden="true" tabindex="-1"></a>This format allows the model to use the **current eGFR** at each time interval.</span>
<span id="cb15-834"><a href="#cb15-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-835"><a href="#cb15-835" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-836"><a href="#cb15-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-837"><a href="#cb15-837" aria-hidden="true" tabindex="-1"></a>**Change of eGFR over time by donor type**  </span>
<span id="cb15-838"><a href="#cb15-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-839"><a href="#cb15-839" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb15-840"><a href="#cb15-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-841"><a href="#cb15-841" aria-hidden="true" tabindex="-1"></a><span class="in">#-----plot egfr change over time </span></span>
<span id="cb15-842"><a href="#cb15-842" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb15-843"><a href="#cb15-843" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb15-844"><a href="#cb15-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-845"><a href="#cb15-845" aria-hidden="true" tabindex="-1"></a><span class="in">long_data&lt;-read.csv("egfr_long_data.CSV")</span></span>
<span id="cb15-846"><a href="#cb15-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-847"><a href="#cb15-847" aria-hidden="true" tabindex="-1"></a><span class="in"># Compute mean ¬± SE by donor type and start time</span></span>
<span id="cb15-848"><a href="#cb15-848" aria-hidden="true" tabindex="-1"></a><span class="in">egfr_summary &lt;- long_data %&gt;%</span></span>
<span id="cb15-849"><a href="#cb15-849" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(donor_type, start) %&gt;%</span></span>
<span id="cb15-850"><a href="#cb15-850" aria-hidden="true" tabindex="-1"></a><span class="in">  summarise(</span></span>
<span id="cb15-851"><a href="#cb15-851" aria-hidden="true" tabindex="-1"></a><span class="in">    mean_egfr = mean(egfr_current, na.rm = TRUE),</span></span>
<span id="cb15-852"><a href="#cb15-852" aria-hidden="true" tabindex="-1"></a><span class="in">    se_egfr   = sd(egfr_current, na.rm = TRUE) / sqrt(n())</span></span>
<span id="cb15-853"><a href="#cb15-853" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb15-854"><a href="#cb15-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-855"><a href="#cb15-855" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(egfr_summary, aes(x = start, y = mean_egfr,</span></span>
<span id="cb15-856"><a href="#cb15-856" aria-hidden="true" tabindex="-1"></a><span class="in">                         colour = donor_type, group = donor_type)) +</span></span>
<span id="cb15-857"><a href="#cb15-857" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.2) +     # changed from size ‚Üí linewidth</span></span>
<span id="cb15-858"><a href="#cb15-858" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(size = 2) +</span></span>
<span id="cb15-859"><a href="#cb15-859" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = mean_egfr - se_egfr,</span></span>
<span id="cb15-860"><a href="#cb15-860" aria-hidden="true" tabindex="-1"></a><span class="in">                  ymax = mean_egfr + se_egfr,</span></span>
<span id="cb15-861"><a href="#cb15-861" aria-hidden="true" tabindex="-1"></a><span class="in">                  fill = donor_type),</span></span>
<span id="cb15-862"><a href="#cb15-862" aria-hidden="true" tabindex="-1"></a><span class="in">              alpha = 0.2, colour = NA) +</span></span>
<span id="cb15-863"><a href="#cb15-863" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_colour_manual(values = c("deceased" = "#377eb8",</span></span>
<span id="cb15-864"><a href="#cb15-864" aria-hidden="true" tabindex="-1"></a><span class="in">                                 "living"   = "#e41a1c")) +</span></span>
<span id="cb15-865"><a href="#cb15-865" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("deceased" = "#377eb8",</span></span>
<span id="cb15-866"><a href="#cb15-866" aria-hidden="true" tabindex="-1"></a><span class="in">                               "living"   = "#e41a1c")) +</span></span>
<span id="cb15-867"><a href="#cb15-867" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb15-868"><a href="#cb15-868" aria-hidden="true" tabindex="-1"></a><span class="in">    title  = "Average eGFR trajectory over time by donor type",</span></span>
<span id="cb15-869"><a href="#cb15-869" aria-hidden="true" tabindex="-1"></a><span class="in">    x      = "Years since transplant",</span></span>
<span id="cb15-870"><a href="#cb15-870" aria-hidden="true" tabindex="-1"></a><span class="in">    y      = "Mean eGFR (mL/min/1.73m¬≤)",</span></span>
<span id="cb15-871"><a href="#cb15-871" aria-hidden="true" tabindex="-1"></a><span class="in">    colour = "Donor type",</span></span>
<span id="cb15-872"><a href="#cb15-872" aria-hidden="true" tabindex="-1"></a><span class="in">    fill   = "Donor type"</span></span>
<span id="cb15-873"><a href="#cb15-873" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb15-874"><a href="#cb15-874" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal(base_size = 14) +</span></span>
<span id="cb15-875"><a href="#cb15-875" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb15-876"><a href="#cb15-876" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.grid.major = element_line(colour = "grey90"),</span></span>
<span id="cb15-877"><a href="#cb15-877" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.grid.minor = element_blank(),</span></span>
<span id="cb15-878"><a href="#cb15-878" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.title       = element_text(face = "bold", hjust = 0.5)</span></span>
<span id="cb15-879"><a href="#cb15-879" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb15-880"><a href="#cb15-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-881"><a href="#cb15-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-882"><a href="#cb15-882" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-883"><a href="#cb15-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-884"><a href="#cb15-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-885"><a href="#cb15-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-886"><a href="#cb15-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-887"><a href="#cb15-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-888"><a href="#cb15-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-889"><a href="#cb15-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-890"><a href="#cb15-890" aria-hidden="true" tabindex="-1"></a>**Fitting the Extended Cox Model**</span>
<span id="cb15-891"><a href="#cb15-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-892"><a href="#cb15-892" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb15-893"><a href="#cb15-893" aria-hidden="true" tabindex="-1"></a><span class="in">library(survival)</span></span>
<span id="cb15-894"><a href="#cb15-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-895"><a href="#cb15-895" aria-hidden="true" tabindex="-1"></a><span class="in">long_data&lt;-read.csv("egfr_long_data.CSV")</span></span>
<span id="cb15-896"><a href="#cb15-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-897"><a href="#cb15-897" aria-hidden="true" tabindex="-1"></a><span class="in">cox_extended &lt;- coxph(</span></span>
<span id="cb15-898"><a href="#cb15-898" aria-hidden="true" tabindex="-1"></a><span class="in">  Surv(start, stop, status) ~</span></span>
<span id="cb15-899"><a href="#cb15-899" aria-hidden="true" tabindex="-1"></a><span class="in">    egfr_current +</span></span>
<span id="cb15-900"><a href="#cb15-900" aria-hidden="true" tabindex="-1"></a><span class="in">    donor_type +</span></span>
<span id="cb15-901"><a href="#cb15-901" aria-hidden="true" tabindex="-1"></a><span class="in">    donor_age +</span></span>
<span id="cb15-902"><a href="#cb15-902" aria-hidden="true" tabindex="-1"></a><span class="in">    recipient_gender,</span></span>
<span id="cb15-903"><a href="#cb15-903" aria-hidden="true" tabindex="-1"></a><span class="in">  data = long_data</span></span>
<span id="cb15-904"><a href="#cb15-904" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-905"><a href="#cb15-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-906"><a href="#cb15-906" aria-hidden="true" tabindex="-1"></a><span class="in">summary(cox_extended)</span></span>
<span id="cb15-907"><a href="#cb15-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-908"><a href="#cb15-908" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-909"><a href="#cb15-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-910"><a href="#cb15-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-911"><a href="#cb15-911" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb15-912"><a href="#cb15-912" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation</span></span>
<span id="cb15-913"><a href="#cb15-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-914"><a href="#cb15-914" aria-hidden="true" tabindex="-1"></a>We interpret the results of the **extended Cox model (time-varying covariates)** as follows:</span>
<span id="cb15-915"><a href="#cb15-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-916"><a href="#cb15-916" aria-hidden="true" tabindex="-1"></a>‚úÖ **Current eGFR**</span>
<span id="cb15-917"><a href="#cb15-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-918"><a href="#cb15-918" aria-hidden="true" tabindex="-1"></a>HR ‚âà 0.92 (95% CI: 0.86‚Äì0.98, P-value = 0.01), **Statistically significant**.  </span>
<span id="cb15-919"><a href="#cb15-919" aria-hidden="true" tabindex="-1"></a>Each 1 mL/min/1.73 m¬≤ higher **current eGFR** is associated with about an **8% lower instantaneous hazard** of graft failure, holding donor type, donor age, and recipient gender constant.</span>
<span id="cb15-920"><a href="#cb15-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-921"><a href="#cb15-921" aria-hidden="true" tabindex="-1"></a>This means that **the patient‚Äôs current kidney function**, rather than baseline eGFR, is strongly predictive of graft failure risk.</span>
<span id="cb15-922"><a href="#cb15-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-923"><a href="#cb15-923" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-924"><a href="#cb15-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-925"><a href="#cb15-925" aria-hidden="true" tabindex="-1"></a>‚úÖ **Donor type (living vs deceased)**</span>
<span id="cb15-926"><a href="#cb15-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-927"><a href="#cb15-927" aria-hidden="true" tabindex="-1"></a>HR ‚âà 1.28 (95% CI: 0.24‚Äì6.83, P-value = 0.77), **Not statistically significant**.  </span>
<span id="cb15-928"><a href="#cb15-928" aria-hidden="true" tabindex="-1"></a>Once **time-updated eGFR** is included in the model, there is **no evidence of a direct effect** of donor type on graft failure.</span>
<span id="cb15-929"><a href="#cb15-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-930"><a href="#cb15-930" aria-hidden="true" tabindex="-1"></a>**Interpretation:**  </span>
<span id="cb15-931"><a href="#cb15-931" aria-hidden="true" tabindex="-1"></a>The apparent advantage of living donors observed earlier appears to operate **through better kidney function over time**, rather than through an independent direct effect.</span>
<span id="cb15-932"><a href="#cb15-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-933"><a href="#cb15-933" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-934"><a href="#cb15-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-935"><a href="#cb15-935" aria-hidden="true" tabindex="-1"></a>‚úÖ **Donor age**</span>
<span id="cb15-936"><a href="#cb15-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-937"><a href="#cb15-937" aria-hidden="true" tabindex="-1"></a>HR ‚âà 1.03 (95% CI: 0.97‚Äì1.09, P-value = 0.39), **Not statistically significant**.  </span>
<span id="cb15-938"><a href="#cb15-938" aria-hidden="true" tabindex="-1"></a>There is no strong evidence that donor age is associated with graft failure once current eGFR and other covariates are accounted for.</span>
<span id="cb15-939"><a href="#cb15-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-940"><a href="#cb15-940" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-941"><a href="#cb15-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-942"><a href="#cb15-942" aria-hidden="true" tabindex="-1"></a>‚úÖ **Recipient gender (male vs female)**</span>
<span id="cb15-943"><a href="#cb15-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-944"><a href="#cb15-944" aria-hidden="true" tabindex="-1"></a>HR ‚âà 1.36 (95% CI: 0.45‚Äì4.10, P-value = 0.58), **Not statistically significant**.  </span>
<span id="cb15-945"><a href="#cb15-945" aria-hidden="true" tabindex="-1"></a>After adjusting for time-updated eGFR and other covariates, there is no clear evidence of a gender difference in graft failure risk.</span>
<span id="cb15-946"><a href="#cb15-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-947"><a href="#cb15-947" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-948"><a href="#cb15-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-949"><a href="#cb15-949" aria-hidden="true" tabindex="-1"></a>**Overall interpretation:**  </span>
<span id="cb15-950"><a href="#cb15-950" aria-hidden="true" tabindex="-1"></a>The extended Cox model highlights that **time-updated eGFR is the dominant predictor of graft failure**.  </span>
<span id="cb15-951"><a href="#cb15-951" aria-hidden="true" tabindex="-1"></a>Accounting for changes in kidney function over time substantially alters the interpretation of other covariate effects and provides a more realistic representation of evolving risk.</span>
<span id="cb15-952"><a href="#cb15-952" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-953"><a href="#cb15-953" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb15-954"><a href="#cb15-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-955"><a href="#cb15-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-956"><a href="#cb15-956" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb15-957"><a href="#cb15-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-958"><a href="#cb15-958" aria-hidden="true" tabindex="-1"></a><span class="in">library(survival)</span></span>
<span id="cb15-959"><a href="#cb15-959" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb15-960"><a href="#cb15-960" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb15-961"><a href="#cb15-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-962"><a href="#cb15-962" aria-hidden="true" tabindex="-1"></a><span class="in"># Choose fixed values (you can edit if you prefer):</span></span>
<span id="cb15-963"><a href="#cb15-963" aria-hidden="true" tabindex="-1"></a><span class="in">ref_donor_type      &lt;- factor("deceased", levels = levels(as.factor(long_data$donor_type)))</span></span>
<span id="cb15-964"><a href="#cb15-964" aria-hidden="true" tabindex="-1"></a><span class="in">ref_donor_age       &lt;- 50</span></span>
<span id="cb15-965"><a href="#cb15-965" aria-hidden="true" tabindex="-1"></a><span class="in">ref_recipient_sex   &lt;- factor("female", levels = levels(as.factor(long_data$recipient_gender)))</span></span>
<span id="cb15-966"><a href="#cb15-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-967"><a href="#cb15-967" aria-hidden="true" tabindex="-1"></a><span class="in">new_e30 &lt;- data.frame(</span></span>
<span id="cb15-968"><a href="#cb15-968" aria-hidden="true" tabindex="-1"></a><span class="in">  start = 0,</span></span>
<span id="cb15-969"><a href="#cb15-969" aria-hidden="true" tabindex="-1"></a><span class="in">  stop = 1,  # dummy, survfit won't use start/stop here</span></span>
<span id="cb15-970"><a href="#cb15-970" aria-hidden="true" tabindex="-1"></a><span class="in">  status = 0,</span></span>
<span id="cb15-971"><a href="#cb15-971" aria-hidden="true" tabindex="-1"></a><span class="in">  egfr_current = 30,</span></span>
<span id="cb15-972"><a href="#cb15-972" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_type = ref_donor_type,</span></span>
<span id="cb15-973"><a href="#cb15-973" aria-hidden="true" tabindex="-1"></a><span class="in">  donor_age = ref_donor_age,</span></span>
<span id="cb15-974"><a href="#cb15-974" aria-hidden="true" tabindex="-1"></a><span class="in">  recipient_gender = ref_recipient_sex</span></span>
<span id="cb15-975"><a href="#cb15-975" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-976"><a href="#cb15-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-977"><a href="#cb15-977" aria-hidden="true" tabindex="-1"></a><span class="in">new_e60 &lt;- new_e30; new_e60$egfr_current &lt;- 60</span></span>
<span id="cb15-978"><a href="#cb15-978" aria-hidden="true" tabindex="-1"></a><span class="in">new_e90 &lt;- new_e30; new_e90$egfr_current &lt;- 90</span></span>
<span id="cb15-979"><a href="#cb15-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-980"><a href="#cb15-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-981"><a href="#cb15-981" aria-hidden="true" tabindex="-1"></a><span class="in">sf_e30 &lt;- survfit(cox_extended, newdata = new_e30)</span></span>
<span id="cb15-982"><a href="#cb15-982" aria-hidden="true" tabindex="-1"></a><span class="in">sf_e60 &lt;- survfit(cox_extended, newdata = new_e60)</span></span>
<span id="cb15-983"><a href="#cb15-983" aria-hidden="true" tabindex="-1"></a><span class="in">sf_e90 &lt;- survfit(cox_extended, newdata = new_e90)</span></span>
<span id="cb15-984"><a href="#cb15-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-985"><a href="#cb15-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-986"><a href="#cb15-986" aria-hidden="true" tabindex="-1"></a><span class="in">df_e30 &lt;- data.frame(</span></span>
<span id="cb15-987"><a href="#cb15-987" aria-hidden="true" tabindex="-1"></a><span class="in">  time  = sf_e30$time,</span></span>
<span id="cb15-988"><a href="#cb15-988" aria-hidden="true" tabindex="-1"></a><span class="in">  surv  = sf_e30$surv,</span></span>
<span id="cb15-989"><a href="#cb15-989" aria-hidden="true" tabindex="-1"></a><span class="in">  lower = sf_e30$lower,</span></span>
<span id="cb15-990"><a href="#cb15-990" aria-hidden="true" tabindex="-1"></a><span class="in">  upper = sf_e30$upper,</span></span>
<span id="cb15-991"><a href="#cb15-991" aria-hidden="true" tabindex="-1"></a><span class="in">  egfr_label = "eGFR = 30"</span></span>
<span id="cb15-992"><a href="#cb15-992" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-993"><a href="#cb15-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-994"><a href="#cb15-994" aria-hidden="true" tabindex="-1"></a><span class="in">df_e60 &lt;- data.frame(</span></span>
<span id="cb15-995"><a href="#cb15-995" aria-hidden="true" tabindex="-1"></a><span class="in">  time  = sf_e60$time,</span></span>
<span id="cb15-996"><a href="#cb15-996" aria-hidden="true" tabindex="-1"></a><span class="in">  surv  = sf_e60$surv,</span></span>
<span id="cb15-997"><a href="#cb15-997" aria-hidden="true" tabindex="-1"></a><span class="in">  lower = sf_e60$lower,</span></span>
<span id="cb15-998"><a href="#cb15-998" aria-hidden="true" tabindex="-1"></a><span class="in">  upper = sf_e60$upper,</span></span>
<span id="cb15-999"><a href="#cb15-999" aria-hidden="true" tabindex="-1"></a><span class="in">  egfr_label = "eGFR = 60"</span></span>
<span id="cb15-1000"><a href="#cb15-1000" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-1001"><a href="#cb15-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1002"><a href="#cb15-1002" aria-hidden="true" tabindex="-1"></a><span class="in">df_e90 &lt;- data.frame(</span></span>
<span id="cb15-1003"><a href="#cb15-1003" aria-hidden="true" tabindex="-1"></a><span class="in">  time  = sf_e90$time,</span></span>
<span id="cb15-1004"><a href="#cb15-1004" aria-hidden="true" tabindex="-1"></a><span class="in">  surv  = sf_e90$surv,</span></span>
<span id="cb15-1005"><a href="#cb15-1005" aria-hidden="true" tabindex="-1"></a><span class="in">  lower = sf_e90$lower,</span></span>
<span id="cb15-1006"><a href="#cb15-1006" aria-hidden="true" tabindex="-1"></a><span class="in">  upper = sf_e90$upper,</span></span>
<span id="cb15-1007"><a href="#cb15-1007" aria-hidden="true" tabindex="-1"></a><span class="in">  egfr_label = "eGFR = 90"</span></span>
<span id="cb15-1008"><a href="#cb15-1008" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-1009"><a href="#cb15-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1010"><a href="#cb15-1010" aria-hidden="true" tabindex="-1"></a><span class="in">surv_plot_df &lt;- bind_rows(df_e30, df_e60, df_e90)</span></span>
<span id="cb15-1011"><a href="#cb15-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1012"><a href="#cb15-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1013"><a href="#cb15-1013" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(surv_plot_df,</span></span>
<span id="cb15-1014"><a href="#cb15-1014" aria-hidden="true" tabindex="-1"></a><span class="in">       aes(x = time,</span></span>
<span id="cb15-1015"><a href="#cb15-1015" aria-hidden="true" tabindex="-1"></a><span class="in">           y = surv,</span></span>
<span id="cb15-1016"><a href="#cb15-1016" aria-hidden="true" tabindex="-1"></a><span class="in">           colour = egfr_label,</span></span>
<span id="cb15-1017"><a href="#cb15-1017" aria-hidden="true" tabindex="-1"></a><span class="in">           fill   = egfr_label)) +</span></span>
<span id="cb15-1018"><a href="#cb15-1018" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-1019"><a href="#cb15-1019" aria-hidden="true" tabindex="-1"></a><span class="in">  # confidence band</span></span>
<span id="cb15-1020"><a href="#cb15-1020" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower, ymax = upper),</span></span>
<span id="cb15-1021"><a href="#cb15-1021" aria-hidden="true" tabindex="-1"></a><span class="in">              alpha = 0.18,</span></span>
<span id="cb15-1022"><a href="#cb15-1022" aria-hidden="true" tabindex="-1"></a><span class="in">              linewidth = 0,</span></span>
<span id="cb15-1023"><a href="#cb15-1023" aria-hidden="true" tabindex="-1"></a><span class="in">              show.legend = FALSE) +</span></span>
<span id="cb15-1024"><a href="#cb15-1024" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-1025"><a href="#cb15-1025" aria-hidden="true" tabindex="-1"></a><span class="in">  # survival curve (step)</span></span>
<span id="cb15-1026"><a href="#cb15-1026" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_step(linewidth = 1.2) +</span></span>
<span id="cb15-1027"><a href="#cb15-1027" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-1028"><a href="#cb15-1028" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_colour_manual(</span></span>
<span id="cb15-1029"><a href="#cb15-1029" aria-hidden="true" tabindex="-1"></a><span class="in">    values = c(</span></span>
<span id="cb15-1030"><a href="#cb15-1030" aria-hidden="true" tabindex="-1"></a><span class="in">      "eGFR = 30" = "#d7301f",  # dark-ish red / high risk</span></span>
<span id="cb15-1031"><a href="#cb15-1031" aria-hidden="true" tabindex="-1"></a><span class="in">      "eGFR = 60" = "#fc8d59",  # orange</span></span>
<span id="cb15-1032"><a href="#cb15-1032" aria-hidden="true" tabindex="-1"></a><span class="in">      "eGFR = 90" = "#1a9850"   # green / low risk</span></span>
<span id="cb15-1033"><a href="#cb15-1033" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb15-1034"><a href="#cb15-1034" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb15-1035"><a href="#cb15-1035" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(</span></span>
<span id="cb15-1036"><a href="#cb15-1036" aria-hidden="true" tabindex="-1"></a><span class="in">    values = c(</span></span>
<span id="cb15-1037"><a href="#cb15-1037" aria-hidden="true" tabindex="-1"></a><span class="in">      "eGFR = 30" = "#d7301f",</span></span>
<span id="cb15-1038"><a href="#cb15-1038" aria-hidden="true" tabindex="-1"></a><span class="in">      "eGFR = 60" = "#fc8d59",</span></span>
<span id="cb15-1039"><a href="#cb15-1039" aria-hidden="true" tabindex="-1"></a><span class="in">      "eGFR = 90" = "#1a9850"</span></span>
<span id="cb15-1040"><a href="#cb15-1040" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb15-1041"><a href="#cb15-1041" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb15-1042"><a href="#cb15-1042" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-1043"><a href="#cb15-1043" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb15-1044"><a href="#cb15-1044" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Predicted graft survival under different kidney function levels",</span></span>
<span id="cb15-1045"><a href="#cb15-1045" aria-hidden="true" tabindex="-1"></a><span class="in">    subtitle = "Extended Cox model with time-updated eGFR",</span></span>
<span id="cb15-1046"><a href="#cb15-1046" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Time since transplant (years)",</span></span>
<span id="cb15-1047"><a href="#cb15-1047" aria-hidden="true" tabindex="-1"></a><span class="in">    y = "Survival probability",</span></span>
<span id="cb15-1048"><a href="#cb15-1048" aria-hidden="true" tabindex="-1"></a><span class="in">    colour = "Assumed current eGFR"</span></span>
<span id="cb15-1049"><a href="#cb15-1049" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb15-1050"><a href="#cb15-1050" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0.72, 1)) +</span></span>
<span id="cb15-1051"><a href="#cb15-1051" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_grey(base_size = 14) +</span></span>
<span id="cb15-1052"><a href="#cb15-1052" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb15-1053"><a href="#cb15-1053" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.title    = element_text(face = "bold", hjust = 0.5),</span></span>
<span id="cb15-1054"><a href="#cb15-1054" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.subtitle = element_text(hjust = 0.5),</span></span>
<span id="cb15-1055"><a href="#cb15-1055" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "right",</span></span>
<span id="cb15-1056"><a href="#cb15-1056" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.grid.minor = element_blank()</span></span>
<span id="cb15-1057"><a href="#cb15-1057" aria-hidden="true" tabindex="-1"></a><span class="in">  )+ theme(</span></span>
<span id="cb15-1058"><a href="#cb15-1058" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.title = element_text(</span></span>
<span id="cb15-1059"><a href="#cb15-1059" aria-hidden="true" tabindex="-1"></a><span class="in">      face = "bold",</span></span>
<span id="cb15-1060"><a href="#cb15-1060" aria-hidden="true" tabindex="-1"></a><span class="in">      size = 12,</span></span>
<span id="cb15-1061"><a href="#cb15-1061" aria-hidden="true" tabindex="-1"></a><span class="in">      hjust = 0.5,</span></span>
<span id="cb15-1062"><a href="#cb15-1062" aria-hidden="true" tabindex="-1"></a><span class="in">      margin = margin(b = 6)   # space below title</span></span>
<span id="cb15-1063"><a href="#cb15-1063" aria-hidden="true" tabindex="-1"></a><span class="in">    ),</span></span>
<span id="cb15-1064"><a href="#cb15-1064" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.subtitle = element_text(</span></span>
<span id="cb15-1065"><a href="#cb15-1065" aria-hidden="true" tabindex="-1"></a><span class="in">      size = 11,</span></span>
<span id="cb15-1066"><a href="#cb15-1066" aria-hidden="true" tabindex="-1"></a><span class="in">      hjust = 0.5,</span></span>
<span id="cb15-1067"><a href="#cb15-1067" aria-hidden="true" tabindex="-1"></a><span class="in">      margin = margin(b = 8)</span></span>
<span id="cb15-1068"><a href="#cb15-1068" aria-hidden="true" tabindex="-1"></a><span class="in">    ),</span></span>
<span id="cb15-1069"><a href="#cb15-1069" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "right",</span></span>
<span id="cb15-1070"><a href="#cb15-1070" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.grid.minor = element_blank()</span></span>
<span id="cb15-1071"><a href="#cb15-1071" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb15-1072"><a href="#cb15-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1073"><a href="#cb15-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1074"><a href="#cb15-1074" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-1075"><a href="#cb15-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1076"><a href="#cb15-1076" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb15-1077"><a href="#cb15-1077" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation of Predicted Survival by Current eGFR Level</span></span>
<span id="cb15-1078"><a href="#cb15-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1079"><a href="#cb15-1079" aria-hidden="true" tabindex="-1"></a>The extended Cox model allows us to interpret graft survival **conditional on the current level of kidney function**, updated over time.</span>
<span id="cb15-1080"><a href="#cb15-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1081"><a href="#cb15-1081" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-1082"><a href="#cb15-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1083"><a href="#cb15-1083" aria-hidden="true" tabindex="-1"></a>‚úÖ **eGFR = 90 (green)**</span>
<span id="cb15-1084"><a href="#cb15-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1085"><a href="#cb15-1085" aria-hidden="true" tabindex="-1"></a>Predicted graft survival is **very stable over time**.  </span>
<span id="cb15-1086"><a href="#cb15-1086" aria-hidden="true" tabindex="-1"></a>The survival curve remains close to **1.0**, indicating that patients maintaining this level of kidney function have a **very low risk of graft failure** throughout follow-up.</span>
<span id="cb15-1087"><a href="#cb15-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1088"><a href="#cb15-1088" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-1089"><a href="#cb15-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1090"><a href="#cb15-1090" aria-hidden="true" tabindex="-1"></a>‚úÖ **eGFR = 60 (orange)**</span>
<span id="cb15-1091"><a href="#cb15-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1092"><a href="#cb15-1092" aria-hidden="true" tabindex="-1"></a>Graft survival remains **high**, although slightly lower than at eGFR = 90.  </span>
<span id="cb15-1093"><a href="#cb15-1093" aria-hidden="true" tabindex="-1"></a>The probability of graft survival stays above **95% over 8 years**, suggesting a **modest increase in risk**, but overall good long-term outcomes.</span>
<span id="cb15-1094"><a href="#cb15-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1095"><a href="#cb15-1095" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-1096"><a href="#cb15-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1097"><a href="#cb15-1097" aria-hidden="true" tabindex="-1"></a>‚úÖ **eGFR = 30 (red)**</span>
<span id="cb15-1098"><a href="#cb15-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1099"><a href="#cb15-1099" aria-hidden="true" tabindex="-1"></a>Graft survival is **markedly reduced**.  </span>
<span id="cb15-1100"><a href="#cb15-1100" aria-hidden="true" tabindex="-1"></a>The survival curve declines more steeply, showing a **pronounced increase in the risk of graft loss over time**.  </span>
<span id="cb15-1101"><a href="#cb15-1101" aria-hidden="true" tabindex="-1"></a>This highlights low current eGFR as a **strong indicator of poor prognosis**.</span>
<span id="cb15-1102"><a href="#cb15-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1103"><a href="#cb15-1103" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-1104"><a href="#cb15-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1105"><a href="#cb15-1105" aria-hidden="true" tabindex="-1"></a>**Overall interpretation:**  </span>
<span id="cb15-1106"><a href="#cb15-1106" aria-hidden="true" tabindex="-1"></a>In the extended Cox model, **current eGFR is a powerful, time-updated predictor of graft survival**.  </span>
<span id="cb15-1107"><a href="#cb15-1107" aria-hidden="true" tabindex="-1"></a>Lower eGFR values are associated with **substantially worse survival trajectories**, reinforcing the importance of modelling kidney function as a **time-varying covariate** rather than a baseline-only measure.</span>
<span id="cb15-1108"><a href="#cb15-1108" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-1109"><a href="#cb15-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1110"><a href="#cb15-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1111"><a href="#cb15-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1112"><a href="#cb15-1112" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb15-1113"><a href="#cb15-1113" aria-hidden="true" tabindex="-1"></a>The extended Cox model treats time-varying covariates as **external**.</span>
<span id="cb15-1114"><a href="#cb15-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1115"><a href="#cb15-1115" aria-hidden="true" tabindex="-1"></a>If the covariate is influenced by the underlying disease process</span>
<span id="cb15-1116"><a href="#cb15-1116" aria-hidden="true" tabindex="-1"></a>(e.g. declining eGFR because the graft is failing),</span>
<span id="cb15-1117"><a href="#cb15-1117" aria-hidden="true" tabindex="-1"></a>this assumption may be violated.</span>
<span id="cb15-1118"><a href="#cb15-1118" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-1119"><a href="#cb15-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1120"><a href="#cb15-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1121"><a href="#cb15-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1122"><a href="#cb15-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1123"><a href="#cb15-1123" aria-hidden="true" tabindex="-1"></a>::: {.callout-question}</span>
<span id="cb15-1124"><a href="#cb15-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1125"><a href="#cb15-1125" aria-hidden="true" tabindex="-1"></a>**üß† Think about the following before moving on:**</span>
<span id="cb15-1126"><a href="#cb15-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1127"><a href="#cb15-1127" aria-hidden="true" tabindex="-1"></a>What if the decline in eGFR over time reflects underlying changes in other clinical factors, rather than acting as an isolated predictor?</span>
<span id="cb15-1128"><a href="#cb15-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1129"><a href="#cb15-1129" aria-hidden="true" tabindex="-1"></a>And those same variables may also affect the risk of graft failure.</span>
<span id="cb15-1130"><a href="#cb15-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1131"><a href="#cb15-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1132"><a href="#cb15-1132" aria-hidden="true" tabindex="-1"></a>If a time-dependent covariate both **predicts** the event and is **affected by** the underlying disease process, is an extended Cox model still appropriate?</span>
<span id="cb15-1133"><a href="#cb15-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-1134"><a href="#cb15-1134" aria-hidden="true" tabindex="-1"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>